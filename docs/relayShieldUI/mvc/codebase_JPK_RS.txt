.
./errors/database_error.php
<!DOCTYPE html>
<html>
    <body>
        <main>
            <h1>Database Error</h1>
            <p>There was an error connecting to the database.</p>
            <p>The database must be installed using files in the database directory.</p>
            <p>Error message: <?php echo $error_message; ?></p>
            <p> <?php debug_print_backtrace(); ?></p>
        </main>
    </body>
</html>
./errors/error.php
<!DOCTYPE html>
<html>
    <body>
        <main>
            <h1>Error</h1>
            <p><?php echo $error; ?></p>
            <p> <?php debug_print_backtrace(); ?></p>
        </main>
    </body>
</html>
./model/rsgroups.php
<?php

// include('rshousekeepinglog.php');
// include('rsdeletedstuff.php');

function add_group($db, $groupname, $groupdescription, $activestatus) {

    $query = 'INSERT INTO RSGroups (groupname, groupdescription, activestatus)';
    $query .= ' VALUES (:groupname, :groupdescription, :activestatus);';
    $statement = $db->prepare($query);
    $statement->bindValue(':groupname', $groupname);
    $statement->bindValue(':groupdescription', $groupdescription);
    $statement->bindValue(':activestatus', $activestatus);
    $remarks = 'Adding group: '. $groupname . ($statement->execute() ? ' successful.' : ' failed.');
    $statement->closeCursor();
    add_log($db, $remarks);
}

function update_group ($db, $groupname, $groupdescription, $activestatus, $old) {
        $remarks = 'Updating group: ' . $old['groupname'];
        $query = 'UPDATE RSGroups SET ';
        if($old['groupname'] != $groupname && get_group_id($db, $groupname) == NULL) {
                $query .= 'groupname = :groupname';
                $remarks .= ' name';
        }
        if($old['groupdescription'] != $groupdescription) {
                if(strpos($query, 'groupname')) {
                        $query .= ', ';
                        $remarks .= ', ';
                }
                $query .= 'groupdescription = :groupdescription';
                $remarks .= "description";
        }
        if($old['activestatus'] != $activestatus) {
                if(strpos($query, 'description') || strpos($query, 'groupname')) {
                        $query .= ', ';
                        $remarks .= ', ';
                }
                $query .= 'activestatus = :activestatus';
                $remarks .= 'status';
        }
	
	if(strlen($query) > 21) {
		$query .= ' WHERE id = ' . $old['id'];
		echo('update_query: ' . $query);
	        $statement = $db->prepare($query);

        	if(strpos($query, 'groupname')) $statement->bindValue(':groupname', $groupname);
		if(strpos($query, 'groupdescription')) $statement->bindValue(':groupdescription', $groupdescription);
		if(strpos($query, 'activestatus')) $statement->bindValue(':activestatus', $activestatus);
        	$remarks .= $statement->execute() ? ' successful.' : ' not successful.';
        	$statement->closeCursor();
        } else {
		$remarks .= 'not attempted.';// do nothing.
	}

        add_log($db, $remarks);
}

function get_group_id($db, $groupname) {
    $query = 'SELECT id FROM RSGroups WHERE groupname = :groupname';
    $statement = $db->prepare($query);
    $statement->bindValue(':groupname',$groupname);
    $statement->execute();
    $group_id = $statement->fetch()['id'];
    $statement->closeCursor();
    return $group_id;
}

function get_group_by_name($db, $groupname) {
    $query = 'SELECT * FROM RSGroups WHERE groupname = :groupname';
    $statement = $db->prepare($query);
    $statement->bindValue(':groupname',$groupname);
    $statement->execute();
    $group = $statement->fetch();
    $statement->closeCursor();
    return $group;
}

function get_group_by_id($db, $groupid) {
    $query = 'SELECT * FROM RSGroups WHERE id = :groupid';
    $statement = $db->prepare($query);
    $statement->bindValue(':groupid',$groupid);
    $statement->execute();
    $group = $statement->fetch();
    $statement->closeCursor();
    return $group;
}

function get_all_groups($db) {
    $query = 'SELECT * FROM RSGroups';
    $statement = $db->prepare($query);
    $statement->execute();
    $groups = $statement->fetchAll();
    $statement->closeCursor();
    return $groups;
}

function get_groups_list($db) {
        $query = 'SELECT G2.groupname AS _group, G2.groupdescription AS description, IFNULL(U.GUMUsers, 0) AS users';
        $query .= ', IFNULL(F.FGMFacilities, 0) AS facilities, G2.activestatus AS status';
        $query .= ' FROM RSGroups G2';
        $query .= ' LEFT JOIN (SELECT G1.id AS GUMiD, COUNT(groupid) AS GUMUsers FROM RSGroupUserMemberships GUM, RSGroups G1 WHERE GUM.groupid = G1.id GROUP BY GUM.groupid) U ON G2.id = U.GUMiD';
	$query .= ' LEFT JOIN (SELECT G0.id AS FGMiD, COUNT(groupid) AS FGMFacilities FROM RSFacilityGroupMemberships FGM, RSGroups G0 WHERE FGM.groupid = G0.id GROUP BY FGM.groupid) F ON G2.id = F.FGMiD';
        $query .= ' ORDER BY G2.id';
    $statement = $db->prepare($query);
    $statement->execute();
    $groups_list = $statement->fetchAll();
    $statement->closeCursor();
    return $groups_list;
}

function get_active_groups_list($db) {
        $query = 'SELECT DISTINCT G2.groupname AS _group, G2.groupdescription AS description, IFNULL(U.GUMUsers, 0) AS users';
        $query .= ', IFNULL(F.FGMFacilities, 0) AS facilities, G2.activestatus AS status';
        $query .= ' FROM RSGroups G2';
        $query .= ' LEFT JOIN (SELECT G1.id AS GUMiD, COUNT(groupid) AS GUMUsers FROM RSGroupUserMemberships GUM, RSGroups G1 WHERE GUM.groupid = G1.id GROUP BY GUM.groupid) U ON G2.id = U.GUMiD';
	$query .= ' LEFT JOIN (SELECT G0.id AS FGMiD, COUNT(groupid) AS FGMFacilities FROM RSFacilityGroupMemberships FGM, RSGroups G0 WHERE FGM.groupid = G0.id GROUP BY FGM.groupid) F ON G2.id = F.FGMiD';
	$query .= ' WHERE G2.activestatus = true';
        $query .= ' ORDER BY G2.id';
    $statement = $db->prepare($query);
    $statement->execute();
    $active_groups_list = $statement->fetchAll();
    $statement->closeCursor();
    return $active_groups_list;
}

function get_all_available_groups($db) {
        $query = 'SELECT * FROM RSGroups WHERE id NOT IN
                        (SELECT groupid FROM RSGroupUserMemberships)';
    $statement = $db->prepare($query);
    $statement->execute();
    $all_available_groups = $statement->fetchAll();
    $statement->closeCursor();
    return $all_available_groups;
}

function get_active_groups($db) {
        $query = 'SELECT * FROM RSGroups WHERE activestatus = true';
    $statement = $db->prepare($query);
    $statement->execute();
    $active_groups = $statement->fetchAll();
    $statement->closeCursor();
    return $active_groups;
}

function activate_group($db, $groupname) {
        $query = 'UPDATE RSGroups SET activestatus = true WHERE groupname = :groupname';
    $statement = $db->prepare($query);
    $statement->bindValue(':groupname',$groupname);
    $remarks = $groupname . ($statement->execute()? ' activated.' : ' not activated.');
    $statement->closeCursor();
    add_log($db, $remarks);
}

function deactivate_group($db, $groupname) {
        $query = 'UPDATE RSGroups SET activestatus = false WHERE groupname = :groupname';
    $statement = $db->prepare($query);
    $statement->bindValue(':groupname',$groupname);
    $remarks = $groupname . ($statement->execute()? ' de-activated.' : ' not de-activated.');
    $statement->closeCursor();
    add_log($db, $remarks);
}

function delete_group($db, $groupname) {
    $to_be_deleted = json_encode(get_group_by_name($db, $groupname));
    $query = 'DELETE FROM RSGroups WHERE groupname = :groupname';
    $statement = $db->prepare($query);
    $statement->bindValue(':groupname',$groupname);
    $remarks = $groupname . ($statement->execute()? ' deleted.' : ' not deleted.');
    $statement->closeCursor();
    add_log($db, $remarks);
    if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSGroups', $to_be_deleted);
}

?>
		
./model/rsinitialize.php
<?php

function initial_db($db) {
    try {
	$query = 'DELETE FROM RSDeviceFacilityMatches;';
	$query .= 'DELETE FROM RSFacilityGroupMemberships;';
	$query .= 'DELETE FROM RSFacilities;';
	$query .= 'DELETE FROM RSDevices;';
	$query .= 'DELETE FROM RSGroupUserMemberships;';
	$query .= 'DELETE FROM RSGroups;';
	$query .= 'DELETE FROM RSUsers;';
	$query .= 'DELETE FROM RSUserTypes;';
	$query .= 'DELETE FROM RSHouseKeepingLog;';
        $query .= 'DELETE FROM RSDeletedStuff;';
        $query .= 'DELETE FROM RSActivityLog;';
	$query .= "INSERT INTO RSHouseKeepingLog VALUES (1, now(), 'Initialization of database!');";
        $query .= "INSERT INTO RSUserTypes VALUES (1, 'regular', '1-facility user'), (2, 'uber', 'multi-facility user'), (3, 'admin', 'user-group-facility assigner'), (4, 'super', 'group-facility creator');";
        $statement = $db->prepare($query);
        $statement->execute();
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../errors/database_error.php');
        exit();
    }
    return $statement;
}
?>
./model/rsgroupusermemberships.php
<?php

// include('rshousekeepinglog.php');
// include('rsdeletedstuff.php');

function add_group_user($db, $groupid, $userid) {

    $query = 'INSERT INTO RSGroupUserMemberships (groupid, userid) VALUES (:groupid, :userid)';
    $statement = $db->prepare($query);
    $statement->bindValue(':groupid', $groupid);
    $statement->bindValue(':userid', $userid);
    $remarks = 'Adding groupid-userid pair' . ($statement->execute() ? ' successful.' : ' failed.');
    $statement->closeCursor();
    add_log($db, $remarks);
}

/*
function add_group_users($db, $groupid, $userids) {
        foreach($userids as $userid) {
                $query = 'INSERT INTO RSGroupUserMemberships VALUES (:groupid, :userid)';
                $statement = $db->prepare($query);
                $statement->bindValue(':groupid',$groupid);
                $statement->bindValue(':userids',$userids);
                $statement->bindValue(':userid',$userid);
                $remarks = 'Adding groupid-userid pair' . ($statement->execute() ? ' successful.' : ' failed.');
                $statement->closeCursor();
//              add_log($db, $remarks);
        }
}
*/

function get_groups_by_user($db, $userid) {
        $query = 'SELECT * FROM RSGroupUserMemberships WHERE userid = :userid';
        $statement = $db->prepare($query);
        $statement->bindValue(':userid', $userid);
        $statement->execute();
        $results = $statement->fetchAll();
        $statement->closeCursor();
        $user_groups = [];
        foreach($results as $result) {
                $user_groups[] = $result['groupid'];
        }
        return $user_groups;
}


function get_users_by_group($db, $groupid) {
        $query = 'SELECT * FROM RSGroupUserMemberships WHERE groupid = :groupid';
        $statement = $db->prepare($query);
        $statement->bindValue(':groupid', $groupid);
        $statement->execute();
        $results = $statement->fetchAll();
        $statement->closeCursor();
        $group_users = [];
        foreach($results as $result) {
                $group_users[] = $result['userid'];
        }
        return $group_users;
}

function get_all_group_users($db) {
        $query = 'SELECT * FROM RSGroupUserMemberships';
        $statement = $db->prepare($query);
        $statement->execute();
        $group_users = $statement->fetchAll();
        $statement->closeCursor();
        return $group_users;
}

/*
function delete_group_user($db, $groupid, $userid) {
    $to_be_deleted = json_encode(get_group_user($db, $groupid, $userid));
    $query = 'DELETE FROM RSGroupUserMemberships WHERE groupid = :groupid AND userid = :userid';
    $statement = $db->prepare($query);
    $statement->bindValue(':groupid',$groupid);
    $statement->bindValue(':userid',$userid);
    $remarks = 'groupid-userid pair' . ($statement->execute() ? ' deleted.' : 'not deleted.');
    $statement->closeCursor();
    add_log($db, $remarks);
    if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSGroupUserMemberships', $to_be_deleted);
}
*/

function delete_group_users($db, $groupid) {
                $to_be_deleted = json_encode(array($groupid => get_users_by_group($db, $groupid)), JSON_FORCE_OBJECT);
                echo('to be deleted: ' . $to_be_deleted);
                $query = 'DELETE FROM RSGroupUserMemberships WHERE groupid = :groupid';
                $statement = $db->prepare($query);
                $statement->bindValue(':groupid', $groupid);
                $remarks = 'groupid-userid pairs' . ($statement->execute() ? ' deleted.' : ' not deleted.');
                $statement->closeCursor();
                add_log($db, $remarks);
                if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSGroupUserMemberships', $to_be_deleted);
}

function delete_user_groups($db, $userid) {
                $to_be_deleted = json_encode(array($userid => get_groups_by_user($db, $userid)), JSON_FORCE_OBJECT);
                $query = 'DELETE FROM RSGroupUserMemberships WHERE userid = :userid';
                $statement = $db->prepare($query);
                $statement->bindValue(':userid',$userid);
                $remarks = 'groupid-userid pairs' . ($statement->execute() ? ' deleted.' : ' not deleted.');
                $statement->closeCursor();
                add_log($db, $remarks);
                if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSGroupUserMemberships', $to_be_deleted);
}


function delete_all_group_users($db) {
    $to_be_deleted = json_encode(get_all_group_users($db));
    $query = 'DELETE FROM RSGroupUserMemberships';
    $statement = $db->prepare($query);
    $remarks = 'All groupid-userid pairs' . ($statement->execute() ? ' deleted.' : ' not deleted.');
    $statement->closeCursor();
    add_log($db, $remarks);
    if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSGroupUserMemberships', $to_be_deleted);
}

?>

./model/rsusers.php
<?php

function add_user($db,  $firstname, $lastname, $email, $username, $encryptedpassword, $usertypeid = 1, $activestatus = false) {

    $query = 'INSERT INTO RSUsers (firstname, lastname, email, ';
    $query .= 'username, encryptedpassword, usertypeid, activestatus) ';
    $query .= 'VALUES (:firstname, :lastname, :email, ';
    $query .= ':username, :encryptedpassword, :usertypeid, :activestatus)';
    $statement = $db->prepare($query);
    $statement->bindValue(':firstname', $firstname);
    $statement->bindValue(':lastname', $lastname);
    $statement->bindValue(':email', $email);
    $statement->bindValue(':username', $username);
    $statement->bindValue(':encryptedpassword', $encryptedpassword);
    $statement->bindValue(':usertypeid', $usertypeid);
    $statement->bindValue(':activestatus', $activestatus);
    $remarks = 'Adding user: ' . $username .  ($statement->execute() ? ' successful.' : ' failed.');
    $statement->closeCursor();
    add_log($db, $remarks);
    return strpos($remarks, 'success');

}

function update_user($db, $firstname, $lastname, $email, $password, $old) {

        $query = 'UPDATE RSUsers SET ';
        $remarks = 'Updating user: ' . $old['firstname'];

        if($old['firstname'] != $firstname && get_user_id($db, $firstname) == NULL) {
                $query .= 'firstname = :firstname';
                $remarks .= ' first name';
        }
        if($old['lastname'] != $lastname) {
                if(strpos($query, 'first')) {
                        $query .= ', ';
                        $remarks .= ', ';
                }
				$query .= 'lastname = :lastname';
                $remarks .= ' last name';
        }
        if($old['email'] != $email) {
                if(strpos($query, 'last') || strpos($query, 'first')) {
                        $query .= ', ';
                        $remarks .= ', ';
                }
                $query .= 'email = :email';
                $remarks .= "email";
        }
        if(!password_verify($password, $old['encryptedpassword'])) {
                if(strpos($query, 'email') || strpos($query, 'last') || strpos($query, 'first')) {
                        $query .= ', ';
                        $remarks .= ', ';
                }
                $query .= 'encryptedpassword = \'' . password_hash($password, PASSWORD_BCRYPT) . '\'';
                $remarks .= "password";
        }
        
    if(strlen($query) > 21) {
        $query .= ' WHERE id = ' . $old['id'];
        $statement = $db->prepare($query);

        if(strpos($query, 'first')) $statement->bindValue(':firstname', $firstname);
        if(strpos($query, 'last')) $statement->bindValue(':lastname', $lastname);
        if(strpos($query, 'email')) $statement->bindValue(':email', $email);
//        if(strpos($query, 'password')) $statement->bindValue(':password', $password);
        $remarks .= $statement->execute() ? ' successful.' : ' unsuccessful.';
        $statement->closeCursor();
    } else {
        $remarks .= 'not attempted.';// do nothing.
    }

      add_log($db, $remarks);
}

function update_user_props($db, $activestatus, $usertypeid, $old) {

        $query = 'UPDATE RSUsers SET ';
        $remarks = 'Updating user: ' . $old['firstname'];

        if($old['activestatus'] != $activestatus) {
                $query .= 'activestatus = :activestatus';
                $remarks .= ' status';
        }
        if($old['usertypeid'] != $usertypeid) {
                if(strpos($query, 'status')) {
                        $query .= ', ';
                        $remarks .= ', ';
                }
		$query .= 'usertypeid = :usertypeid';
                $remarks .= ' user type';
        }
        
    if(strlen($query) > 21) {
        $query .= ' WHERE id = ' . $old['id'];
        $statement = $db->prepare($query);
        if(strpos($query, 'status')) $statement->bindValue(':activestatus', $activestatus);
        if(strpos($query, 'typeid')) $statement->bindValue(':usertypeid', $usertypeid);
        $remarks .= $statement->execute() ? ' successful.' : ' unsuccessful.';
        $statement->closeCursor();
    } else {
              $remarks .= 'not attempted.';// do nothing.
    }

      add_log($db, $remarks);
}

function user_login($db, $username, $password) {
    $query = 'SELECT encryptedpassword FROM RSUsers WHERE username = :username';
    $statement = $db->prepare($query);
    $statement->bindValue(':username', $username);
    $statement->execute();
    $encrypted_passwd = $statement->fetch()['encryptedpassword'];
    $statement->closeCursor();
    return password_verify($password, $encrypted_passwd); // passwd_encryption($password)
}

function get_user_id($db, $username) {
    $query = 'SELECT id FROM RSUsers WHERE username = :username';
    $statement = $db->prepare($query);
    $statement->bindValue(':username', $username);
    $statement->execute();
    $user_id = $statement->fetch()['id'];
    $statement->closeCursor();
    return $user_id;
}

function get_user_by_name($db, $username) {
    $query = 'SELECT * FROM RSUsers WHERE username = :username';
    $statement = $db->prepare($query);
    $statement->bindValue(':username', $username);
    $statement->execute();
    $user = $statement->fetch();
    $statement->closeCursor();
    return $user;
}

function get_user_by_id($db, $userid) {
    $query = 'SELECT * FROM RSUsers WHERE id = :userid';
    $statement = $db->prepare($query);
    $statement->bindValue(':userid', $userid);
    $statement->execute();
    $user = $statement->fetch();
    $statement->closeCursor();
    return $user;
}

function get_users_list($db) {
        $query = 'SELECT U.username AS _user, UT.typename AS type, IFNULL(UG.GUMgroups, 0) AS groups';
        $query .= ', U.firstname AS fname, U.lastname AS lname, U.usertypeid AS utypeid, U.email AS email, U.activestatus AS status';
        $query .= ' FROM RSUserTypes UT, RSUsers U';
        $query .= ' LEFT JOIN (SELECT GUM.userid AS GUMuID, COUNT(GUM.groupid) AS GUMGroups FROM RSGroupUserMemberships GUM GROUP BY userid) UG ON U.id = UG.GUMuID';
	$query .= ' WHERE U.usertypeid = UT.id';
        $query .= ' ORDER BY U.id';
    $statement = $db->prepare($query);
    $statement->execute();
    $users_list = $statement->fetchAll();
    $statement->closeCursor();
    return $users_list;
}

function get_active_users_list($db) {
        $query = 'SELECT U.username AS _user, UT.typename AS type, IFNULL(UG.GUMgroups, 0) AS groups';
        $query .= ', U.firstname AS fname, U.email AS email, U.activestatus AS status';
        $query .= ' FROM RSUserTypes UT, RSUsers U';
        $query .= ' LEFT JOIN (SELECT GUM.userid AS GUMuID, COUNT(GUM.groupid) AS GUMGroups FROM RSGroupUserMemberships GUM GROUP BY userid) UG ON U.id = UG.GUMuID';
	$query .= ' WHERE U.usertypeid = UT.id AND U.activestatus = true';
        $query .= ' ORDER BY U.id';
    $statement = $db->prepare($query);
    $statement->execute();
    $users_list = $statement->fetchAll();
    $statement->closeCursor();
    return $users_list;
}

function get_all_users($db) {
    $query = 'SELECT * FROM RSUsers';
    $statement = $db->prepare($query);
    $statement->execute();
    $users = $statement->fetchAll();
    $statement->closeCursor();
    return $users;
}

function get_active_users($db) {
    $query = 'SELECT * FROM RSUsers WHERE activestatus = true';
    $statement = $db->prepare($query);
    $statement->execute();
    $active_users = $statement->fetchAll();
    $statement->closeCursor();
    return $active_users;
}

function get_user_facilities($db, $userid) {
	$query = 'SELECT F.facilityname AS facility, ';
    $query .= 'F.numberofrelays AS relays, F.activestatus AS fstatus, ';
    $query .= 'D.deviceid AS device, D.encryptedaccesstoken AS token, ';
    $query .= 'D.activestatus AS dstatus, FG.groupid AS fgroupid, ';
    $query .= 'U.firstname AS firstname, U.usertypeid AS utypeid, ';
    $query .= 'U.activestatus AS ustatus, UG.groupid AS ugroupid, ';
    $query .= 'G.activestatus AS gstatus ';
    $query .= 'FROM RSGroupUserMemberships UG, RSFacilities F, ';
    $query .= 'RSFacilityGroupMemberships FG, RSDevices D, ';
    $query .= 'RSDeviceFacilityMatches DFM, RSUsers U, RSGroups G ';
    $query .= 'WHERE F.id = FG.facilityid AND U.id = UG.userid ';
    $query .= 'AND  FG.groupid = UG.groupid AND G.id = UG.groupid ';
    $query .= 'AND D.id = DFM.deviceid AND G.id = FG.groupid AND ';
    $query .= 'F.id = DFM.facilityid AND U.id = :userid';
    $statement = $db->prepare($query);
    $statement->bindValue(':userid', $userid);
    $statement->execute();
    $user_facilities = $statement->fetchAll();
    $statement->closeCursor();
    return $user_facilities;
}

function delete_user($db, $username) {
    $to_be_deleted = json_encode(get_user_by_name($db, $username));
    $query = 'DELETE FROM RSUsers WHERE username = :username';
    $statement = $db->prepare($query);
    $statement->bindValue(':username',$username);
    $remarks = 'user: ' . $username . ($statement->execute()? ' deleted.' : ' not deleted.');
    $statement->closeCursor();
    add_log($db, $remarks);
    if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSUsers', $to_be_deleted);
}
?>

./model/rshousekeepinglog.php
<?php // the try/catch for these actions is in the caller, index.php 

session_start();

function add_log($db, $remarks) {
    $query = 'INSERT INTO RSHouseKeepingLog (remarks, userid)';
    $query .= ' VALUES (:remarks, ' . (isset($_SESSION['user']['id']) ? $_SESSION['user']['id'] : 99999) . ')';
    $statement = $db->prepare($query);
    $statement->bindValue(':remarks', $remarks);
    $statement->execute();
    $statement->closeCursor();
}

function update_log($db, $log_id, $remarks) {
    $query = 'UPDATE RSHouseKeepingLog SET remarks = :remarks';
    $query .= ', userid = ' . $_SESSION['user']['id'] . ' WHERE id = :log_id';
    $statement = $db->prepare($query);
    $statement->bindValue(':remarks', $remarks);
    $statement->bindValue(':log_id', $log_id);
    $statement->execute();
    $statement->closeCursor();
}

?>
./model/rsdatabase.php
<?php

    $dsn = 'mysql:host=localhost;dbname=RelayShieldDB';
    $username = 'root';		// TODO: should pick up logged in username
    $password = 'Root@123';


try {
    // specify that DB errors cause exceptions, so we can see
    // more about them
    $options = array(PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION);
    $db = new PDO($dsn, $username, $password, $options);
} catch (PDOException $e) {
    $error_message = $e->getMessage();
    include('../errors/database_error.php');
    exit();
}

?>
./model/rsdevices.php
<?php

// include('rshousekeepinglog.php');
// include('rsdeletedstuff.php');

function add_device($db, $deviceid, $access_token, $devicedescription, $activestatus = false) {
	
    $query = 'INSERT INTO RSDevices (deviceid, encryptedaccesstoken, devicedescription, activestatus) VALUES (:deviceid, :encryptedaccesstoken, :devicedescription, :activestatus);';
    $statement = $db->prepare($query);
    $statement->bindValue(':deviceid',$deviceid);
    $statement->bindValue(':encryptedaccesstoken',$access_token);
    $statement->bindValue(':devicedescription',$devicedescription);
    $statement->bindValue(':activestatus',$activestatus);
    $remarks = 'Device: ' . ($deviceid . $statement->execute() ? ' added.' : ' not added.');
    $statement->closeCursor();
    add_log($db, $remarks);
}

function update_device($db, $deviceid, $access_token, $devicedescription, $activestatus, $old) {
	
	$query = 'UPDATE RSDevices SET ';
	$remarks = 'Updating device: ' . $old['deviceid'];

	if($old['deviceid'] != $deviceid && get_device_id($db, $deviceid) == NULL) {
		$query .= 'deviceid = :deviceid';
		$remarks .= ' name';
	}
	if($old['encryptedaccesstoken'] != $access_token) {
		if(strpos($query, 'deviceid')) {
			$query .= ', ';
			$remarks .= ', ';
		}
		$query .= 'encryptedaccesstoken = :access_token';
		$remarks .= "access token";
	}
	if($old['devicedescription'] != $devicedescription) {
		if(strpos($query, 'token') || strpos($query, 'deviceid')) {
			$query .= ', ';
			$remarks .= ', ';
		}
		$query .= 'devicedescription = :devicedescription';
		$remarks .= "description";
	}
	if($old['activestatus'] != $activestatus) {
		if(strpos($query, 'description') || strpos($query, 'token') || strpos($query, 'deviceid')) {
			$query .= ', ';
			$remarks .= ', ';
		}
		$query .= 'activestatus = :activestatus';
		$remarks .= 'status';
	}

    if(strlen($query) > 21) {
	$query .= ' WHERE id = ' . $old['id'];
	$statement = $db->prepare($query);
	if(strpos($query, 'deviceid')) $statement->bindValue(':deviceid',$deviceid);
	if(strpos($query, 'access_token')) $statement->bindValue(':access_token',$access_token);
	if(strpos($query, 'devicedescription')) $statement->bindValue(':devicedescription',$devicedescription);
	if(strpos($query, 'activestatus')) $statement->bindValue(':activestatus',$activestatus);
	$remarks .= $statement->execute() ? ' successful.' : ' unsuccessful.';
	$statement->closeCursor();
    }
	$remarks .= 'not attempted.';
	
	add_log($db, $remarks);
}

function get_device_id($db, $deviceid) {
	$query = 'SELECT id FROM RSDevices WHERE deviceid = :deviceid';
    $statement = $db->prepare($query);
    $statement->bindValue(':deviceid',$deviceid);
    $statement->execute();
    $device_id = $statement->fetch()['id'];
    $statement->closeCursor();
    return $device_id;
}

function get_device_by_id($db, $device_id) {
	$query = 'SELECT * FROM RSDevices WHERE id = :device_id';
    $statement = $db->prepare($query);
    $statement->bindValue(':device_id', $device_id);
    $statement->execute();
    $device = $statement->fetch();
    $statement->closeCursor();
    return $device;
}

function get_device_by_name($db, $device_name) {
	$query = 'SELECT * FROM RSDevices WHERE deviceid = :device_name';
    $statement = $db->prepare($query);
    $statement->bindValue(':device_name', $device_name);
    $statement->execute();
    $device = $statement->fetch();
    $statement->closeCursor();
    return $device;
}

function get_all_devices($db) {
	$query = 'SELECT * FROM RSDevices';
    $statement = $db->prepare($query);
    $statement->execute();
    $all_devices = $statement->fetchAll();
    $statement->closeCursor();
    return $all_devices;
}

function get_devices_list($db) {
    $query = 'SELECT D.deviceid AS device, D.encryptedaccesstoken AS token';
    $query .= ', IFNULL(DF.facilityname, "[none]") AS facility, D.activestatus AS status';
    $query .= ', D.devicedescription AS description';
    $query .= ' FROM RSDevices D';
    $query .= ' LEFT JOIN (SELECT DFM.deviceid AS deviceid, DFM.facilityid AS facilityid, F.facilityname AS facilityname FROM RSDeviceFacilityMatches DFM, RSFacilities F WHERE DFM.facilityid = F.id) DF ON D.id = DF.deviceid';
    $query .= ' ORDER BY D.id';
    $statement = $db->prepare($query);
    $statement->execute();
    $devices_list = $statement->fetchAll();
    $statement->closeCursor();
    return $devices_list;
}

function get_active_devices_list($db) {
    $query = 'SELECT D.deviceid AS device, D.encryptedaccesstoken AS token';
    $query .= ', IFNULL(DF.facilityname, "[none]") AS facility, D.activestatus AS status';
    $query .= ', D.devicedescription AS description';
    $query .= ' FROM RSDevices D';
    $query .= ' LEFT JOIN (SELECT DFM.deviceid AS deviceid, DFM.facilityid AS facilityid, F.facilityname AS facilityname FROM RSDeviceFacilityMatches DFM, RSFacilities F WHERE DFM.facilityid = F.id) DF ON D.id = DF.deviceid';
    $query .= ' WHERE D.activestatus = true';
    $query .= ' ORDER BY D.id';
    $statement = $db->prepare($query);
    $statement->execute();
    $active_devices_list = $statement->fetchAll();
    $statement->closeCursor();
    return $active_devices_list;
}

function get_inactive_devices_list($db) {
    $query = 'SELECT D.deviceid AS device, D.encryptedaccesstoken AS token';
    $query .= ', IFNULL(DF.facilityname, "[none]") AS facility, D.activestatus AS status';
    $query .= ', D.devicedescription AS description';
    $query .= ' FROM RSDevices D';
    $query .= ' LEFT JOIN (SELECT DFM.deviceid AS deviceid, DFM.facilityid AS facilityid, F.facilityname AS facilityname FROM RSDeviceFacilityMatches DFM, RSFacilities F WHERE DFM.facilityid = F.id) DF ON D.id = DF.deviceid';
    $query .= ' WHERE D.activestatus = false';
    $query .= ' ORDER BY D.id';
    $statement = $db->prepare($query);
    $statement->execute();
    $inactive_devices_list = $statement->fetchAll();
    $statement->closeCursor();
    return $inactive_devices_list;
}

function get_all_available_devices($db) {
	$query = 'SELECT * FROM RSDevices WHERE id NOT IN
			(SELECT deviceid FROM RSDeviceFacilityMatches)';
    $statement = $db->prepare($query);
    $statement->execute();
    $all_available_devices = $statement->fetchAll();
    $statement->closeCursor();
    return $all_available_devices;
}

function get_active_devices($db) {
	$query = 'SELECT * FROM RSDevices WHERE activestatus = true';
    $statement = $db->prepare($query);
    $statement->execute();
    $active_devices = $statement->fetchAll();
    $statement->closeCursor();
    return $active_devices;
}

function activate_device($db, $deviceid) {
	$query = 'UPDATE RSDevices SET activestatus = true WHERE deviceid = :deviceid';
    $statement = $db->prepare($query);
    $statement->bindValue(':deviceid',$deviceid);
    $remarks = 'Device: ' . ($deviceid . $statement->execute() ? ' activated.' : ' not activated.');
    $statement->closeCursor();
	add_log($db, $remarks);
}

function deactivate_device($db, $deviceid) {
	$query = 'UPDATE RSDevices SET activestatus = false WHERE deviceid = :deviceid';
    $statement = $db->prepare($query);
    $statement->bindValue(':deviceid',$deviceid);
    $remarks = 'Device: ' . ($deviceid . $statement->execute() ? ' de-activated.' : ' not de-activated.');
    $statement->closeCursor();
	add_log($db, $remarks);
}

function delete_device($db, $deviceid) {
    $to_be_deleted = json_encode(get_device_by_id($db, $deviceid));
    $query = 'DELETE FROM RSDevices WHERE deviceid = :deviceid';
    $statement = $db->prepare($query);
    $statement->bindValue(':deviceid',$deviceid);
    $remarks = 'Device ' . $deviceid . ($statement->execute() ? ' deleted.' : ' not deleted.');
    $statement->closeCursor();
    add_log($db, $remarks);
    if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSDevices', $to_be_deleted);
}

?>
./model/rsfacilitygroupmemberships.php
<?php

// include('rshousekeepinglog.php');
// include('rsdeletedstuff.php');

function add_facility_group($db, $facilityid, $groupid ) {

    $query = 'INSERT INTO RSFacilityGroupMemberships (facilityid, groupid) VALUES (:facilityid, :groupid)';
    $statement = $db->prepare($query);
    $statement->bindValue(':facilityid', $facilityid);
    $statement->bindValue(':groupid', $groupid);
    $remarks = 'Adding facilityid-groupid pair' . ($statement->execute() ? ' successful.' : ' failed.');
    $statement->closeCursor();
    add_log($db, $remarks);
}

function add_facility_groups($db, $facilityid, $groupids) {
        foreach($groupids as $groupid) {
                $query = 'INSERT INTO RSFacilityGroupMemberships (facilityid, groupid) VALUES (:facilityid, :groupid)';
                $statement = $db->prepare($query);
                $statement->bindValue(':facilityid',$facilityid);
                $statement->bindValue(':groupid',$groupid);
                $remarks = 'Adding facilityid-groupid pair' . ($statement->execute() ? ' successful.' : ' failed.');
                $statement->closeCursor();
                add_log($db, $remarks);
        }
}

function add_group_facilities($db, $groupid, $facilityids) {
        foreach($facilityids as $facilityid) {
                $query = 'INSERT INTO RSFacilityGroupMemberships VALUES ($facilityid, :groupid)';
                $statement = $db->prepare($query);
                $statement->bindValue(':facilityids',$facilityids);
                $statement->bindValue(':facilityid',$facilityid);
                $statement->bindValue(':groupid',$groupid);
                $remarks = 'Adding facilityid-groupid pair' . ($statement->execute() ? ' successful.' : ' failed.');
                $statement->closeCursor();
                add_log($db, $remarks);
        }
}

function get_facilities_by_group($db, $groupid) {
        $query = 'SELECT * FROM RSFacilityGroupMemberships WHERE groupid = :groupid';
        $statement = $db->prepare($query);
        $statement->bindValue(':groupid',$groupid);
        $statement->execute();
        $results = $statement->fetchAll();
        $statement->closeCursor();
        $group_facilities = [];
        foreach($results as $result) {
                $group_facilities[] = $result['facilityid'];
        }
        return $group_facilities;
}

function get_groups_by_facility($db, $facilityid) {
        $query = 'SELECT * FROM RSFacilityGroupMemberships WHERE facilityid = :facilityid';
        $statement = $db->prepare($query);
        $statement->bindValue(':facilityid',$facilityid);
        $statement->execute();
        $results = $statement->fetchAll();
        $statement->closeCursor();
        $facility_groups = [];
        foreach($results as $result) {
                $facility_groups[] = $result['groupid'];
        }
        return $facility_groups;
}

function get_all_facility_groups($db) {
        $query = 'SELECT * FROM RSFacilityGroupMemberships';
        $statement = $db->prepare($query);
        $statement->execute();
        $facility_groups = $statement->fetchAll();
        $statement->closeCursor();
        return $facility_groups;
}

function delete_facility_group($db, $facilityid, $groupid) {
    $to_be_deleted = json_encode(get_facility_group($db, $facilityid, $groupid));
    $query = 'DELETE FROM RSFacilityGroupMemberships WHERE facilityid = :facilityid AND groupid = :groupid';
    $statement = $db->prepare($query);
    $statement->bindValue(':facilityid',$facilityid);
    $statement->bindValue(':groupid',$groupid);
    $remarks = 'facilityid-groupid pair' . ($statement->execute() ? ' deleted.' : ' not deleted.');
    $statement->closeCursor();
    add_log($db, $remarks);
    if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSFacilityGroupMemberships', $to_be_deleted);
}

function delete_facility_groups($db, $facilityid) {
        $to_be_deleted = json_encode(array($facilityid => get_groups_by_facility($db, $facilityid)), JSON_FORCE_OBJECT);
        $query = 'DELETE FROM RSFacilityGroupMemberships WHERE facilityid = :facilityid';
        $statement = $db->prepare($query);
        $statement->bindValue(':facilityid', $facilityid);
        $remarks = 'facilityid-groupid pairs' . ($statement->execute() ? ' deleted.' : ' not deleted.');
        $statement->closeCursor();
        add_log($db, $remarks);
        if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSFacilityGroupMemberships', $to_be_deleted);
}

function delete_group_facilities($db, $groupid) {
        $to_be_deleted = json_encode(array($groupid => get_facilities_by_group($db, $groupid)), JSON_FORCE_OBJECT);
        $query = 'DELETE FROM RSFacilityGroupMemberships WHERE groupid = :groupid';
        $statement = $db->prepare($query);
        $statement->bindValue(':groupid',$groupid);
        $remarks = 'facility-groupid pairs' . ($statement->execute() ? ' deleted.' : ' not deleted.');
        $statement->closeCursor();
        add_log($db, $remarks);
        if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSFacilityGroupMemberships', $to_be_deleted);
}

function delete_all_facility_groups($db) {
    $to_be_deleted = json_encode(get_all_facility_groups($db));
    $query = 'DELETE FROM RSFacilityGroupMemberships';
    $statement = $db->prepare($query);
    $remarks = 'All facilityid-groupid pairs' . ($statement->execute() ? ' deleted.' : ' not deleted.');
    $statement->closeCursor();
    add_log($db, $remarks);
    if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSFacilityGroupMemberships', $to_be_deleted);
}

?>

./model/rsfacilities.php
<?php

// include 'rshousekeepinglog.php';
// include 'rsdeletedstuff.php';

function add_facility($db, $facilityname, $numberofrelays, $activestatus) {
    $query = 'INSERT INTO RSFacilities (facilityname, numberofrelays, activestatus) VALUES (:facilityname, :numberofrelays, :activestatus);';
    $statement = $db->prepare($query);
    $statement->bindValue(':facilityname',$facilityname);
    $statement->bindValue(':numberofrelays',$numberofrelays);
    $statement->bindValue(':activestatus',$activestatus);
    $remarks = 'Adding facility: '. $facilityname . ($statement->execute() ? ' successful.' : ' failed.');
    $statement->closeCursor();
    add_log($db, $remarks);
}

function update_facility ($db, $facilityname, $numberofrelays, $activestatus, $old) {
	$query = 'UPDATE RSFacilities SET ';
	$remarks = 'Updating facility: ' . $old['facilityname'];

	if($old['facilityname'] != $facilityname && get_facility_id($db, $facilityname) == NULL) {
		$query .= 'facilityname = :facilityname';
		$remarks .= ' name';
	}
	if($old['numberofrelays'] != $numberofrelays) {
		if(strpos($query, 'name') !== false) {
			$query .= ', ';
			$remarks .= ', ';
		}
		$query .= 'numberofrelays = :numberofrelays';
		$remarks .= 'relays';
	}
	if($old['activestatus'] != $activestatus) {
		if(strpos($query, 'relays') !== false || strpos($query, 'name') !== false) {
			$query .= ', ';
			$remarks .= ', ';
		}
		$query .= 'activestatus = :activestatus';
		$remarks .= 'status';
	}
	if(strlen($query) > 23) {
            $query .= ' WHERE id = '. $old['id'];
	    $statement = $db->prepare($query);
	    if(strpos($query, 'facilityname')) $statement->bindValue(':facilityname',$facilityname);
	    if(strpos($query, 'numberofrelays')) $statement->bindValue(':numberofrelays',$numberofrelays);
	    if(strpos($query, 'activestatus')) $statement->bindValue(':activestatus',$activestatus);
	    $remarks .= $statement->execute() ? ' successful.' : ' not successful.';
	    $statement->closeCursor();
	} else {
	    $remarks .= 'not attempted.';// do nothing.
	}
	add_log($db, $remarks);
}

function get_facility_id($db, $facilityname) {
	$query = 'SELECT id FROM RSFacilities WHERE facilityname = :facilityname';
	$statement = $db->prepare($query);
	$statement->bindValue(':facilityname',$facilityname);
	$statement->execute();
	$facility_id = $statement->fetch()['id'];
	$statement->closeCursor();
	return $facility_id;
}

function get_facility_by_name($db, $facilityname) {
	$query = 'SELECT * FROM RSFacilities WHERE facilityname = :facilityname';
    $statement = $db->prepare($query);
    $statement->bindValue(':facilityname',$facilityname);
    $statement->execute();
    $facility = $statement->fetch();
    $statement->closeCursor();
    return $facility;
}

function get_facility_by_id($db, $facilityid) {
	$query = 'SELECT * FROM RSFacilities WHERE id = :facilityid';
    $statement = $db->prepare($query);
    $statement->bindValue(':facilityid',$facilityid);
    $statement->execute();
    $facility = $statement->fetch();
    $statement->closeCursor();
    return $facility;
}

function get_all_facilities($db) {
	$query = 'SELECT * FROM RSFacilities';
    $statement = $db->prepare($query);
    $statement->execute();
    $facilities = $statement->fetchAll();
    $statement->closeCursor();
    return $facilities;
}

function get_facilities_list($db) {
        $query = 'SELECT F1.facilityname AS facility, F1.numberofrelays AS relays';
	$query .= ', IFNULL(G.FGMGroups, 0) AS groups, IFNULL(DFM1.deviceid, "[none]") AS device, F1.activestatus AS status';
        $query .= ' FROM RSFacilities F1';
	$query .= ' LEFT JOIN (SELECT DFM2.facilityid, D.deviceid FROM RSDeviceFacilityMatches DFM2, RSDevices D WHERE D.id = DFM2.deviceid) DFM1 ON DFM1.facilityid = F1.id';
	$query .= ' LEFT JOIN (SELECT F0.id AS FGMiD, COUNT(facilityid)AS FGMGroups FROM RSFacilityGroupMemberships FGM, RSFacilities F0 WHERE FGM.facilityid = F0.id GROUP BY FGM.facilityid) G ON F1.id = G.FGMiD';
	$query .= ' ORDER BY F1.id';
    $statement = $db->prepare($query);
    $statement->execute();
    $facilities_list = $statement->fetchAll();
    $statement->closeCursor();
    return $facilities_list;
}

function get_active_facilities_list($db) {
        $query = 'SELECT DISTINCT F1.facilityname AS facility, F1.numberofrelays AS relays';
	$query .= ', IFNULL(G.FGMGroups, 0) AS groups, IFNULL(DFM1.deviceid, "[none]") AS device, F1.activestatus AS status';
        $query .= ' FROM RSFacilities F1';
	$query .= ' LEFT JOIN (SELECT DFM2.facilityid, D.deviceid FROM RSDeviceFacilityMatches DFM2, RSDevices D WHERE D.id = DFM2.deviceid) DFM1 ON DFM1.facilityid = F1.id';
	$query .= ' LEFT JOIN (SELECT F0.id AS FGMiD, COUNT(facilityid)AS FGMGroups FROM RSFacilityGroupMemberships FGM, RSFacilities F0 WHERE FGM.facilityid = F0.id GROUP BY FGM.facilityid) G ON F1.id = G.FGMiD';
	$query .= ' WHERE F1.activestatus = true';
	$query .= ' ORDER BY F1.id';
    $statement = $db->prepare($query);
    $statement->execute();
    $active_facilities_list = $statement->fetchAll();
    $statement->closeCursor();
    return $active_facilities_list;
}

function get_all_available_facilities($db) {
        $query = 'SELECT * FROM RSFacilities WHERE id NOT IN
                        (SELECT facilityid FROM RSDeviceFacilityMatches)';
    $statement = $db->prepare($query);
    $statement->execute();
    $all_available_facilities = $statement->fetchAll();
    $statement->closeCursor();
    return $all_available_facilities;
}

function get_active_facilities($db) {
	$query = 'SELECT * FROM RSFacilities WHERE activestatus = true';
    $statement = $db->prepare($query);
    $statement->execute();
    $active_facilities = $statement->fetchAll();
    $statement->closeCursor();
    return $active_facilities;
}

function activate_facility($db, $facilityname) {
	$query = 'UPDATE RSFacilities SET activestatus = true WHERE facilityname = :facilityname';
    $statement = $db->prepare($query);
    $statement->bindValue(':facilityname',$facilityname);
    $remarks = $facilityname . ($statement->execute()? ' activated.' : ' not activated.');
    $statement->closeCursor();
    add_log($db, $remarks);
}

function deactivate_facility($db, $facilityname) {
	$query = 'UPDATE RSFacilities SET activestatus = false WHERE facilityname = :facilityname';
    $statement = $db->prepare($query);
    $statement->bindValue(':facilityname',$facilityname);
    $remarks = $facilityname . ($statement->execute()? ' de-activated.' : ' not de-activated.');
    $statement->closeCursor();
    add_log($db, $remarks);
}

function delete_facility($db, $facilityname) {
    $to_be_deleted = json_encode(get_facility_by_name($db, $facilityname));
    echo('to_be_deleted: ' . $to_be_deleted);
    $query = 'DELETE FROM RSFacilities WHERE facilityname = :facilityname';
    $statement = $db->prepare($query);
    $statement->bindValue(':facilityname',$facilityname);
    $remarks = $facilityname . ($statement->execute() ? ' deleted.' : ' not deleted.');
    $statement->closeCursor();
    add_log($db, $remarks);
    if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSFacilities', $to_be_deleted);
}

?>
./model/rsdeletedstuff.php
<?php // the try/catch for these actions is in the caller, index.php

// include('rshousekeepinglog.php');

function add_deleted_stuff($db, $from_table, $deleted_record) {
    $query = 'INSERT INTO RSDeletedStuff (fromtable, recordsummary) VALUES (:from_table, :deleted_record)';
    $statement = $db->prepare($query);
    $statement->bindValue(':from_table', $from_table);
    $statement->bindValue(':deleted_record', $deleted_record);
    $remarks = $from_table . ' deletion archive ' . ($statement->execute() ? ' successful.' : ' failed.');
    $statement->closeCursor();
    add_log($db, $remarks);
}

// getters & setters: TODO.

?>

./model/rsdevicefacilitymatches.php
<?php

// include('rshousekeepinglog.php');
// include('rsdeletedstuff.php');

function add_device_facility($db, $deviceid, $facilityid) {	// NB: this is not the deviceid string but the int PK!
	
    $query = 'INSERT INTO RSDeviceFacilityMatches (deviceid, facilityid) VALUES (:deviceid, :facilityid)';
    $statement = $db->prepare($query);
    $statement->bindValue(':deviceid',$deviceid);
    $statement->bindValue(':facilityid',$facilityid);
    $remarks = 'Adding deviceid-facilityid pair' . ($statement->execute() ? ' successful.' : ' failed.');
    $statement->closeCursor();
    add_log($db, $remarks);
}

function update_device_facility($db, $new_deviceid, $facilityid) {	// NB: this is not the new_deviceid string but the int PK!
	
	$query = 'UPDATE RSDeviceFacilityMatches ';
	$query .= 'SET deviceid = :new_deviceid ';
	$query .= 'WHERE facilityid = :facilityid';
	$statement = $db->prepare($query);
	$statement->bindValue(':new_deviceid',$new_deviceid);
	$statement->bindValue(':facilityid',$facilityid);
	$remarks = 'Updating deviceid-facilityid pair' . ($statement->execute() ? ' successful.' : ' failed.');
	$statement->closeCursor();
	add_log($db, $remarks);
}

function update_facility_device($db, $deviceid, $new_facilityid) {	// NB: this is not the new_deviceid string but the int PK!
	
	$query = 'UPDATE RSDeviceFacilityMatches ';
	$query .= 'SET facilityid = :new_facilityid ';
	$query .= 'WHERE deviceid = :deviceid';
	$statement = $db->prepare($query);
	$statement->bindValue(':deviceid',$deviceid);
	$statement->bindValue(':new_facilityid',$new_facilityid);
	$remarks = 'Updating deviceid-facilityid pair' . ($statement->execute() ? ' successful.' : ' failed.');
	$statement->closeCursor();
	add_log($db, $remarks);
}

function get_device_by_facility($db, $facilityid) {
	$query = 'SELECT * FROM RSDeviceFacilityMatches WHERE facilityid = :facilityid';
	$statement = $db->prepare($query);
	$statement->bindValue(':facilityid',$facilityid);
	$statement->execute();
	$device_id = $statement->fetch()['deviceid'];
	$statement->closeCursor();
	return $device_id;
}

function get_facility_by_device($db, $deviceid) { // NB: this is not the deviceid string but the int PK!
	$query = 'SELECT * FROM RSDeviceFacilityMatches WHERE deviceid = :deviceid';
	$statement = $db->prepare($query);
	$statement->bindValue(':deviceid',$deviceid);
	$statement->execute();
	$facility_id = $statement->fetch()['facilityid'];
	$statement->closeCursor();
	return $facility_id;
}

function get_dev_fac_by_facility($db, $facilityid) {
	$query = 'SELECT * FROM RSDeviceFacilityMatches WHERE facilityid = :facilityid';
	$statement = $db->prepare($query);
	$statement->bindValue(':facilityid',$facilityid);
	$statement->execute();
	$dev_fac = $statement->fetch();
	$statement->closeCursor();
	return $dev_fac;
}

function get_dev_fac_by_device($db, $deviceid) { // NB: this is not the deviceid string but the int PK!
	$query = 'SELECT * FROM RSDeviceFacilityMatches WHERE deviceid = :deviceid';
	$statement = $db->prepare($query);
	$statement->bindValue(':deviceid',$deviceid);
	$statement->execute();
	$dev_fac = $statement->fetch();
	$statement->closeCursor();
	return $dev_fac;
}

function get_all_device_facilities($db) {
	$query = 'SELECT * FROM RSDeviceFacilityMatches';
	$statement = $db->prepare($query);
	$statement->execute();
	$device_facilities = $statement->fetchAll();
	$statement->closeCursor();
	return $device_facilities;
}

function delete_device_facility($db, $deviceid, $facilityid) { // NB: this is not the deviceid string but the int PK!
    $to_be_deleted = json_encode(get_device_facility($db, $deviceid, $facilityid));
    $query = 'DELETE FROM RSDeviceFacilityMatches WHERE deviceid = :deviceid AND facilityid = :facilityid';
    $statement = $db->prepare($query);
    $statement->bindValue(':deviceid', $deviceid);
    $statement->bindValue(':facilityid', $facilityid);
    $remarks = 'deviceid-facilityid pair' . ($statement->execute() ? ' deleted.' : ' not deleted.');
    $statement->closeCursor();
    add_log($db, $remarks);
    if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSDeviceFacilityMatches', $to_be_deleted);
}

function delete_dev_fac_by_facility($db, $facilityid) {
	$to_be_deleted = json_encode(get_dev_fac_by_facility($db, $facilityid));
	$query = 'DELETE FROM RSDeviceFacilityMatches WHERE facilityid = :facilityid';
	$statement = $db->prepare($query);
	$statement->bindValue(':facilityid', $facilityid);
	$remarks = 'deviceid-facilityid pair' . ($statement->execute() ? ' deleted.' : ' not deleted.');
	$statement->closeCursor();
	add_log($db, $remarks);
	if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSDeviceFacilityMatches', $to_be_deleted);
}

function delete_dev_fac_by_device($db, $deviceid) { // NB: this is not the deviceid string but the int PK!
	$to_be_deleted = json_encode(get_dev_fac_by_device($db, $deviceid));
	$query = 'DELETE FROM RSDeviceFacilityMatches WHERE deviceid = :deviceid';
	$statement = $db->prepare($query);
	$statement->bindValue(':deviceid', $deviceid);
	$remarks = 'deviceid-facilityid pair' . ($statement->execute() ? ' deleted.' : ' not deleted.');
	$statement->closeCursor();
	add_log($db, $remarks);
	if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSDeviceFacilityMatches', $to_be_deleted);
}

function delete_all_device_facilities($db) {
    $to_be_deleted = json_encode(get_all_device_facilities($db));
    $query = 'DELETE FROM RSDeviceFacilityMatches';
    $statement = $db->prepare($query);
    $remarks = 'All deviceid-facilityid pairs' . ($statement->execute() ? ' deleted.' : ' not deleted.');
    $statement->closeCursor();
    add_log($db, $remarks);
    if(!strpos($remarks, 'not deleted')) add_deleted_stuff($db, 'RSDeviceFacilityMatches', $to_be_deleted);
}

?>
./database/createdb.sql
-- Portable script for creating the RelayShield database
-- 
-- mysql -D RelayShieldDB -u root -p < createdb.sql 

-- RealyShield HouseKeeping Log table
CREATE TABLE RSHouseKeepingLog(
	id INT PRIMARY KEY AUTO_INCREMENT,
	occurredat TIMESTAMP,
	remarks VARCHAR(255),	-- auto generated / canned
	userid INT,
	FOREIGN KEY (userid) REFERENCES RSUsers(id)
	);

-- RelayShield User Types table
CREATE TABLE RSUserTypes(
	id INT PRIMARY KEY AUTO_INCREMENT,
	typename VARCHAR(20) NOT NULL UNIQUE,
	typedescription VARCHAR(255)
	);

-- RelayShield Users table
CREATE TABLE RSUsers(
	id INT PRIMARY KEY AUTO_INCREMENT,
	firstname VARCHAR(100),
	lastname VARCHAR(100),
	email VARCHAR(150) NOT NULL UNIQUE,
	username VARCHAR(50) NOT NULL UNIQUE,
	encryptedpassword VARCHAR(255),
	usertypeid INT,
	activestatus BOOLEAN DEFAULT false,
	FOREIGN KEY (usertypeid) REFERENCES RSUserTypes(id)
	);
-- TODO: add an index to the username column to speed up look-up during login.
	
-- RelayShield User Groups table
CREATE TABLE RSGroups(
	id INT PRIMARY KEY AUTO_INCREMENT,
	groupname VARCHAR(30) NOT NULL UNIQUE,
	groupdescription VARCHAR(255),
	activestatus BOOLEAN DEFAULT false
	);
	
-- RelayShield Group User Memberships table
CREATE TABLE RSGroupUserMemberships(
	id INT PRIMARY KEY AUTO_INCREMENT,
	groupid INT,
	userid INT,
	UNIQUE(groupid, userid),
	FOREIGN KEY (groupid) REFERENCES RSGroups(id),
	FOREIGN KEY (userid) REFERENCES RSUsers(id)
	);

-- RelayShield Devices table
CREATE TABLE RSDevices(
	id INT PRIMARY KEY AUTO_INCREMENT,
	deviceid VARCHAR(100) NOT NULL UNIQUE,
	encryptedaccesstoken VARCHAR(255),
	devicedescription VARCHAR(255),
	activestatus BOOLEAN DEFAULT false
	);

-- RelayShield Facilities table
CREATE TABLE RSFacilities(
	id INT PRIMARY KEY AUTO_INCREMENT,
	facilityname VARCHAR(30) NOT NULL UNIQUE,
	numberofrelays INT,
	activestatus BOOLEAN DEFAULT false
	);
	
-- RelayShield Device-Facility matching table
CREATE TABLE RSDeviceFacilityMatches(
	id INT PRIMARY KEY AUTO_INCREMENT,
	deviceid INT,	-- NB: this is the device id not the deviceid!
	facilityid INT,
	UNIQUE(deviceid, facilityid),
	FOREIGN KEY (deviceid) REFERENCES RSDevices(id),
	FOREIGN KEY (facilityid) REFERENCES RSFacilities(id)
	);
	
-- RelayShield Facility Group Memberships table
CREATE TABLE RSFacilityGroupMemberships(
	id INT PRIMARY KEY AUTO_INCREMENT,
	facilityid INT,
	groupid INT,
	UNIQUE(facilityid, groupid),
	FOREIGN KEY (facilityid) REFERENCES RSFacilities(id),
	FOREIGN KEY (groupid) REFERENCES RSGroups(id)
	);

-- RelayShield Activity Log table
CREATE TABLE RSActivityLog(
	id INT PRIMARY KEY AUTO_INCREMENT,
	facilityid INT,
	relaynumber INT,		-- 1 to 4
	activitytype VARCHAR(10),	-- auto / manual
	activityduration INT,		-- in seconds
	activityinterval INT,		-- in minutes
	activitystatus BOOLEAN,		-- idle|busy == false|true
	FOREIGN KEY (facilityid) REFERENCES RSFacilities(id)
	-- userid - activity owner (TODO)
	);
	
-- RelayShield Deleted Stuff table
CREATE TABLE RSDeletedStuff(
	id INT PRIMARY KEY AUTO_INCREMENT,
	fromtable VARCHAR(30) NOT NULL,
	recordsummary VARCHAR(255)	-- stringified summary of tuple being deleted
	);

-- Initializing the database
INSERT INTO RSUserTypes (typename, typedescription) VALUES ('regular', 'single-facility access'), ('uber', 'multi-facility access'), ('admin', 'resource allocator'), ('super', 'entity creator/destroyer');
INSERT INTO RSUsers (firstname, lastname, username, encryptedpassword, usertypeid, activestatus) VALUES ('SYSTEM', '', '', '', 99999, true), ('Rick', 'Root', 'rroot', 'Rroot123', 4, true);
INSERT INTO RSHouseKeepingLog (occurredat, remarks) VALUES (now(), 'Initialization of database!');

-- sample data for RSUsers

-- sample data for RSDevices
INSERT INTO RSDevices (deviceid, encryptedaccesstoken, devicedescription, activestatus) VALUES ('ZZZZZZZZZZZZZZZZ', '!@!@#@##$@#$#QWERWERF#$T', 'photon connected to a 4-switch relayshield', true), 
('qqqqqqqqqqqqqqqq', '!skjhsd987fs9fsdfWERF#$T', 'photon connected to a 8-switch photon', true), 
('350042000e51353532343635', '8db83ede2e5eb5b0047413935c796aaf9ab165ff', 'photon connected to a 4-switch relayshield', true), 
('mmmmmmmmmmmmmmmm', 'snl;dkfns;dns;dns;ndlsdn', 'photon connected to a 3-switch electron', true), 
('bBBBBBBBBBBBbbbb', '!kjsadskhfdsklskashdfk$T', 'photon connected to a 5-switch gadget', true);

-- sample data for RSFacilities
INSERT INTO RSFacilities (facilityname, numberofrelays, activestatus) VALUES ('Area 51', 4, true), ('The Triangle', 3, true), ('All dead!', 0, false), ('White house', 2, true);

-- sample data for RSGroups
INSERT INTO RSGroups (groupname, groupdescription, activestatus) VALUES ('area_51', 'level 5 clearance', true);

-- sample data for RSGroupUserMemberships
INSERT INTO RSGroupUserMemberships (groupid, userid) VALUES (1, 1), (1, 3);

-- sample data for RSFacilityGroupMemberships
INSERT INTO RSFacilityGroupMemberships (facilityid, groupid) VALUES (1, 1);

-- sample data for RSDeviceFacilityMatches
INSERT INTO RSDeviceFacilityMatches (deviceid, facilityid) VALUES (1, 2), (2, 3), (3, 1), (4, 4);
./database/showdb.sql
-- show db contents

SELECT * FROM RSGroups;
SELECT * FROM RSGroupUserMemberships;
SELECT * FROM RSDevices;
SELECT * FROM RSDeviceFacilityMatches;
SELECT * FROM RSUsers;
SELECT * FROM RSUserTypes;
SELECT * FROM RSFacilities;
SELECT * FROM RSFacilityGroupMemberships;
SELECT * FROM RSHouseKeepingLog;
SELECT * FROM RSDeviceFacilityMatches;
SELECT * FROM RSDeletedStuff;
./database/dropdb.sql
-- for use where we can't drop the whole database
-- drop targets of FKs after tables with the FKs

DROP TABLE IF EXISTS RSGroupUserMemberships;
DROP TABLE IF EXISTS RSActivityLog;
DROP TABLE IF EXISTS RSFacilityGroupMemberships;
DROP TABLE IF EXISTS RSDeviceFacilityMatches;
DROP TABLE IF EXISTS RSUsers;
DROP TABLE IF EXISTS RSDeletedStuff;
DROP TABLE IF EXISTS RSFacilities;
DROP TABLE IF EXISTS RSDevices;
DROP TABLE IF EXISTS RSGroups;
DROP TABLE IF EXISTS RSUserTypes;
DROP TABLE IF EXISTS RSHouseKeepingLog;
./view/header.php
<?php   $app_path = 'http://34.238.162.30/doser/mvc/'; ?>
<?php session_start(); ?>

<!DOCTYPE html>
<html>

<head>
  <title>Mr. Doser</title>
  <link rel="stylesheet" type="text/css" href="<?php echo $app_path . 'main.css' ?>">

</head>
<!-- the body section -->

<body>
  <aside>
    <br><img src="<?php echo $app_path; ?>images/mustachetc.png" alt="Mr. Doser">
  </aside>

  <header>
    <h1>Mr. Doser<br></h1>
    <div align="right">
	<?php 
	    if($_SESSION['firstname']) {
		echo('<a href="' . $app_path . '?action=edit_profile">' . $_SESSION['firstname'] . '</a>' . ' | <a href="' . $app_path . '?action=logout">logout</a>');
	    } else { echo(''); }
	?>
   </div>
  </header>
  <aside>
    <br>
    <div id="operator" class="operator">
      <a href="<?php echo $app_path; ?>">Home</a>
    </div>
    <br>
    <div id="operator" class="operator" style="display:<?php echo(($_SESSION['firstname'] && $_SESSION['usertypeid'] != 3) ? ' block' : ' none'); ?>">
      <label for="operator"><span>Operate:</span></label>
      <?php $user_facilities = get_user_facilities($db, $_SESSION['user']['id']); ?>
        <select onchange="location.assign(this.options[this.selectedIndex].value);">
        <option value=0>[choose]</option>
        <?php foreach($user_facilities as $user_facility) : ?>
        <option value='<?php echo $app_path ?>operator/index.php?action=load_facility&user_facility=<?php echo base64_encode(serialize($user_facility)); ?>'>
        <?php echo $user_facility['facility']; ?>
        </option>
        <?php endforeach; ?>
        </select>
    </div>
    <br>
    <div id="admin" class="admin" style="display:<?php echo(($_SESSION['firstname'] && $_SESSION['usertypeid'] > 2) ? ' block' : ' none'); ?>">
      <label for="operator"><span>Configure:</span></label>
      <select name="entities" onchange="location.assign(this.options[this.selectedIndex].value);">
        <option value=0>[choose]</option>
        <option value="<?php echo $app_path; ?>admins/facility">Facilities</option>
        <option value="<?php echo $app_path; ?>admins/device">Devices</option>
        <option value="<?php echo $app_path; ?>admins/group">Groups</option>
        <option value="<?php echo $app_path; ?>admins/user">Users</option>
      </select>
        </div>
    </aside>

./view/footer.php
<footer>
 <script type="text/javascript" src="<?php echo $app_path . 'facility.js'; ?>">
</script>
    <p>
        &copy; <?php echo date("Y"); ?> JPK RelayShield, Inc.
    </p>
</footer>
</body>
</html>
./facility.js.new
/*
 * Custom JS code to run the front-end UI for the RelayShield
 * @author JPK
 * @version 2.1
 *
 */

// capture up to 4 forms
var forms = document.querySelectorAll("form");

// submit & cancel all
var submitAllButton = document.querySelector("#submitAll");

// add an event listener on each form
for (i = 1; i <= forms.length; i++) {
  const RELAYNUM = i;
  let targetForm = document.querySelector("#tank" + RELAYNUM);
  let targetLog = document.querySelector("#log" + RELAYNUM);

  if (targetForm) {
	//onload event listener
  targetForm.addEventListener("load", function(event) {
      
      // the intermittent cancel button
      let cancelButton =
        '\t<button onclick="cancelRun(' + RELAYNUM + ', \'' + deviceID + '\', \'' + access_token + '\');">Cancel!</button>';

      event.preventDefault();

// prodding the RS for status
      fetch(
        "https:\/\/api.particle.io/v1/devices/" +
          document.querySelector("#device" + RELAYNUM).value + 
          "/rBusy" + RELAYNUM + "?access_token=" +
          document.querySelector("#token" + RELAYNUM).value + "&format=raw"
      )
         .then(response => response.text()
		 .then(text => { 
						if (text == 'true') {
							targetLog.textContent = "Status: busy, please wait or cancel!";
							disable_form(targetForm);
						} else if (text == 'false') {
							targetLog.textContent = "Status: idle.";
							enable_form(targetForm);
						} else {
							targetLog.textContent = "Status: connection failure!!!";
						}
						})
		 .then(response => { reloadById("#tank" + RELAYNUM); }) )
         .catch(error => console.error("Error:", error));
    });
  
	

    //onsubmit event listener
    targetForm.addEventListener("submit", function(event) {
      let data = new FormData(targetForm);
      let output = "Status: ";
      let deviceID = "";
      let access_token = "";

      // format data for submission and for the status bar
      for (const entry of data) {
        if (entry[0] === "device") deviceID = entry[1];
        if (entry[0] === "token") access_token = entry[1];
        if (entry[1] === "auto") {
          data.arg = "t:" + RELAYNUM + ",";
          output += "(" + entry[1] + ") ";
        } else if (entry[1] === "manual") {
          data.arg = "c:" + RELAYNUM + ",";
          output += "(" + entry[1] + ") ";
        }

        if (entry[0] === "duration") {
          data.arg += entry[1];
          output += entry[1] + " second" + (entry[1] > 1 ? "s" : "");
          if (data.arg[0] === "c") {
            data.arg += ";";
            output += ".";
          }
        } else if (entry[0] === "_interval" && data.arg[0] === "t") {
          data.arg += "," + entry[1] + ";";
          output +=
            " every " + entry[1] + " minute" + (entry[1] > 1 ? "s" : "") + ".";
        }
      }

      // updates the status bar
      targetLog.textContent = output;

      // the intermittent cancel button
      let cancelButton =
        '\t<button onclick="cancelRun(' + RELAYNUM + ', \'' + deviceID + '\', \'' + access_token + '\');">Cancel!</button>';

      if (data.arg.startsWith("t"))
        targetLog.insertAdjacentHTML("beforeend", cancelButton);
      event.preventDefault();

      // on-submit
      fetch(
        "https:\/\/api.particle.io/v1/devices/" +
          deviceID +
          "/relay?access_token=" +
          access_token,
        {
          method: "POST",
          mode: "cors",
          body: JSON.stringify(data),
          headers: new Headers({ "Content-Type": "application/json" })
        }
      )
        .then(res => res.json())
        .catch(error => console.error("Error:", error))
        .then(response => {
          targetForm.reset();
	  // console.log("Returned: ", response);
          prevPage(RELAYNUM);
        });
    });
  } else {
    // console.log("targetForm is null!");
  }


}

// "paginates" the form, shows next form page
function nextPage(z) {
  document.getElementById("radios" + z).style.display = "none";
  if (document.getElementById("tank" + z)["automan"].value == "auto") {
    document.getElementById("not_auto_" + z).className = "auto";
    document.getElementById("_interval" + z).required = true;
  } else {
    document.getElementById("not_auto_" + z).className = "not_auto";
    document.getElementById("_interval" + z).required = false;
  }
  document.getElementById("details" + z).style.display = "inline-block";
}

// shows previous form page
function prevPage(z) {
  document.getElementById("radios" + z).style.display = "inline-block";
  document.getElementById("details" + z).style.display = "none";
}

// cancels an auto run
function cancelRun(r, devID, aToken) {
  // let deviceId =  - make cancelRun a part of the eventListener. TODO.
  fetch(
    "https:\/\/api.particle.io/v1/devices/" + devID + "/relay?access_token=" + aToken,
    {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({ arg: "x:" + r + ";" }),
      headers: new Headers({ "Content-Type": "application/json" })
    }
  )
    .then(res => res.json())
    .catch(error => console.error("Error:", error))
    .then(response => console.log("Success:", response));
  prevPage(r);
  document.querySelector("#log" + r).textContent = "Status: Run cancelled.";
}

function multiSubmit() {
        for (i = 1; i <= forms.length; i++) {
                document.getElementById("tank" + i).submit();
        }
}

// cancels all runs
function cancelAll(devID, aToken, relays) {
  // let deviceId =  - make cancelRun a part of the eventListener. TODO.
  fetch(
    "https://api.particle.io/v1/devices/" + devID + "/relay?access_token=" + aToken,
    {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({ arg: "x:9;" }),
      headers: new Headers({ "Content-Type": "application/json" })
    }
  )
    .then(res => res.json())
    .catch(error => console.error("Error:", error))
    .then(response => console.log("Success:", response));
  prevPages(relays);
  // document.querySelector("#log" + r).textContent = "Status: Run cancelled.";
}

// shows previous form pages
function prevPages(z) {
  for (k = 1; k <= z; k++) {
    document.getElementById("radios" + k).style.display = "inline-block";
    document.getElementById("details" + k).style.display = "none";
    document.querySelector("#log" + k).textContent = "Status: Run cancelled.";
  }
}

// The polling function
function poll(fn, timeout, interval) {
  var dfd = new Deferred();
  var endTime = Number(new Date()) + (timeout || 2000);
  interval = interval || 100;

  (function p() {
    // If the condition is met, we're done!
    if (fn()) {
      dfd.resolve();
    }
    // If the condition isn't met but the timeout hasn't elapsed, go again
    else if (Number(new Date()) < endTime) {
      setTimeout(p, interval);
    }
    // Didn't match and too much time, reject!
    else {
      dfd.reject(new Error('timed out for ' + fn + ': ' + arguments));
    }
  })();

  return dfd.promise;
}

/*
 * Disables and enables every input, textarea, button and select elements inside
 * a form-element.
 *
 * Enhanced by JPK (Originally by Magnus Fredlundh)
 */

// Disables a form.
function disable_form(form) {
  var inputs = form.getElementsByTagName('input'),
      textareas = form.getElementsByTagName('textarea'),
      buttons = form.getElementsByTagName('button'),
      selects = form.getElementsByTagName('select');

  disable_elements(inputs);
  disable_elements(textareas);
  disable_elements(buttons);
  disable_elements(selects);
}

// Disables a collection of form-elements.
function disable_elements(elements) {
  var length = elements.length;
  while(length--) {
    elements[length].disabled = true;
  }
}

// Enables a (previously disabled) form.
function enable_form(form) {
  var inputs = form.getElementsByTagName('input'),
      textareas = form.getElementsByTagName('textarea'),
      buttons = form.getElementsByTagName('button'),
      selects = form.getElementsByTagName('select');

  enable_elements(inputs);
  enable_elements(textareas);
  enable_elements(buttons);
  enable_elements(selects);
}

// Enables a collection of form-elements.
function enable_elements(elements) {
  var length = elements.length;
  while(length--) {
    elements[length].disabled = false;
  }
}

function reloadById(theId){
    let container = document.querySelector(theId);
    let content = container.innerHTML;
    container.innerHTML = content; 
    
   //this line is to watch the result in console , you can remove it later	
    console.log("Refreshed"); 
}
./facility.js.save
/*
 * Custom JS code to run the front-end UI for the RelayShield
 * @author JPK
 * @version 2.0
 *
 */

// capture up to 4 forms
var forms = document.querySelectorAll("form");

// submit & cancel all
var submitAllButton = document.querySelector("#submitAll");

// add an event listener on each form
for (i = 1; i <= forms.length; i++) {
  const RELAYNUM = i;
  let targetForm = document.querySelector("#tank" + RELAYNUM);
console.log()  let targetLog = document.querySelector("#log" + RELAYNUM);

  if (targetForm) {

	let rsStatus = 0;
	let rsData = new FormData(targetForm);
	rsData.arg = 't:' + RELAYNUM + '0,0;';
	
	// prodding the RS for status
      fetch(
        "https://api.particle.io/v1/devices/" +
          rsData[0].device +
          "/relay?access_token=" +
          rsData[0].token,
        {
          method: "POST",
          mode: "cors",
          body: JSON.stringify(rsData),
          headers: new Headers({ "Content-Type": "application/json" })
        }
      )
        .then(res => res.json())
        .catch(error => console.error("Error:", error))
        .then(response => { rsStatus = response.return_value; });
	
	
	targetLog.textContent = (rsStatus === 2) ? "Status: Busy. Please wait or cancel!" : "Status: Idle.";

    //onsubmit event listener
    targetForm.addEventListener("submit", function(event) {
      let data = new FormData(targetForm);
      let output = "Status: ";
      let deviceID = "";
      let access_token = "";

      // format data for submission and for the status bar
      for (const entry of data) {
        if (entry[0] === "device") deviceID = entry[1];
        if (entry[0] === "token") access_token = entry[1];
        if (entry[1] === "auto") {
          data.arg = "t:" + RELAYNUM + ",";
          output += "(" + entry[1] + ") ";
        } else if (entry[1] === "manual") {
          data.arg = "c:" + RELAYNUM + ",";
          output += "(" + entry[1] + ") ";
        }

        if (entry[0] === "duration") {
          data.arg += entry[1];
          output += entry[1] + " second" + (entry[1] > 1 ? "s" : "");
          if (data.arg[0] === "c") {
            data.arg += ";";
            output += ".";
          }
        } else if (entry[0] === "_interval" && data.arg[0] === "t") {
          data.arg += "," + entry[1] + ";";
          output +=
            " every " + entry[1] + " minute" + (entry[1] > 1 ? "s" : "") + ".";
        }
      }

      // updates the status bar
      targetLog.textContent = output;

      // the intermittent cancel button
      let cancelButton =
        '\t<button onclick="cancelRun(' + RELAYNUM + ', \'' + deviceID + '\', \'' + access_token + '\');">Cancel!</button>';

      if (data.arg.startsWith("t"))
        targetLog.insertAdjacentHTML("beforeend", cancelButton);
      event.preventDefault();

      // on-submit
      fetch(
        "https:\/\/api.particle.io/v1/devices/" +
          deviceID +
          "/relay?access_token=" +
          access_token,
        {
          method: "POST",
          mode: "cors",
          body: JSON.stringify(data),
          headers: new Headers({ "Content-Type": "application/json" })
        }
      )
        .then(res => res.json())
        .catch(error => console.error("Error:", error))
        .then(response => {
          targetForm.reset();
	  console.log("Returned: ", response);
          prevPage(RELAYNUM);
        });
    });
  } else {
    // console.log("targetForm is null!");
  }


}

// "paginates" the form, shows next form page
function nextPage(z) {
  document.getElementById("radios" + z).style.display = "none";
  if (document.getElementById("tank" + z)["automan"].value == "auto") {
    document.getElementById("not_auto_" + z).className = "auto";
    document.getElementById("_interval" + z).required = true;
  } else {
    document.getElementById("not_auto_" + z).className = "not_auto";
    document.getElementById("_interval" + z).required = false;
  }
  document.getElementById("details" + z).style.display = "inline-block";
}

// shows previous form page
function prevPage(z) {
  document.getElementById("radios" + z).style.display = "inline-block";
  document.getElementById("details" + z).style.display = "none";
}

// cancels an auto run
function cancelRun(r, devID, aToken) {
  // let deviceId =  - make cancelRun a part of the eventListener. TODO.
  fetch(
    "https:\/\/api.particle.io/v1/devices/" + devID + "/relay?access_token=" + aToken,
    {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({ arg: "x:" + r + ";" }),
      headers: new Headers({ "Content-Type": "application/json" })
    }
  )
    .then(res => res.json())
    .catch(error => console.error("Error:", error))
    .then(response => console.log("Success:", response));
  prevPage(r);
  document.querySelector("#log" + r).textContent = "Status: Run cancelled.";
}

function multiSubmit() {
        for (i = 1; i <= forms.length; i++) {
                document.getElementById("tank" + i).submit();
        }
}

// cancels all runs
function cancelAll(devID, aToken, relays) {
  // let deviceId =  - make cancelRun a part of the eventListener. TODO.
  fetch(
    "https://api.particle.io/v1/devices/" + devID + "/relay?access_token=" + aToken,
    {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({ arg: "x:9;" }),
      headers: new Headers({ "Content-Type": "application/json" })
    }
  )
    .then(res => res.json())
    .catch(error => console.error("Error:", error))
    .then(response => console.log("Success:", response));
  prevPages(relays);
  // document.querySelector("#log" + r).textContent = "Status: Run cancelled.";
}

// shows previous form pages
function prevPages(z) {
  for (k = 1; k <= z; k++) {
    document.getElementById("radios" + k).style.display = "inline-block";
    document.getElementById("details" + k).style.display = "none";
    document.querySelector("#log" + k).textContent = "Status: Run cancelled.";
  }
}
./passwdrecovery.php
<?php include 'view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:60%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Password Recovery</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="recovery" name="recovery" action="index.php" method="post">
	  <input type="hidden" name="action" value="recover_password">
          <fieldset>
            <legend>Password Recovery</legend>

            <pre><?php echo $recovery_message; ?></pre>
            <p>
              <label for="recovery_email"><span>Please enter the email address associated with your account:</span></label>
	    </p><p>
              <input type="email" id="recovery_email" name="recovery_email" required />
            </p>
            </p>
              <button type="submit">Submit</button>
              <button onclick="this.form.action.value='login'; this.form.submit(
)">Cancel</button>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include 'view/footer.php'; ?>

./index.php.save
<?php
require('../../model/rsusers.php');



require('../../model/rsgroups.php');
require('../../model/rsdevices.php');
require('../../model/rsdatabase.php');
require('../../model/rsfacilities.php');
require('../../model/rsdevicefacilitymatches.php');
require('../../model/rsfacilitygroupmemberships.php');

$action = filter_input(INPUT_POST, 'action');
if ($action == NULL) {
    $action = filter_input(INPUT_GET, 'action');
    if ($action == NULL) {
        $action = 'device_list';
    }
}

if ($action == 'device_list') {
    if($filter == NULL)
	$filter = filter_input(INPUT_POST, 'filter', FILTER_SANITIZE_STRING);
    try {
	if($filter == "active")
	   $all_devs = get_active_devices_list($db);
	elseif($filter == "inactive")
	   $all_devs = get_inactive_devices_list($db);
	else
	   $all_devs = get_devices_list($db);
    } catch (PDOException $e) {
      $error_message = $e->getMessage(); 
      include('../../errors/database_error.php');
      exit();
    }
    include('list.php');
} elseif ($action == 'new_device') {
    try {
        $available_facilities = get_all_available_facilities($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');    
        exit();
    }
    include('new.php');
} elseif ($action == 'edit_device') {
    $device = unserialize(filter_input(INPUT_GET, 'device'));
    try {
        $available_facilities = get_all_available_facilities($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    include('edit.php');
} elseif ($action == 'add_device') {
$new_device_name = filter_input(INPUT_POST, 'new_device_name');
if ($new_device_name == NULL) {
    $new_device_name = filter_input(INPUT_GET, 'new_device_name');
    if ($new_device_name == NULL) {
        echo("Nothing came through for new_device_name");
    }
}

$new_device_token = filter_input(INPUT_POST, 'new_device_token');
if ($new_device_token == NULL) {
    $new_device_token = filter_input(INPUT_GET, 'new_device_token');
    if ($new_device_token == NULL) {
        echo("Nothing came through for new_device_token");
    }
}

$new_facility_id = filter_input(INPUT_POST, 'new_device_facility_id');
if ($new_facility_id == NULL) {
    $new_facility_id = filter_input(INPUT_GET, 'new_device_facility_id');
    if ($new_facility_id == NULL) {
        echo("Nothing came through for new_facility_id");
    }
}

$new_device_status = filter_input(INPUT_POST, 'new_device_status', FILTER_VALIDATE_BOOLEAN);
if ($new_device_status == NULL) {
    $new_device_status = filter_input(INPUT_GET, 'new_device_status', FILTER_VALIDATE_BOOLEAN);
    if ($new_device_status == NULL) {
        echo("Nothing came through for new_device_status");
	$new_facility_status = 0;
    }
}

$new_device_description = filter_input(INPUT_POST, 'new_device_description');
if ($new_device_description == NULL) {
    $new_device_description = filter_input(INPUT_GET, 'new_device_description');
    if ($new_device_description == NULL) {
        echo("Nothing came through for new_device_description");
    }
}

    try {
        add_device($db, $new_device_name, $new_device_token, $new_device_description, $new_device_status);
	add_device_facility($db, (int)get_device_id($db, $new_device_name), $new_facility_id);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'update_device') {
$old_device_name = filter_input(INPUT_POST, 'old_device_name');
if ($old_device_name == NULL) {
    $old_device_name = filter_input(INPUT_GET, 'old_device_name');
    if ($old_device_name == NULL) {
        echo("Nothing came through for old_device_name");
    }
}

$old_facility_name = filter_input(INPUT_POST, 'old_facility_name');
if ($old_facility_name == NULL) {
    $old_facility_name = filter_input(INPUT_GET, 'old_facility_name');
    if ($old_facility_name == NULL) {
        echo("Nothing came through for old_facility_name");
    }
}

$edit_device_name = filter_input(INPUT_POST, 'edit_device_name');
if ($edit_device_name == NULL) {
    $edit_device_name = filter_input(INPUT_GET, 'edit_device_name');
    if ($edit_device_name == NULL) {
        echo("Nothing came through for edit_device_name");
    }
}

$edit_device_token = filter_input(INPUT_POST, 'edit_device_token');
if ($edit_device_token == NULL) {
    $edit_device_token = filter_input(INPUT_GET, 'edit_device_token');
    if ($edit_device_token == NULL) {
        echo("Nothing came through for edit_facility_relay");
    }
}

$edit_facility_id = filter_input(INPUT_POST, 'edit_device_facility_id');
if ($edit_facility_id == NULL) {
    $edit_facility_id = filter_input(INPUT_GET, 'edit_device_facility_id');
    if ($edit_facility_id == NULL) {
        echo("Nothing came through for edit_facility_id");
    }
}

$edit_device_status = filter_input(INPUT_POST, 'edit_device_status', FILTER_VALIDATE_BOOLEAN);
if ($edit_device_status == NULL) {
    $edit_device_status = filter_input(INPUT_GET, 'edit_device_status', FILTER_VALIDATE_BOOLEAN);
    if ($edit_device_status == NULL) {
        echo("Nothing came through for edit_device_status");
	$edit_device_status = 0;
    }
}

$edit_device_description = filter_input(INPUT_POST, 'edit_device_description');
if ($edit_device_description == NULL) {
    $edit_device_description = filter_input(INPUT_GET, 'edit_device_description');
    if ($edit_device_description == NULL) {
        echo("Nothing came through for edit_device_description");
    }
}

    try {
        update_device($db, $edit_device_name, $edit_device_token, $edit_device_description, $edit_device_status, get_device_by_name($db, $old_device_name));
	if ($edit_facility_id != 99999) {
	    update_facility_device($db, (int)get_device_id($db, $edit_device_name), (int)$edit_facility_id);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'delete_device') {
$delete_device_name = filter_input(INPUT_POST, 'delete_device_name');
if ($delete_device_name == NULL) {
    $delete_device_name = filter_input(INPUT_GET, 'delete_device_name');
    if ($delete_device_name == NULL) {
        echo("Nothing came through for delete_device_name");
    }
}

if($delete_device_name) {
	echo('proceed with deleting ' . $delete_device_name . ' now.');
	die();
	} else {
	echo('deleting ' . $delete_device_name . ' halted.');
	die();
	}
    header('Location: .');
} else { echo "Something's wrong!"; }

?>
./codebase_JPK_RS.txt
./facility.js
/*
 * Custom JS code to run the front-end UI for the RelayShield
 * @author JPK
 * @version 2.1
 *
 */

// capture up to 4 forms
var forms = document.querySelectorAll("form");

// submit & cancel all
var submitAllButton = document.querySelector("#submitAll");

// add an event listener on each form
for (i = 1; i <= forms.length; i++) {
  const RELAYNUM = i;
  let targetForm = document.querySelector("#tank" + RELAYNUM);
  let targetLog = document.querySelector("#log" + RELAYNUM);

  if (targetForm) {

  var prodding = (RELAYNUM, sText = '') => {

	let prodTargetForm = document.querySelector("#tank" + RELAYNUM);
	let prodTargetLog = document.querySelector("#log" + RELAYNUM);
	let prodDevID = document.querySelector("#device" + RELAYNUM).value;
	let prodToken = document.querySelector("#token" + RELAYNUM).value;


	 // the intermittent cancel button
	let theCancelButton = '<button type="button" onclick="cancelRun(' + RELAYNUM + ', \'' + prodDevID + '\',\'' + prodToken + '\');">Cancel!</button>';

	// prodding the RS for status
      fetch(
        "https:\/\/api.particle.io/v1/devices/" +
          prodDevID + 
          "/rBusy" + RELAYNUM + "?access_token=" +
          prodToken + "&format=raw"
      )
         .then(response => response.text()
		 .then(text => { 
				if (text == 'true') {
					prodTargetLog.textContent = "Status: busy" + sText + ", please wait or ";
					disable_form(prodTargetForm);
					prodTargetLog.insertAdjacentHTML("beforeend", theCancelButton);
				} else if (text == 'false') {
					prodTargetLog.textContent = "Status: idle.";
					enable_form(prodTargetForm);
				} else {
					prodTargetLog.textContent = "Status: connection failure!!!";
				}
				})
	)
         .catch(error => console.error("Error:", error));
  };

  prodding(RELAYNUM);

    //onsubmit event listener
    targetForm.addEventListener("submit", function(event) {
      let data = new FormData(targetForm);
      let output = " [";
      let deviceID = "";
      let access_token = "";
      let prodInterval = 0;

      // format data for submission and for the status bar
      for (const entry of data) {
        if (entry[0] === "device") deviceID = entry[1];
        if (entry[0] === "token") access_token = entry[1];
        if (entry[1] === "auto") {
          data.arg = "t:" + RELAYNUM + ",";
          output += "(" + entry[1] + ") ";
        } else if (entry[1] === "manual") {
          data.arg = "c:" + RELAYNUM + ",";
          output += "(" + entry[1] + ") ";
        }

        if (entry[0] === "duration") {
          data.arg += entry[1];
          output += entry[1] + " second" + (entry[1] > 1 ? "s" : "");
	  prodInterval = (parseInt(entry[1]))*1000;
          if (data.arg[0] === "c") {
            data.arg += ";";
            output += "]";
          }
        } else if (entry[0] === "_interval" && data.arg[0] === "t") {
          data.arg += "," + entry[1] + ";";
          output +=
            " every " + entry[1] + " minute" + (entry[1] > 1 ? "s" : "") + "]";
        }
      }

     event.preventDefault();

      // on-submit
      fetch(
        "https:\/\/api.particle.io/v1/devices/" +
          deviceID +
          "/relay?access_token=" +
          access_token,
        {
          method: "POST",
          mode: "cors",
          body: JSON.stringify(data),
          headers: new Headers({ "Content-Type": "application/json" })
        }
      )
        .then(res => res.json())
        .catch(error => console.error("Error:", error))
        .then(response => {
          targetForm.reset();
          prevPage(RELAYNUM);
        })
	.then( response => prodding(RELAYNUM, output) )
	.then( response => setTimeout(() => prodding(RELAYNUM), prodInterval) );
    });
  } else {
    // console.log("targetForm is null!");
  }


}

// "paginates" the form, shows next form page
function nextPage(z) {
  document.getElementById("radios" + z).style.display = "none";
  if (document.getElementById("tank" + z)["automan"].value == "auto") {
    document.getElementById("not_auto_" + z).className = "auto";
    document.getElementById("_interval" + z).required = true;
  } else {
    document.getElementById("not_auto_" + z).className = "not_auto";
    document.getElementById("_interval" + z).required = false;
  }
  document.getElementById("details" + z).style.display = "inline-block";
}

// shows previous form page
function prevPage(z) {
  document.getElementById("radios" + z).style.display = "inline-block";
  document.getElementById("details" + z).style.display = "none";
  document.querySelector("#log" + z).textContent = "Status: Run cancelled.";
}


// cancels an auto run
function cancelRun(r, devID, aToken) {
  // let deviceId =  - make cancelRun a part of the eventListener. TODO.
  fetch(
    "https:\/\/api.particle.io/v1/devices/" + devID + "/relay?access_token=" + aToken,
    {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({ arg: "x:" + r + ";" }),
      headers: new Headers({ "Content-Type": "application/json" })
    }
  )
    .then(res => res.json())
    .then(response => prevPage(r))
    .then(response => prodding(r))
    .catch(error => console.error("Error:", error));
}


// cancels all runs
function cancelAll(devID, aToken, relays) {
  // let deviceId =  - make cancelRun a part of the eventListener. TODO.
  fetch(
    "https://api.particle.io/v1/devices/" + devID + "/relay?access_token=" + aToken,
    {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({ arg: "x:9;" }),
      headers: new Headers({ "Content-Type": "application/json" })
    }
  )
    .then(res => res.json())
    .then(res => prevPages(relays))
    .catch(error => console.error("Error:", error));
//  prevPages(relays);
  // document.querySelector("#log" + r).textContent = "Status: Run cancelled.";
}

// shows previous form pages
function prevPages(z) {
  for (k = 1; k <= z; k++) {
    document.getElementById("radios" + k).style.display = "inline-block";
    document.getElementById("details" + k).style.display = "none";
    document.querySelector("#log" + k).textContent = "Status: Run cancelled.";
    prodding(k);
  }
}

// The polling function
function poll(fn, timeout, interval) {
  var dfd = new Deferred();
  var endTime = Number(new Date()) + (timeout || 2000);
  interval = interval || 100;

  (function p() {
    // If the condition is met, we're done!
    if (fn()) {
      dfd.resolve();
    }
    // If the condition isn't met but the timeout hasn't elapsed, go again
    else if (Number(new Date()) < endTime) {
      setTimeout(p, interval);
    }
    // Didn't match and too much time, reject!
    else {
      dfd.reject(new Error('timed out for ' + fn + ': ' + arguments));
    }
  })();

  return dfd.promise;
}

/*
 * Disables and enables every input, textarea, button and select elements inside
 * a form-element.
 *
 * Enhanced by JPK (Originally by Magnus Fredlundh)
 */

// Disables a form.
function disable_form(form) {
  var inputs = form.getElementsByTagName('input'),
      textareas = form.getElementsByTagName('textarea'),
      buttons = form.getElementsByTagName('button'),
      selects = form.getElementsByTagName('select');

  disable_elements(inputs);
  disable_elements(textareas);
  disable_elements(buttons);
  disable_elements(selects);
}

// Disables a collection of form-elements.
function disable_elements(elements) {
  var length = elements.length;
  while(length--) {
    elements[length].disabled = true;
  }
}

// Enables a (previously disabled) form.
function enable_form(form) {
  var inputs = form.getElementsByTagName('input'),
      textareas = form.getElementsByTagName('textarea'),
      buttons = form.getElementsByTagName('button'),
      selects = form.getElementsByTagName('select');

  enable_elements(inputs);
  enable_elements(textareas);
  enable_elements(buttons);
  enable_elements(selects);
}

// Enables a collection of form-elements.
function enable_elements(elements) {
  var length = elements.length;
  while(length--) {
    elements[length].disabled = false;
  }
}
./images/ui-icons_ffffff_256x240.png
PNG

   IHDR         IJ   uPLTE   f@   &tRNS 3@`.fPJ"(Ecm1Vq8Dn  !IDATxAn0?q]&
ACJ$l9kZ
%F#x*(V+|%(
g>	 Yc	.@av9E< bSl;89yAvUya~Pl^{ =V?*'`}p'C8(tw
4=b(t@>=`v0Oaa__ =,><K
M b^6lnq 
2fSxoBN_<='GQv !C~p]O`008Wy1}~%W 'P)dx| PW5_Tl@Q Yk/|(Bqa	`V[2fn,T`z3~+5_a06t&h`5p?r0FW1^pf#+M7+M)A'Q,Ky%K;ST*Aa,Q [ }_M0D(_KXNX eTApRBV[P:OpPCg gW [qkAnK
C
xr@NpI'F?Bf.+
m|5yNRT*oK_0[?{+ pX'ay9`SVq|{74V v=#P
oG"?#?aZ |cc!$h1@77jF^M T*JS"@?xI{ [bfmk(_v""S1YDoyk@1tGl2CQW'myo8Sn # H8  	N@.>r.1\f# 'AIm|LNc @={`7 N(# 3 BC&QB+`ab?  )]. Z ].@6!pS8@\HJz8!8>`x5G] 9pwwj0M! G{]#H"!hiy\. c
>$!YX $\D[_632#)Bd."zVo7((#>?3JRT}'RGllGY{VK
ONtF?Q`\ g=?e;;'4eD='x{TB>r[ J	uVF!iyAc~9=RDLN UaL?DZAT.Pj>{!HbdVF)Pnf R	4&Hi"h>vghl#@WH[JV@Y SMq&W}ng]rcm`gwi1I"[s0t/7i'||d>
 "y7Ai Q.g/O?-eXtl("L4q >Z	/2;&3<t;B$NhF hHOG"
rw|0{[ORyb9 b@R$Uno4*GJ{rZ(!"t+Hyf ; 7'@B}X]M 6ew0P=(OaS` id{yL]3 dH`8yyr;?.Ob/@sg/vQq.dL+Mi'aT3 2u=zn</+v +2Pkv@{` m@u0)+MWYb+v ?< oa Q`/-& s4B49+ww$[Fnd'.@ pal:{Wa)<wfZh46PKlbb\zq o0
pEyeP
w_C9J "ZX>{ba2 ezZWwKRr(pgf\~rrd`mMQt\c0@+4
@`\b9"(b!G`LB`u:U?l!X lc ,ri-4ID e@!c%\u@sY0V\T0Q :
\ 1l'/=J}'KeuT_{r
:+ %?8V_(V5\)plTx&Z) T%fLM{7|Y6m5JT0KJqPvPEKQHMq+`n lr| Nk9xGZ;^1b ZoGZzI -Ciri-;#W[@DV5 rp4&Z.AW|,c!`!{&xH:zO:3%/ 6h8I}A~2@x4j r~lmj)i$k@1wdx}h?wey}4!;N`}oo  ZA!/|@ sscc% !:>	]lI^ov`rv [n/Wfp3zv0|8~(#  Rn/    IENDB`./images/logobk.png
PNG

   IHDR      9   T8   bKGD      	pHYs        tIME)HT  ,IDATxm0FG*2I']0{Q"E~$%Q :d%?K)                       %ooo;`"5MN7l8o||||?W6Pq~N]pu\^-;F3ePDh21.C|,Dimi/Xi'|>	>Ed`x.q'es2v8kYAId\.c(%Yq^+f utnS\s c.~B\3)KdF,VIfVBy]9g$D/JX)#+&secqJLcTiSZ)VVAeyz)L{Y:u}3!BcnjqKYUy.~gL+Vz1cs(1D///?2%+t:V89viK;F?6e"N`O1yT!"Y5/INcvb%yw?H,T\Rg6	#9se!o];;zhhF5J`x3J`1-!qRq1+5H[H3)s;*B(_3R}%0g=	.5DcbsUWIk(T!Q/o{
``fM^ O<Q!OBR.riSLXQe2=CC[E	haXRU._(JzI.%%<H`8)gxK)Fm$l\N~#Y%2Iv-n;ypn@qYq,lJ1_M	z&b j-'R
z2	-mF`wRKwsMBa                    `jwj    IENDB`./images/mustachetc.png
PNG

   IHDR      +   UqI   bKGD      	pHYs    +   tIME("\  IDATx\[H?;b7K +,}!+%,KPA%zHADQ!"M$hX3;3;_vwf{9=|3BDrAwg,vV6O*}N M3fc5euJVz1BGB,L8N'q< (
6{]eEQp E<nkk+W;w{nHKK  EQ4 V.~?$$$  @kk+<y^/L8aE#:B(
Y(~un )S{M~_SM*,cUU&&&rO('--uBfw	& ;;;c'G/MMMX__wTT^/;w322H%e;vO,KAuiOBA8y^8<}#rk <6 QDz(f olC/b$,(IZOcc#ZV/_---YK|s9,7( nQADDlooy8#kkk\S
\ X\\sUfds! GYy&$"QMII"<tbrrj]zn:b"X~<xnrPl
\v5w9M
1cv]+Wboo&  Izg&1w\GbXb1YgZ'3O<[nX5\OUVVZ
6`2jS<s&'N@WWWk~g.B>&ePt8p&u@C eJF2a.u;U/^7Hn~_3IgF lii e JGFFz/PFDlhh@IgKUUU	X1kJKKCVWzofR[l8su6R:;;-W:7nQv@IxtL.KZ(,3KvMM(>&9iZJSm`c'ryMKVF#N{ikWEcSS`>`rB155P!8k-XW,=oZ=+GIJ[[[#^ZB	7o "2jAEEry	`o
QHXXUSr1dkn&@$PE .++_r$I I0Z%&kjj`0as'O+X~=ddd$IqHd1cbGX >KANIno^8VX\ 3
  %%z{{58SvCiiJK5_f*~s99x<!A OeWC2F}P(aq  6l]$kkk!// FqGAH~,rssX1 ?N8N8t#ibzob7T	;BD7nYF, 2(`Y4  Av{$&LV{!*k
 y4W=mFd`*IIIkDD}m#IufR/#ihD)))1QimmLN cM}+lm 7RM7Z1c&q;R6yiAT2xLxvw.gZiXd;h>03b2F+4h5VV\|>:s/_=WL=Y&#_}(
z"C 6O fn POYC9SWP] }41wjF	W{J6R!9bbpEgQ}F)114?Ay&]6*25#3$xb"- ;Bz~?$78}4HfLJJ
u!".Y;?~!RWh+*e~tlnf<Bg^:(4;:;;wA<7233aj*SUvtnXlO_p=x!~3ai&Xn50NQBQ5o	u;q$ "(Z&Q5x^6/_@WW(~DQA`
'OYfAvv69s4SEHqj%l>.EQy^#?k~.MTHEAIF{d,XFdkxoG5;	7+LY$l#hq'At}*|4'XFLhUd}q,vr2vINv?d?2'k1V|t!39Nzh>T  I
3\PX/CHW@VuOHphCpVqFE`}    IENDB`./images/mustache.png
PNG

   IHDR      7   A   sRGB    gAMA  a   	pHYs    +  IDATx^YM]gRR$!"L)!nH0_33"S<:z>gsy^_kzg=kT0119'VLQ+(TW
HJX18bBX1E!*S?0bqogX1C")1<W/$rubN%e1nRE-}u]v37w5OnMu] 	j'b_[@?|%TRVqqL*3-3;v45j0*Tuk`dvczmfMfk-	(mH6$W*o10&M2:u\P~}3djF~([M:uJXbUT)evGSh7A:dj].>|ym~$\}tyurMB|}s} rrgY<yrLK\-h_J*ayI2}~m?${EJ,HNn9Lo=lSJ7CKC3=}@`[gb$z]ysR"Nu7.&UV5O>g#rN,|>4mIs!	(l.6Y=6nIgVR::E#V FG&-'b?\ zI3fh"3rHqc^gN=M;x|CpYzpmC]
F;1_safu)W.Kwr/O\i\[9sse)(u8x(>;a	X:#N9^g0aYf;vlzi6
N d^(q;hBQ~d~@}mzeu}	}}Oa	X( h2|\s@?N3aR={,{MA:}6(^ m^jcI#u! (+!Fu
%3@yq sFd 3'b3)S7-N.m{m\%sR@gu:\::kV;CM+dH%b8j}uMXO?,?3g!j?}q%-hpi_mAPr4lGRfQG{MPRp{O=zum0<5j0z*D&9-Tld<r=w>.9sET2SpW ,p+6Ak,dxw)A;u\sFL:5M'.'AqRjeMf>lg<P>w<xpUm;w}KlX/lh;vHcLe]<2*/69:^zoSN ~( XZj?s EO9s9AM~Cm3&;XfC EK,{C_g2X XK%:I$J^WX|W8UIEO o_k\Fu]'M~|rz8@WF}]v_3S3;vD@}ve\S{'m_%Tbq:k.E.~+p>n8og,Iq%WB
y} u.E!S@;tw~T#|Gr
$9]+:(kG:\'NMtrm5#}u#?IJ,^om%T@~o>acCp #%B3 |Ff]*xH1.@:v3+J!D`iEu6UfQ;R5xH:mS$eA%i[O{`=IAq 2T8 x.M`DYfQ48+,m.Xa+>q9*cPt		wA}
N,(,Y$m ZWqZY3\*AJDqvNwIKO|D;+w`@vuwV8R[:1
&Tcm{g.KtbVXan=/HO$3 	bXGxz.HSNYTblo7B'Nq@<\/gOS/m'*W?{=z#_yfTkex}>&]DX:m93r|<SaEz&;w_?Q
lum6gK!o>:"WQ}J]]iKXs:]) `Jn.X>ed'~1>vo{D*Q;A\Av^%?v\8n!Z{1`qJvDXF|}h`J]8FX0fjJ;w;j}JQJv+mUtq	lszm_(QkKi>ym&*v>[Ad+K6w}vJm$?n{#WVt    IENDB`./images/logo.png
PNG

   IHDR      9   T8   bKGD      C   	pHYs        tIME$2B  IDATx]yTnm`#URl"v#0.AM&F%L6ubzIIUnjhZnk{w;Z^AU>[wZUD<x<x<xP	[#pd!]@DGQ^kGDNV-2""Z@D=G0#E{BD|":)pdr=xKak4U|{e8D4vzxP"g"zP,qG:^_DDWutz&6"
_t:=-F1aD20nS{S{=qk[`t=%L< zJI)e+ZGD';Tj~~U?5l#OmiiyW1H)?}qt0"hQJ|?L9`pK=RJeho3	B[F*i]=5XKK|3^}]0f!BM1EqwW0=)WF(L>bXE(WgggpQisvc)|'X3v":ZD!FgRv*vH2@.K;v26BB/8E1?`M:dq#`9g;Sk"xY)u.2jJ>3,xDJP(}|GmBZ{Bh8r>\Ez:1ADg3&"P(tkkk1#Nr3(#|gA'|?)AMlff H -:q?|%Bi}DD>RjoRJmmc$:"~n`#49 ^
[|>r!"!QB1BbT!; :LB|'/KD[[[]Gv!u\Y   <cfcR]B.AM#3-l"J\.7"<J-Nhj	%"?~|4D4WJ1Ms{Z)g[?~!
!BBK{|Q}DDHPJ 3@x[2)fRJx'B z&9ecRJr# < WnJH$ZPM5MdekdJ)zjb 3_`{eh82#(>N}}}k$R },bd&oU> R/cvaktm2$##;]D{{ 	Y()d7fZJyV}bOnp=juFookb+kj_+
a ?JJP(em;;;zaoHp\:$d2ff)x] },[ zL&3	# V5M #Hxq@Sq*U  nD%L&Jh nQwsqC ,rX=! V7SFp
z/i5 d:]{q,n }X!0 @C;zE #a[ooJx/Mf9>,V8 "HQsmn0^E :U nHO	rqS3?)T>:j/t2Z`5_) { s ^R.kAu^CmpGZ92Dn 4U>(?_4ez{ zNSK:bx0x<dYI|U	-  1Ms^oo(Gf(<VAmm>QJzefT- S'O20^pR6=p_>/m{y6r_QWg+,:Iq!	xh2E  `a: f3M/0xwDkd2xd	f)Tfht:=d2-rv l`k-X44 V~ak_C PJ)UIhx !h8tAe&XZ)OF3`=3g`kW)P*8;v5&kN0'N'$<Mn=%H-lUE&k
`%Rd3_.#9T DkP8JJ|chE.`Fl&_I);6<U(9Mvv~GqvZ~':?2Ms~2lbt:=4% U=vf_tNIZ(""5 v}`yyt9MJyG H41RQ4EKLYQLb5Lg^FN*e=uU>4nmf>gppp<3C:(K~2BaZY4a];#t V~?em,:]uC\qqcq2#\l{C73/MBwD17lB_z*	,olsj|s2mfi= 'B!l_*} ~`}>hE]KEG*\-vUG"cK.eQ
.ZF {j	Y 8Fa[%bl\BNw*V ~L@.Uebr+lR]Eg/R.rDkhhh6Wyf/u& )cC   \N@;]V)5kR5KFpdL5\[Zs9xZrTG'77]3=\G  <RD`bs&_&9K(rEGo*Ty|K3eG@s&T*5^-R&z{{G1? cn3x<dR V.`6q.?	 ;dw9OR`hP	~.&Y{ L<q-R~Yf(Lw=lJUN>[pGJyaX,h,fZHcYVM_KsHRJyfUg}ifGX?jkF(E2X
H"hkAJ ]eRfuBaZ2l5R.qx0cDRdt[ruERhLp&d)Ij9K1n(WT$>
3Y1	ja:80 v U}!O-jD%v+}s+$- X9 xsU**6 ?+W]5 OJ?[Xa3 d(9R' /JN-C >2Lr#to1+}`FD":uyP`S_<;%*>=Hr4>)sf;#<Q*hVvND`<h8+Q<xL#K"D4PF
HMz}dQ"2\0R5h"]H<x<xp  o\i    IENDB`./user_manual.txt
Programming notes (future User Manual):

1.	- MySQL database RelayShieldDB has 11 tables
	Entities:		RSUsers		- registered users
					RSGroups	- groups
					RSDevices	- devices
					RSFacilities- facilities
					
	Relationships:	RSGroupUserMemberships		- user-group
					RSDeviceFacilityMatches		- device-facility
					RSFacilityGroupMemberships	- group-facility
					
	Support:		RSUserTypes			- user type
					RSHouseKeepingLog	[- logs changes to the database (TODO)]
					RSActivityLog		[- logs instructions to the RelayShield (TODO)]
					RSDeletedStuff		[- keeps flat copy of all database deletions (TODO)]
					
					
					
					
2. 	- Four main enitities: Users, Groups, Devices and Facilities.

	Users:	 	- independently register at the site (anyone can register!)
				- there are 4 usertypes: 	1. regular	(1-facility operator)
											2. uber    	(multi-facility operator)
											3. admin	(user-group-device-facility assigner)
											4. super	(group-device-facility creator)
					(see table RSUserTypes in RelayShieldDB)
				- will automatically be assigned usertype regular
				[- modified by usertype admin, super (TODO)]
				- 1:1 relationship between User:UserType
				- registered in table RSUsers
				
				
	Groups:		- created/modified/deleted by usertype super
				- modified by usertype admin
				- collection of Users
				- registered in table RSGroups
				- M:N relationship between User:Group
				- table RSGroupUserMemberships captures User-Group relationships
				
				
	Devices:	- created/modified/deleted by usertype super
				- modified by usertype admin
				- registered in table RSDevices
				
				
	Facilities:	- created/modified/deleted by usertype super
				- modified by usertype admin
				- registered in table RSFacilities
				- 1:1 relationship between Device:Facility
				- table RSDeviceFacilityMatches captures Device-Facility relationships
				- M:N relationship between Group:Facility
				- table RSFacilityGroupMemberships captures Group-Facility relationships
				
3.	RelayShield - Particle programmable IoT device
	
	Particle Photon combined with a four-switch relay board
./profile1.php
<?php include 'view/header.php'; ?>
<?php /*session_start();*/ ?>
<?php /*if(!$_SESSION['firstname']) :
        include '../index.php';
        exit();
      endif;*/
?>
<main>
    <section>
        
<table border='0' style='width:60%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">User Profile</h1>
      </td>
    </tr>
    <tr>
      <td>

 <form id="profile" name="profile" action="index.php" method="post">
          <input type="hidden" name="action" value="profile">
          <fieldset>
            <legend>User Profile</legend>

            <pre><?php echo $registration_message; ?></pre>
            <p>
              <label for="firstname"><span>First Name:</span></label>
              <input type="text" id="profile_firstname" name="profile_firstname" value='<?php echo $user['firstname'];?>' >
            </p>
            <p>
              <label for="lastname"><span>Last Name:</span></label>
              <input type="text" id="profile_lastname" name="profile_lastname" value='<?php echo $user['lastname'];?>' >
            </p>
            <p>
              <label for="email"><span>Email:</span></label>
              <input type="email" id="profile_email" name="profile_email" value='<?php echo $user['email'];?>' >
            </p>
            <p>
              <label for="username"><span>username:</span></label>
              <input type="text" id="profile_username" name="profile_username" value='<?php echo $user['username'];?>' disabled >
            </p>
            <p>
              <label for="password"><span>password:</span></label>
              <input type="password" id="profile_password" name="profile_password" >
            </p>
            <p>
              <label for="confirm_password"><span>confirm password:</span></label>
              <input type="password" id="profile_confirm_password" name="profile_confirm_password" >
            </p>
              <button type="submit">Update</button>
              <button onclick="this.form.action.value='delete_profile'; this.form.submit()">Delete Profile</button>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include 'view/footer.php'; ?>

./main.css
html {
    background-color: #427af4;
}
body {
    font-family: Arial, Helvetica, sans-serif;
    width: 760px;
    margin: 0 auto;
    padding: 0 2em;
    background-color: white;
    border: 1px solid black;
}
header {
    border-bottom: 2px solid black;
    padding: .5em 0;
}
header h1 {
    color: darkslategrey;
}
/* the main element is still too new to depend on for important styling--
   see the section element for what alternatively could be here */
main {
    
}
aside {
    float: left;
    width: 200px;
}
section {
    float: left;
    width: 550px;
}
footer {
    clear: both;
    border-top: 2px solid black;
}
footer p {
    text-align: right;
    font-size: 80%;
}
h1 {
    font-size: 150%;
    margin: .5em 0;
}
h2 {
    font-size: 120%;
    margin: .25em 0 .5em 0;
}
h1, h2 {
    color: rgb(208, 133, 4);
}
ul {
    list-style-type: none;
    padding-left: 0;
    padding-bottom: 1em;
}

li {
    padding-bottom: 0.5em;
}

li.horizontal {
  display: inline;
}

br {
    clear: left;
}
table {
    border: 1px solid black;
    border-collapse: collapse;
    margin-bottom: 1em;
}
td, th {
    border: 1px dashed black;
    padding: .2em .5em .2em .5em;
    text-align: left;
}
form {

}
.auto {
    display: inline-block;
  }

.not_auto {
    display: none;
}

fieldset.doser-border {
    border: 1px groove #ddd !important;
    padding: 0 1.4em 1.4em 1.4em !important;
    margin: 0 0 1.5em 0 !important;
    -webkit-box-shadow:  0px 0px 0px 0px #000;
            box-shadow:  0px 0px 0px 0px #000;
}

legend.doser-border {
    width:inherit; /* Or auto */
    padding:0 10px; /* To give a bit of padding on the left and right */
    border-bottom:none;
}
./landingpage.php
<?php include 'view/header.php'; ?>
<?php /*session_start();*/ ?>
<?php /*if(!isset($_SESSION['firstname'])) :
        include '../index.php';
        exit();
      endif;*/
?>

<main>
    <section>
        
<table border='0' style='width:95%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Welcome to the RelayShield web app!</h1>
      </td>
    </tr>
    <tr>
      <td>

            <p>You may navigate through the rest of the app using the menu (to your left).</p>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include 'view/footer.php'; ?>

./registration.php
<?php include 'view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:60%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">User Registration</h1>
      </td>
    </tr>
    <tr>
      <td>

 <form id="registration" name="registration" action="index.php" method="post">
          <input type="hidden" name="action" value="add_user">
          <fieldset>
            <legend>User Registration</legend>

            <pre><?php echo $registration_message; ?></pre>
            <p>
              <label for="firstname"><span>First Name:</span></label>
              <input type="text" id="firstname" name="firstname" required/>
            </p>
            <p>
              <label for="lastname"><span>Last Name:</span></label>
              <input type="text" id="lastname" name="lastname" />
            </p>
            <p>
              <label for="email"><span>Email:</span></label>
              <input type="email" id="email" name="email" required/>
            </p>
            <p>
              <label for="username"><span>username:</span></label>
              <input type="text" id="username" name="username" required />
            </p>
            <p>
              <label for="password"><span>password:</span></label>
              <input type="password" id="password" name="password" oninput="(password.value == confirm_password.value) ? password.setCustomValidity('') : password.setCustomValidity('Passwords do not match.');" required/>
            </p>
            <p>
              <label for="confirm_password"><span>confirm password:</span></label>
              <input type="password" id="confirm_password" name="confirm_password" oninput="(confirm_password.value == password.value) ? confirm_password.setCustomValidity('') : confirm_password.setCustomValidity('Passwords do not match.');" required/>
            </p>
              <button type="submit">Submit</button>
              <button onclick="this.form.action.value='login'; this.form.submit()">Cancel</button>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include 'view/footer.php'; ?>

./profile.php
<?php include 'view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:60%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">User Registration</h1>
      </td>
    </tr>
    <tr>
      <td>

 <form id="profile" name="profile" action="index.php" method="post">
          <input type="hidden" name="action" value="update_profile">
	  <input type="hidden" name="old_profile" value='<?php echo serialize($user); ?>'>
          <fieldset>
            <legend>User Profile</legend>

            <pre><?php echo $profile_message; ?></pre>
            <p>
              <label for="profile_firstname"><span>First Name:</span></label>
              <input type="text" id="profile_firstname" name="profile_firstname" value='<?php echo $user['firstname'];?>' >
            </p>
            <p>
              <label for="profile_lastname"><span>Last Name:</span></label>
              <input type="text" id="profile_lastname" name="profile_lastname" value='<?php echo $user['lastname'];?>' >
            </p>
            <p>
              <label for="profile_email"><span>Email:</span></label>
              <input type="email" id="profile_email" name="profile_email" value='<?php echo $user['email'];?>' >
            </p>
            <p>
              <label for="profile_username"><span>username:</span></label>
              <input type="text" id="profile_username" name="profile_username" value='<?php echo $user['username'];?>' disabled >
            </p>
            <p>
              <label for="profile_password"><span>password:</span></label>
              <input type="password" id="profile_password" name="profile_password" oninput="(password.value == confirm_password.value) ? password.setCustomValidity('') : password.setCustomValidity('Passwords do not match.');" >
            </p>
            <p>
              <label for="profile_confirm_password"><span>confirm password:</span></label>
              <input type="password" id="profile_confirm_password" name="profile_confirm_password" oninput="(profile_confirm_password.value == profile_password.value) ? profile_confirm_password.setCustomValidity('') : profile_confirm_password.setCustomValidity('Passwords do not match.');" >
            </p>
              <button type="submit">Update</button>
              <button onclick="this.form.action.value='login'; this.form.submit()">Cancel</button>
            </p>
	    <p><button onclick="this.form.action.value='delete_profile'; this.form.submit()">Delete Profile</button></p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include 'view/footer.php'; ?>

./operator/index.php
<?php
require('../model/rsusers.php');
require('../model/rsgroups.php');
require('../model/rsdevices.php');
require('../model/rsdatabase.php');
require('../model/rsfacilities.php');
require('../model/rshousekeepinglog.php');
require('../model/rsdevicefacilitymatches.php');
require('../model/rsfacilitygroupmemberships.php');

$action = filter_input(INPUT_POST, 'action');
if ($action == NULL) {
    $action = filter_input(INPUT_GET, 'action');
    if ($action == NULL) {
        $action = 'load_facility';
    }
}

if ($action == 'load_facility') {
    $user_facility = unserialize(base64_decode(filter_input(INPUT_GET, 'user_facility')));
    include('facility.php');
} else { echo "Something's wrong!"; }

?>
./operator/facility.php
<?php include '../view/header.php'; ?>
<?php /*if(!$_SESSION['firstname']) :
 	include '../index.php');
	exit();
      endif;*/
?>
<main>
<section>

<table border='0' style='width:95%' align="center">
  <thead><?php $user_facility = unserialize(base64_decode(filter_input(INPUT_GET, 'user_facility'))); ?></thead>
  <tbody>
    <tr>
      <td><h1 align="center"><?php echo $user_facility['facility']; ?></h1></td>
    </tr>
    <tr>
      <td><?php $submitAll = '' ?>
      <?php for($i = 1; $i <= (int)$user_facility['relays']; $i++) : ?>
        <form id="<?php echo('tank' . $i); ?>" name="<?php echo('tank' . $i); ?>" class="form-inline">
          <fieldset>
          <input type="hidden" id="<?php echo('device' . $i); ?>" name="device" value="<?php echo($user_facility['device']); ?>">
          <input type="hidden" id="<?php echo('token' . $i); ?>" name="token" value="<?php echo($user_facility['token']); ?>">
            <legend><?php echo('Tank #' . $i); ?></legend>
            <pre id="<?php echo('log' . $i); ?>">Status: updating...</pre>
            <div id="<?php echo('radios' . $i); ?>" onclick="<?php echo('nextPage(' . $i . ')'); ?>">
              <input type="radio" id="doserType1" name="automan" value="auto">
              <label for="doserType1">Auto</label>
              <input type="radio" id="doserType2" name="automan" value="manual">
              <label for="doserType2">Manual</label>
            </div>
            <div id="<?php echo('details' . $i); ?>" style="display:none">
              <label for="duration">Duration:</label>
              <input type="number" id="duration" name="duration" min="1" max="99999" size="5" placeholder="...seconds" style="width:100px" required>
              <div class="not_auto" id="<?php echo('not_auto_' . $i); ?>">
                <label for="interval">Interval:</label>
                <input type="number" id="<?php echo('_interval' . $i); ?>" name="_interval" oninput="_interval.min = Math.ceil(duration.value/60);" max="99999" size="5" placeholder="...minutes" style="width:100px">
              </div>
              <button type="submit">Submit</button>
              <button type="reset" onclick="<?php echo('prevPage(' . $i . ')'); ?>">Reset</button>
            </div>
          </fieldset>
        </form>
	<?php  $submitAll .= 'javascript:document.getElementById(\'tank' . $i . '\').dispatchEvent(new Event(\'submit\')); ' ?>
        <?php endfor; ?>
      </td>
    </tr><tr><td style="text-align:center; vertical-align:middle;"><button onclick="<?php echo $submitAll ?>" > Submit All! </button> | <button onclick="cancelAll('<?php echo($user_facility['device']); ?>', '<?php echo($user_facility['token']); ?>', '<?php echo($user_facility['relays']); ?>');" > Cancel All! </button></td></tr>
  </tbody>
</table>
</section>
</main>
<?php include '../view/footer.php'; ?>
./facility.js.bak
/*
 * Custom JS code to run the front-end UI for the RelayShield
 * @author JPK
 * @version 2.0
 *
 */

// capture up to 4 forms
var forms = document.querySelectorAll("form");

// submit & cancel all
var submitAllButton = document.querySelector("#submitAll");

// add an event listener on each form
for (i = 1; i <= forms.length; i++) {
  const RELAYNUM = i;
  let targetForm = document.querySelector("#tank" + RELAYNUM);
  let targetLog = document.querySelector("#log" + RELAYNUM);

  if (targetForm) {

//         .then(response => { let rStatus = response; console.log('rStatus: %o', rStatus); targetLog.textContent = (rStatus.text()) ? "Status: Busy. Please wait or cancel!" : "Status: Idle."; });

	
//	console.log('rStatus: %o', rStatus);
//	targetLog.textContent = (rStatus === true) ? "Status: Busy. Please wait or cancel!" : "Status: Idle.";

    //onsubmit event listener
    targetForm.addEventListener("submit", function(event) {
      let data = new FormData(targetForm);
      let output = "Status: ";
      let deviceID = "";
      let access_token = "";

      // format data for submission and for the status bar
      for (const entry of data) {
        if (entry[0] === "device") deviceID = entry[1];
        if (entry[0] === "token") access_token = entry[1];
        if (entry[1] === "auto") {
          data.arg = "t:" + RELAYNUM + ",";
          output += "(" + entry[1] + ") ";
        } else if (entry[1] === "manual") {
          data.arg = "c:" + RELAYNUM + ",";
          output += "(" + entry[1] + ") ";
        }

        if (entry[0] === "duration") {
          data.arg += entry[1];
          output += entry[1] + " second" + (entry[1] > 1 ? "s" : "");
          if (data.arg[0] === "c") {
            data.arg += ";";
            output += ".";
          }
        } else if (entry[0] === "_interval" && data.arg[0] === "t") {
          data.arg += "," + entry[1] + ";";
          output +=
            " every " + entry[1] + " minute" + (entry[1] > 1 ? "s" : "") + ".";
        }
      }

      // updates the status bar
      targetLog.textContent = output;

      // the intermittent cancel button
      let cancelButton =
        '\t<button onclick="cancelRun(' + RELAYNUM + ', \'' + deviceID + '\', \'' + access_token + '\');">Cancel!</button>';

      if (data.arg.startsWith("t"))
        targetLog.insertAdjacentHTML("beforeend", cancelButton);
      event.preventDefault();

      // on-submit
      fetch(
        "https:\/\/api.particle.io/v1/devices/" +
          deviceID +
          "/relay?access_token=" +
          access_token,
        {
          method: "POST",
          mode: "cors",
          body: JSON.stringify(data),
          headers: new Headers({ "Content-Type": "application/json" })
        }
      )
        .then(res => res.json())
        .catch(error => console.error("Error:", error))
        .then(response => {
          targetForm.reset();
	  console.log("Returned: ", response);
          prevPage(RELAYNUM);
        });
    });

	// prodding the RS for status
      fetch(
        "https:\/\/api.particle.io/v1/devices/" +
          document.querySelector("#device" + RELAYNUM).value + 
          "/rBusy" + RELAYNUM + "?access_token=" +
          document.querySelector("#token" + RELAYNUM).value + "&format=raw"
      )
         .then(response => response.text().then(text => { // targetLog.textContent = (text === 'true') ? "Status: busy, please wait or cancel!" : "Status: idle."; 
								if (text == 'true') {
									targetLog.textContent = "Status: busy, please wait or cancel!";
									disable_form(targetForm);
									prevPage(RELAYNUM);
								} else {
									targetLog.textContent = "Status: idle.";
									enable_form(targetForm);
									prevPage(RELAYNUM);
								}
								// reloadById("#tank" + RELAYNUM);
							}))// .then(() => { reloadById("#tank" + RELAYNUM); }) )
         .catch(error => console.error("Error:", error));

  } else {
    // console.log("targetForm is null!");
  }


}

// "paginates" the form, shows next form page
function nextPage(z) {
  document.getElementById("radios" + z).style.display = "none";
  if (document.getElementById("tank" + z)["automan"].value == "auto") {
    document.getElementById("not_auto_" + z).className = "auto";
    document.getElementById("_interval" + z).required = true;
  } else {
    document.getElementById("not_auto_" + z).className = "not_auto";
    document.getElementById("_interval" + z).required = false;
  }
  document.getElementById("details" + z).style.display = "inline-block";
}

// shows previous form page
function prevPage(z) {
  document.getElementById("radios" + z).style.display = "inline-block";
  document.getElementById("details" + z).style.display = "none";
}

// cancels an auto run
function cancelRun(r, devID, aToken) {
  // let deviceId =  - make cancelRun a part of the eventListener. TODO.
  fetch(
    "https:\/\/api.particle.io/v1/devices/" + devID + "/relay?access_token=" + aToken,
    {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({ arg: "x:" + r + ";" }),
      headers: new Headers({ "Content-Type": "application/json" })
    }
  )
    .then(res => res.json())
    .catch(error => console.error("Error:", error))
    .then(response => console.log("Success:", response));
  prevPage(r);
  document.querySelector("#log" + r).textContent = "Status: Run cancelled.";
}

function multiSubmit() {
        for (i = 1; i <= forms.length; i++) {
                document.getElementById("tank" + i).submit();
        }
}

// cancels all runs
function cancelAll(devID, aToken, relays) {
  // let deviceId =  - make cancelRun a part of the eventListener. TODO.
  fetch(
    "https://api.particle.io/v1/devices/" + devID + "/relay?access_token=" + aToken,
    {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({ arg: "x:9;" }),
      headers: new Headers({ "Content-Type": "application/json" })
    }
  )
    .then(res => res.json())
    .catch(error => console.error("Error:", error))
    .then(response => console.log("Success:", response));
  prevPages(relays);
  // document.querySelector("#log" + r).textContent = "Status: Run cancelled.";
}

// shows previous form pages
function prevPages(z) {
  for (k = 1; k <= z; k++) {
    document.getElementById("radios" + k).style.display = "inline-block";
    document.getElementById("details" + k).style.display = "none";
    document.querySelector("#log" + k).textContent = "Status: Run cancelled.";
  }
}

// The polling function
function poll(fn, timeout, interval) {
  var dfd = new Deferred();
  var endTime = Number(new Date()) + (timeout || 2000);
  interval = interval || 100;

  (function p() {
    // If the condition is met, we're done!
    if (fn()) {
      dfd.resolve();
    }
    // If the condition isn't met but the timeout hasn't elapsed, go again
    else if (Number(new Date()) < endTime) {
      setTimeout(p, interval);
    }
    // Didn't match and too much time, reject!
    else {
      dfd.reject(new Error('timed out for ' + fn + ': ' + arguments));
    }
  })();

  return dfd.promise;
}

/*
 * Disables and enables every input, textarea, button and select elements inside
 * a form-element.
 *
 * Enhanced by JPK (Originally by Magnus Fredlundh)
 */

// Disables a form.
function disable_form(form) {
  var inputs = form.getElementsByTagName('input'),
      textareas = form.getElementsByTagName('textarea'),
      buttons = form.getElementsByTagName('button'),
      selects = form.getElementsByTagName('select');

  disable_elements(inputs);
  disable_elements(textareas);
  disable_elements(buttons);
  disable_elements(selects);
}

// Disables a collection of form-elements.
function disable_elements(elements) {
  var length = elements.length;
  while(length--) {
    elements[length].disabled = true;
  }
}

// Enables a (previously disabled) form.
function enable_form(form) {
  var inputs = form.getElementsByTagName('input'),
      textareas = form.getElementsByTagName('textarea'),
      buttons = form.getElementsByTagName('button'),
      selects = form.getElementsByTagName('select');

  enable_elements(inputs);
  enable_elements(textareas);
  enable_elements(buttons);
  enable_elements(selects);
}

// Enables a collection of form-elements.
function enable_elements(elements) {
  var length = elements.length;
  while(length--) {
    elements[length].disabled = false;
  }
}

function reloadById(theId){
    let container = document.querySelector(theId);
    let content = container.innerHTML;
    container.innerHTML = content; 
    
   //this line is to watch the result in console , you can remove it later	
    console.log("Refreshed"); 
}
./index.php
<?php

 session_start();
 
 require('model/rsusers.php');
 require('model/rsdatabase.php');
 require('model/rshousekeepinglog.php');

$action = filter_input(INPUT_POST, 'action');
if ($action == NULL) {
    $action = filter_input(INPUT_GET, 'action');
    if ($action == NULL) {
        $action = 'login';
    }
}

if ($action == 'login') {
    include('login.php');
} elseif ($action == 'sign_in') {
$username = filter_input(INPUT_POST, 'login_username');
if ($username == NULL) {
    $username = filter_input(INPUT_GET, 'login_username');
    if ($username == NULL) {
        echo('$username is blank!');
    }
}
// TODO: use password_hash($password, PASSWORD_BCRYPT, ['cost' => 10]);
$password = filter_input(INPUT_POST, 'login_password');
if ($password == NULL) {
    $password = filter_input(INPUT_GET, 'login_password');
    if ($password == NULL) {
        echo('$password is blank!');
    }
}

// $encryptedpassword = $password ? password_hash($password, PASSWORD_BCRYPT) : '';

    try {
        $successful_login = user_login($db, $username, $password);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('errors/database_error.php');
        exit();
    }
    if($successful_login) {
        //test to see if user an admin/not
	$user = get_user_by_name($db, $username);
	$_SESSION['user'] = $user;
	$_SESSION['firstname'] = $user['firstname'];
	$_SESSION['usertypeid'] = $user['usertypeid'];
	$_SESSION['username'] = $user['username'];
        include('login.php'); // include('admins/facility/index.php'); // include('users');
    } else {
        echo('Login not successful...' . $encryptedpassword);
        $login_message = 'Login not successful...';
        include('login.php');
    }
} elseif ($action == 'logout') {
    unset($_SESSION['firstname']);
    unset($_SESSION['usertypeid']);
    unset($_SESSION['username']);
    include('login.php');
} elseif ($action == 'registration') {
    include('registration.php');
} elseif ($action == 'add_user') {
$firstname = filter_input(INPUT_POST, 'firstname');
if ($firstname == NULL) {
    $firstname = filter_input(INPUT_GET, 'firstname');
    if ($firstname == NULL) {
        echo('$firstname is blank!');
    }
}

$lastname = filter_input(INPUT_POST, 'lastname');
if ($lastname == NULL) {
    $lastname = filter_input(INPUT_GET, 'lastname');
    if ($lastname == NULL) {
        echo('$lastname is blank!');
    }
}
$email = filter_input(INPUT_POST, 'email');
if ($email == NULL) {
    $email = filter_input(INPUT_GET, 'email');
    if ($email == NULL) {
        echo('$email is blank!');
    }
}

$username = filter_input(INPUT_POST, 'username');
if ($username == NULL) {
    $username = filter_input(INPUT_GET, 'username');
    if ($username == NULL) {
        echo('$username is blank!');
    }
}
$password = filter_input(INPUT_POST, 'password');
if ($password == NULL) {
    $password = filter_input(INPUT_GET, 'password');
    if ($password == NULL) {
        echo('$password is blank!');
    }
}

$encryptedpassword = $password ? password_hash($password, PASSWORD_BCRYPT) : '';

$confirm_password = filter_input(INPUT_POST, 'confirm_password');
if ($confirm_password == NULL) {
    $confirm_password = filter_input(INPUT_GET, 'confirm_password');
    if ($confirm_password == NULL) {
        echo('$confirm_password is blank!');
    }
}
    try {
        $successful_registration = add_user($db, $firstname, $lastname, $email, $username, $encryptedpassword, (int)1, (int)0);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    if($successful_registration){
        $login_message = 'User registration successful...';
        include('login.php');
    } else {
        $registration_message = 'User registration NOT successful...';
        include('registration.php');
    }
} elseif ($action == 'recovery') {
    include('passwdrecovery.php');
} elseif ($action == 'recover_password') {
$recovery_email = filter_input(INPUT_POST, 'recovery_email');
if ($recovery_email == NULL) {
    $recovery_email = filter_input(INPUT_GET, 'recovery_email');
    if ($recovery_email == NULL) {
        echo('$recovery_email is blank!');
    }
}

    try {
        $recovery_successful = recover_password($db, $recovery_email);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    if($recovery_successful) {
        $recovery_message='Password Recovery successful... please check your email...';
        include('login.php');
    } else {
        $recovery_message='Password Recovery unsuccessful... please try again.';
        include('passwdrecovery.php');
    }
} elseif ($action == 'edit_profile') {
$recovery_email = filter_input(INPUT_POST, 'recovery_email');

    try {
	$user = get_user_by_name($db, $_SESSION['username']); 
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    include('profile.php');
} elseif ($action == 'update_profile') {
$old_profile = unserialize(filter_input(INPUT_POST, 'old_profile'));
if ($old_profile == NULL) {
    $old_profile = unserialize(filter_input(INPUT_GET, 'old_profile'));
    if ($old_profile == NULL) {
        echo("Nothing came through for old_profile");
    }
}

$profile_firstname = filter_input(INPUT_POST, 'profile_firstname');
if ($profile_firstname == NULL) {
    $profile_firstname = filter_input(INPUT_GET, 'profile_firstname');
    if ($profile_firstname == NULL) {
        echo('$profile_firstname is blank!');
    }
}

$profile_lastname = filter_input(INPUT_POST, 'profile_lastname');
if ($profile_lastname == NULL) {
    $profile_lastname = filter_input(INPUT_GET, 'profile_lastname');
    if ($profile_lastname == NULL) {
        echo('$profile_lastname is blank!');
    }
}
$profile_email = filter_input(INPUT_POST, 'profile_email');
if ($profile_email == NULL) {
    $profile_email = filter_input(INPUT_GET, 'profile_email');
    if ($profile_email == NULL) {
        echo('$profile_email is blank!');
    }
}

$profile_username = filter_input(INPUT_POST, 'profile_username');
if ($profile_username == NULL) {
    $profile_username = filter_input(INPUT_GET, 'profile_username');
    if ($profile_username == NULL) {
        echo('$profile_username is blank!');
    }
}
// TODO: use password_hash($profile_password, PASSWORD_BCRYPT, ['cost' => 10]);
$profile_password = filter_input(INPUT_POST, 'profile_password');
if ($profile_password == NULL) {
    $profile_password = filter_input(INPUT_GET, 'profile_password');
    if ($profile_password == NULL) {
        echo('$profile_password is blank!');
    }
}

$profile_encryptedpassword = $profile_password ? password_hash($profile_password, PASSWORD_BCRYPT) : '';

$profile_confirm_password = filter_input(INPUT_POST, 'profile_confirm_password');
if ($profile_confirm_password == NULL) {
    $profile_confirm_password = filter_input(INPUT_GET, 'profile_confirm_password');
    if ($profile_confirm_password == NULL) {
        echo('$profile_confirm_password is blank!');
    }
}

    try {
	if($profile_firstname || $profile_lastname || $profile_email || $profile_password) {
	    update_user($db, $profile_firstname, $profile_lastname, $profile_email, $profile_password, $old_profile);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'delete_profile') {
//    include
} elseif ($action == 'profile_delete') {
$recovery_email = filter_input(INPUT_POST, 'recovery_email');
if ($recovery_email == NULL) {
    $recovery_email = filter_input(INPUT_GET, 'recovery_email');
    if ($recovery_email == NULL) {
        echo('$recovery_email is blank!');
    }
}

    try {
        $recovery_successful = recover_password($db, $recovery_email);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    if($recovery_successful) {
        $recovery_message='Password Recovery successful... please check your email...';
        include('login.php');
    } else {
        $recovery_message='Password Recovery unsuccessful... please try again.';
        include('passwdrecovery.php');
    }
} else { echo "Something's wrong!"; }

?>

./jpkrelayshield.ino
// This #include statement was automatically added by the Particle IDE.
#include <RelayShield.h>

/*
 * Custom code to run a 4-switch relay shield
 * @author JPK
 * @version 2.0
 * @name jpkrelayshield.ino
 *
 *
 */
 
RelayShield jpkRelays;

int rDuration[5] = {-1, -1, -1, -1, -1}; // initializing the duration parameter for all relays
int rInterval[5] = {-1, -1, -1, -1, -1}; // initializing the interval parameter for all relays
int rCount[5] = {0, 0, 0, 0, 0};         // initializing the count parameter for all relays, used to handle one-off's
uint32_t rNow[5] = {0, 0, 0, 0, 0};      // initializing the now parameter (a relative temporal notion) for all relays 

void setup() {
    // initializing the relays to use relayShield lib
    jpkRelays.begin();
    
    // function to handle REST call
    Particle.function("relay", handleCall);
    
    // TODO: function to send out REST call once an instruction is complete
    
}

void loop() {
    
    // keeps executing any change in status for a relay
    relayIdling(1);
    relayIdling(2);
    relayIdling(3);
    relayIdling(4);

}

//function to handle input from the REST call/form submission
int handleCall(String incomingData) {
  // Supports 3 strings:
  // "t:relay#,sec,min;"    Runs sec seconds every min minutes on relay#
  // "c:relay#,sec;"        Runs a one-ff for sec seconds on relay#
  // "x:[relay#];"          Cancels current run on relay# or all relays if left blank -- TODO.
  
  char cmd=0x00;    //  [tcx]
  int curIdx=0;
  int relayNum;    //  [1234]
  int exitStatus = 0;
  char secStr[16];  //  [0...99999] - up to 1 day
  char minStr[16];  //  [0...99999] - up to 1 month
  
  //parse incomingData
  curIdx=0;
  cmd=incomingData.charAt(curIdx);    //get cmd char
  curIdx=2;
  relayNum=(int)incomingData.charAt(curIdx) - 48; // get relayNum (less ASCII 0 = 48)
  curIdx=4;   //skip cmd, :, relay# and ,
  
  switch (cmd)
  {
    case 'x':
      exitStatus = stopRelay(relayNum);
      break;

    case 'c':
      curIdx=getNextVal(incomingData,curIdx,';',secStr);     //get second ; term
      if(rDuration[relayNum] == -1) { // prevents interruption of busy relay
          rDuration[relayNum] = atoi(secStr);
          exitStatus = 1;
      } else { exitStatus = 2; }
      break;

    case 't':
      //timer1
      curIdx=getNextVal(incomingData,curIdx,',',secStr);     //get second , term
      curIdx=getNextVal(incomingData,curIdx,';',minStr);     //get min ; term
      if(rDuration[relayNum] == -1) { // prevents interruption of busy relay
          rDuration[relayNum] = atoi(secStr);
          rInterval[relayNum] = atoi(minStr);
          exitStatus = 1;
      } else { exitStatus = 2; }
      break;
  }
  
  return exitStatus;
}

// function to respond to the change in a relay's parameters
void relayIdling(int r) {
    if(rDuration[r] != -1) {  // if a duration value has been submitted...
        if(millis() > (rNow[r] + rDuration[r] * 1000)) { // setting up the timing mechanism
            if(rCount[r] == 0) { // ensures one run of this code block
                rNow[r] = millis(); // calibrating the relay's temporal frame of ref
                jpkRelays.on(r);
                rCount[r]++; // increment the cycle count
            } else { // this is not the first run, i.e. the first run has completed
                if(jpkRelays.isOn(r) == true) { 
                    jpkRelays.off(r); 
                }
                if(rInterval[r] != -1) { // if an interval was submitted, i.e. it is an autonomous run...
                    if(millis() > (rNow[r] + rInterval[r] * 60000)) { // is it time to repeat the cycle?
                        rNow[r] = millis();
                        if(jpkRelays.isOn(r) == false) jpkRelays.on(r);
                    }
                    rCount[r]++; // increment the cycle count
                } else { // else interval was not set and this is a one-ff
                    stopRelay(r);
                    // rDuration[r] = -1;
                    // rCount[r] = 0;
                    // rNow[r] = 0;
                }
            }
            
        } // else the relay is still running, check back again shortly
        
    } // else continue to idle/do nothing
    
}

// StopRelay Helper function
int stopRelay(int relayNo) {
    if(relayNo != NULL) {
        jpkRelays.off(relayNo);
        rDuration[relayNo] = -1;
        rInterval[relayNo] = -1;
        rCount[relayNo] = 0;
        rNow[relayNo] = 0;
        return relayNo + 10;
    } else {
        jpkRelays.allOff();
        for (int j = 0; j < 5; j++) {
            rDuration[j] = -1;
            rInterval[j] = -1;
            rCount[j] = 0;
            rNow[j] = 0;
        }
        return 15;
    }
}

// parse input Helper function
int getNextVal(String data, int off, char term, char *val)
{
  //given a String and a beginning offset and a terminator character, returns the val as a char *,
  //and returns the idx of the NEXT offset (skipping the terminator)
  //if return val -1, not found

  int endOff;
  String valStr;

  //find next terminator char
  endOff=data.indexOf(term,off);
  if (endOff == -1)
  {
    return -1;
  }
  //copy string and convert to char *
  valStr=data.substring(off,endOff);
  valStr.toCharArray(val,valStr.length()+1);    //add 1 for null term
  return endOff+1;
}
./admins/user/index.jpk.txt
<?php

 require('../../model/rsusers.php');
 require('../../model/rsgroups.php');
 require('../../model/rsdevices.php');
 require('../../model/rsdatabase.php');
 require('../../model/rsfacilities.php');
 require('../../model/rsgroupusermemberships.php');
 require('../../model/rsdevicefacilitymatches.php');
 require('../../model/rsfacilitygroupmemberships.php');

$action = filter_input(INPUT_POST, 'action');
if ($action == NULL) {
    $action = filter_input(INPUT_GET, 'action');
    if ($action == NULL) {
        $action = 'facility_list';
    }
}

if ($action == 'facility_list') {
    $filter = filter_input(INPUT_POST, 'filter', FILTER_SANITIZE_STRING);
    if($filter == NULL) {
	$filter = filter_input(INPUT_POST, 'filter', FILTER_SANITIZE_STRING);
	if($filter == NULL) {
	    $filter = 'all';
	}
    }
    try {
	if($filter == "active")
	   $all_facs = get_active_facilities_list($db);
	else
	   $all_facs = get_facilities_list($db);
    } catch (PDOException $e) {
      $error_message = $e->getMessage(); 
      include('../../errors/database_error.php');
      exit();
    }
    include('list.php');
} elseif ($action == 'new_facility') {
    try {
        $available_devices = get_all_available_devices($db);
        $groups = get_all_groups($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');    
        exit();
    }
    include('new.php');
} elseif ($action == 'edit_facility') {
    // beware the input char '#', it messes up the serialization.
    $facility = unserialize(filter_input(INPUT_GET, 'facility'));
    try {
	$facility_id = (int)get_facility_id($db, $facility['facility']);
	$facility_device_id = (int)get_device_id($db, $facility['device']);
	$facility_groups = get_groups_by_facility($db, $facility_id);
        $available_devices = get_all_available_devices($db);
        $groups = get_all_groups($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    include('edit.php');
} elseif ($action == 'add_facility') {
$new_facility_name = filter_input(INPUT_POST, 'new_facility_name');
if ($new_facility_name == NULL) {
    $new_facility_name = filter_input(INPUT_GET, 'new_facility_name');
    if ($new_facility_name == NULL) {
        echo("Nothing came through for new_facility_name");
    }
}

$new_facility_relay = filter_input(INPUT_POST, 'new_facility_relays');
if ($new_facility_relay == NULL) {
    $new_facility_relay = filter_input(INPUT_GET, 'new_facility_relays');
    if ($new_facility_relay == NULL) {
        echo("Nothing came through for new_facility_relay");
    }
}

$new_facility_status = filter_input(INPUT_POST, 'new_facility_status', FILTER_VALIDATE_BOOLEAN);
if ($new_facility_status == NULL) {
    $new_facility_status = filter_input(INPUT_GET, 'new_facility_status', FILTER_VALIDATE_BOOLEAN);
    if ($new_facility_status == NULL) {
        echo("Nothing came through for new_facility_status");
	$new_facility_status = 0;
    }
}

$new_facility_device_id = filter_input(INPUT_POST, 'new_facility_device_id');
if ($new_facility_device_id == NULL) {
    $new_facility_device_id = filter_input(INPUT_GET, 'new_facility_device_id');
    if ($new_facility_device_id == NULL) {
        echo("Nothing came through for new_facility_device_id");
    }
}

$new_facility_group_ids = filter_input(INPUT_POST, 'new_facility_group_ids', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
if ($new_facility_group_ids == NULL) {
    $new_facility_group_ids = filter_input(INPUT_GET, 'new_facility_group_ids', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
    if ($new_facility_group_ids == NULL) {
        echo("Nothing came through for new_facility_group_ids");
    }
}

    try {
        add_facility($db, $new_facility_name, (int)$new_facility_relay, (int)$new_facility_status);
	add_device_facility($db, (int)$new_facility_device_id, get_facility_id($db, $new_facility_name));
	$new_facility_id = (int)get_facility_id($db, $new_facility_name);
	foreach ($new_facility_group_ids as $new_facility_group_id) {
            add_facility_group($db, $new_facility_id, (int)$new_facility_group_id);
        }
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'update_facility') {
$old_facility = unserialize(filter_input(INPUT_POST, 'old_fac_less_grps'));
if ($old_facility == NULL) {
    $old_facility = unserialize(filter_input(INPUT_GET, 'old_fac_less_grps'));
    if ($old_facility == NULL) {
        echo("Nothing came through for old_facility");
    }
}

$old_facility_groups = unserialize(filter_input(INPUT_POST, 'old_facility_groups'));
if ($old_facility_groups == NULL) {
    $old_facility_groups = unserialize(filter_input(INPUT_GET, 'old_facility_groups'));
    if ($old_facility_groups == NULL) {
        echo("Nothing came through for old_facility_groups");
    }
}

$edit_facility_name = filter_input(INPUT_POST, 'edit_facility_name');
if ($edit_facility_name == NULL) {
    $edit_facility_name = filter_input(INPUT_GET, 'edit_facility_name');
    if ($edit_facility_name == NULL) {
        echo("Nothing came through for edit_facility_name");
    }
}

$edit_facility_relays = filter_input(INPUT_POST, 'edit_facility_relays');
if ($edit_facility_relays == NULL) {
    $edit_facility_relays = filter_input(INPUT_GET, 'edit_facility_relays');
    if ($edit_facility_relays == NULL) {
        echo("Nothing came through for edit_facility_relays");
    }
}

$edit_facility_status = filter_input(INPUT_POST, 'edit_facility_status', FILTER_VALIDATE_BOOLEAN);
if ($edit_facility_status == NULL) {
    $edit_facility_status = filter_input(INPUT_GET, 'edit_facility_status', FILTER_VALIDATE_BOOLEAN);
    if ($edit_facility_status == NULL) {
        echo("Nothing came through for edit_facility_status");
	$edit_facility_status = 0;
    }
}

$edit_device_id = filter_input(INPUT_POST, 'edit_facility_device_id');
if ($edit_device_id == NULL) {
    $edit_device_id = filter_input(INPUT_GET, 'edit_facility_device_id');
    if ($edit_device_id == NULL) {
        echo("Nothing came through for edit_device_id");
    }
}

$edit_facility_group_ids = filter_input(INPUT_POST, 'edit_facility_groups', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
if ($edit_facility_group_ids == NULL) {
    $edit_facility_group_ids = filter_input(INPUT_GET, 'edit_facility_groups', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
    if ($edit_facility_group_ids == NULL) {
        echo("Nothing came through for edit_facility_groups");
    }
}

    try {
	if($old_facility['facility'] != $edit_facility_name || $old_facility['relays'] != $edit_facility_relays || $old_facility['status'] != $edit_facility_status) {
            update_facility($db, $edit_facility_name, $edit_facility_relays, $edit_facility_status, get_facility_by_name($db, $old_facility['facility']));
	}

	$old_device_id = (int)get_device_id($db, $old_facility['device']);

	if ($old_device_id != $edit_device_id) {
	    update_device_facility($db, (int)$edit_device_id, (int)get_facility_id($db, $edit_facility_name));
	}
	$fac_id_to_edit = (int)get_facility_id($db, ($edit_facility_name ? $edit_facility_name : $old_facility['facility']));
	if ($edit_facility_group_ids && $old_facility_groups) {
	    $groups_to_del = array_diff($old_facility_groups, $edit_facility_group_ids);
	    $groups_to_add = array_diff($edit_facility_group_ids, $old_facility_groups);
	} elseif ($old_facility_groups && !$edit_facility_group_ids) {
	    $groups_to_del = $old_facility_groups;
	    $groups_to_add = [];
	} elseif ($edit_facility_group_ids && !$old_facility_groups) {
	    $groups_to_del = [];
	    $groups_to_add = $edit_facility_group_ids;
	} else {
	    $groups_to_del = [];
	    $groups_to_add = [];
	}
	foreach ($groups_to_del as $grp_to_del) {
	   delete_facility_group($db, $fac_id_to_edit, $grp_to_del);
	}
	foreach ($groups_to_add as $grp_to_add) {
	    add_facility_group($db, $fac_id_to_edit, $grp_to_add);
	    echo('Added group ' . $grp_to_add);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'delete_facility') {
$delete_facility = unserialize(filter_input(INPUT_POST, 'delete_facility'));
if ($delete_facility == NULL) {
    $delete_facility = unserialize(filter_input(INPUT_GET, 'delete_facility'));
    if ($delete_facility == NULL) {
        echo("Nothing came through for delete_facility");
    }
}

    try {
	if($delete_facility) {
	    $fac_id_to_del = get_facility_id($db, $delete_facility['facility']);
	    $affected_grp_names = "";
	    if($delete_facility['groups'] > 0) {
		$temp_grps = get_groups_by_facility($db, $fac_id_to_del);
		foreach($temp_grps as $temp_grp) {
		    $affected_grp_names .= $temp_grp['groupname'] . "\r\n"; // or PHP_EOL
	        }
	    }
	    delete_facility_groups($db, $fac_id_to_del);
	    delete_dev_fac_by_facility($db, $fac_id_to_del);
	    delete_facility($db, $delete_facility['facility']);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} else { echo "Something's wrong!"; }

?>
./admins/user/list.php
<?php include '../../view/header.php'; ?>
<?php /*session_start();*/ ?>
<?php /*if(!isset($_SESSION['firstname'])) :
        include($app_path);
        exit();
      endif;*/
?>

<main>
    <section>
        
<table border='0' style='width:95%' align='center'>
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="user_deployment" name="user_deployment" action="index.php" method="post">
          <input type="hidden" name="action" value="new_user">
          <fieldset>
            <legend>User Deployment</legend>
            <select name="filter" onchange="this.form.action.value='user_list'; this.form.submit()">
              <option value="none" selected>filter by:</option>
              <option value="all">all</option>
              <option value="active">active</option>
            </select>
            <table border=1>
              <tr>
                <th width="70%">User</th>
                <th>Type</th>
                <th>Groups</th>
		<th style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">Action</th>
              </tr>
              <?php foreach ($all_usrs as $user) : ?>
              <tr>
                <td style='white-space: nowrap; overflow: hidden; max-width: 10px; text-overflow: ellipsis;'>
		<a href='index.php?action=edit_user&user=<?php echo base64_encode(serialize($user)); ?>'>
		<font color='<?php echo $user['status'] ? '' : 'grey' ; ?>' >
                <?php echo $user['_user']; ?>
		</font>
		</a>
		</td>
                <td>
                  <?php echo $user['type']; ?> </td>

                <td>
                  <?php echo $user['groups']; ?>
		</td>
		<td style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">
		  <button name="delete_user" value='<?php echo base64_encode(serialize($user)); ?>' onclick="confirm('Are you sure you want to delete this user?') ? this.form.action.value='delete_user' : this.form.action.value='user_list'; this.form.submit()" >delete</button>
		</td>
              </tr>
              <?php endforeach; ?>
            </table>
            <button type="submit" style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">Add User</button>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/user/edit.php
<?php include '../../view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:60%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

 <form id="edit_user" name="edit_user" action="index.php" method="post">
          <input type="hidden" name="action" value="update_user">
	  <input type="hidden" name="old_usr_less_grps" value='<?php echo base64_encode(serialize($user)); ?>'>
	  <input type="hidden" name="old_user_groups" value='<?php echo base64_encode(serialize($user_groups)) ?>'>
          <fieldset>
            <legend>Edit User</legend>

            <pre><?php echo $edit_user_message; ?></pre>
            <p>
              <label for="edit_user_firstname"><span>First Name:</span></label>
              <input type="text" id="edit_user_firstname" name="edit_user_firstname" value='<?php echo $user['fname'];?>' disabled >
            </p>
            <p>
              <label for="edit_user_lastname"><span>Last Name:</span></label>
              <input type="text" id="edit_user_lastname" name="edit_user_lastname" value='<?php echo $user['lname'];?>' disabled >
            </p>
            <p>
              <label for="edit_user_email"><span>Email:</span></label>
              <input type="email" id="edit_user_email" name="edit_user_email" value='<?php echo $user['email'];?>' disabled >
            </p>
            <p>
              <label for="edit_user_username"><span>username:</span></label>
              <input type="text" id="edit_user_username" name="edit_user_username" value='<?php echo $user['_user'];?>' disabled >
            </p>
	    <p>
		<label for="user_status"><span>Active</span></label>
		<input type="checkbox" id="edit_user_status" name="edit_user_status" <?php echo ($user['status'] ? "checked" : ""); ?> />
	    </p>
	    <p>
		<label for="user_type"><span>User Type:</span></label>
		<select name="edit_user_type">
		    <?php for($j = 1; $j <= 4; $j++) : ?>
			<option value="<?php echo $j; ?>" <?php echo ($user['utypeid'] == $j) ? 'selected' : '' ; ?> ><?php echo $j; ?></option>
		    <?php endfor; ?>
		</select>
	    </p>
	    <p>
		<label for="groups"><span>Group(s):</span></label>
		<select multiple name="edit_user_groups[]">
		    <?php foreach($groups as $group) : ?>
			<option value="<?php  echo $group['id']; ?>" <?php echo in_array($group['id'], $user_groups) ? 'selected' : '' ;?> >
				<?php  echo $group['groupname']; ?>
			</option>
		    <?php endforeach; ?>
		</select>
	    </p>
            <p>
	     <button type="submit">Update</button>
             <button type="reset">Reset</button>
             <a href="index.php">Cancel</a>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/user/registration.php
<?php include '../../view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:60%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

 <form id="new_user" name="new_user" action="index.php" method="post">
          <input type="hidden" name="action" value="add_user">
          <fieldset>
            <legend>User Registration</legend>

            <pre><?php echo $registration_message; ?></pre>
            <p>
              <label for="firstname"><span>First Name:</span></label>
              <input type="text" id="firstname" name="firstname" required/>
            </p>
            <p>
              <label for="lastname"><span>Last Name:</span></label>
              <input type="text" id="lastname" name="lastname" />
            </p>
            <p>
              <label for="email"><span>Email:</span></label>
              <input type="email" id="email" name="email" required/>
            </p>
            <p>
              <label for="username"><span>username:</span></label>
              <input type="text" id="username" name="username" required />
            </p>
            <p>
              <label for="password"><span>password:</span></label>
              <input type="password" id="password" name="password" oninput="(password.value == confirm_password.value) ? password.setCustomValidity('') : password.setCustomValidity('Passwords do not match.');" required/>
            </p>
            <p>
              <label for="confirm_password"><span>confirm password:</span></label>
              <input type="password" id="confirm_password" name="confirm_password" oninput="(confirm_password.value == password.value) ? confirm_password.setCustomValidity('') : confirm_password.setCustomValidity('Passwords do not match.');" required/>
            </p>
	       <button type="submit">Create</button>
              <button type="reset">Reset</button>
              <a href="index.php">Cancel</a>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/user/index.php
<?php

 require('../../model/rsusers.php');
 require('../../model/rsgroups.php');
// require('../../model/rsdevices.php');
 require('../../model/rsdatabase.php');
// require('../../model/rsfacilities.php');
 require('../../model/rshousekeepinglog.php');
 require('../../model/rsdeletedstuff.php');
 require('../../model/rsgroupusermemberships.php');
// require('../../model/rsdevicefacilitymatches.php');
// require('../../model/rsfacilitygroupmemberships.php');

$action = filter_input(INPUT_POST, 'action');
if ($action == NULL) {
    $action = filter_input(INPUT_GET, 'action');
    if ($action == NULL) {
        $action = 'user_list';
    }
}

if ($action == 'user_list') {
    $filter = filter_input(INPUT_POST, 'filter', FILTER_SANITIZE_STRING);
    if($filter == NULL) {
	$filter = filter_input(INPUT_GET, 'filter', FILTER_SANITIZE_STRING);
	if($filter == NULL) {
	    $filter = 'all';
	}
    }
    try {
	if($filter == "active")
	   $all_usrs = get_active_users_list($db);
	else
	   $all_usrs = get_users_list($db);
    } catch (PDOException $e) {
      $error_message = $e->getMessage(); 
      include('../../errors/database_error.php');
      exit();
    }
    include('list.php');
} elseif ($action == 'new_user') {
    include('registration.php');
} elseif ($action == 'edit_user') {
    // beware the input char '#', it messes up the serialization.
    $user = unserialize(base64_decode(filter_input(INPUT_GET, 'user')));
    try {
	$user_id = (int)get_user_id($db, $user['_user']);
	echo('Got userid: ' . $user_id);
	$user_groups = get_groups_by_user($db, $user_id);
	echo('Got ' . $user_groups . ' groups.');
        $groups = get_all_groups($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    include('edit.php');
} elseif ($action == 'add_user') {
$firstname = filter_input(INPUT_POST, 'firstname');
if ($firstname == NULL) {
    $firstname = filter_input(INPUT_GET, 'firstname');
    if ($firstname == NULL) {
        echo('$firstname is blank!');
    }
}

$lastname = filter_input(INPUT_POST, 'lastname');
if ($lastname == NULL) {
    $lastname = filter_input(INPUT_GET, 'lastname');
    if ($lastname == NULL) {
        echo('$lastname is blank!');
    }
}
$email = filter_input(INPUT_POST, 'email');
if ($email == NULL) {
    $email = filter_input(INPUT_GET, 'email');
    if ($email == NULL) {
        echo('$email is blank!');
    }
}

$username = filter_input(INPUT_POST, 'username');
if ($username == NULL) {
    $username = filter_input(INPUT_GET, 'username');
    if ($username == NULL) {
        echo('$username is blank!');
    }
}
// TODO: use password_hash($password, PASSWORD_BCRYPT, ['cost' => 10]);
$password = filter_input(INPUT_POST, 'password');
if ($password == NULL) {
    $password = filter_input(INPUT_GET, 'password');
    if ($password == NULL) {
        echo('$password is blank!');
    }
}

$encryptedpassword = $password ? password_hash($password, PASSWORD_BCRYPT) : '';

$confirm_password = filter_input(INPUT_POST, 'confirm_password');
if ($confirm_password == NULL) {
    $confirm_password = filter_input(INPUT_GET, 'confirm_password');
    if ($confirm_password == NULL) {
        echo('$confirm_password is blank!');
    }
}
    try {
        $successful_registration = add_user($db, $firstname, $lastname, $email, $username, $encryptedpassword, (int)1, (int)0);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    if($successful_registration){
        $login_message = 'User registration successful...';
        header('Location: .');
    } else {
        $registration_message = 'User registration NOT successful...';
        include('registration.php');
    }
} elseif ($action == 'update_user') {
$old_user = unserialize(base64_decode(filter_input(INPUT_POST, 'old_usr_less_grps')));
if ($old_user == NULL) {
    $old_user = unserialize(base64_decode(filter_input(INPUT_GET, 'old_usr_less_grps')));
    if ($old_user == NULL) {
        echo("Nothing came through for old_user");
    }
}

$old_user_groups = unserialize(base64_decode(filter_input(INPUT_POST, 'old_user_groups')));
if ($old_user_groups == NULL) {
    $old_user_groups = unserialize(base64_decode(filter_input(INPUT_GET, 'old_user_groups')));
    if ($old_user_groups == NULL) {
        echo("Nothing came through for old_user_groups");
    }
}

$edit_user_status = filter_input(INPUT_POST, 'edit_user_status', FILTER_VALIDATE_BOOLEAN);
if ($edit_user_status == NULL) {
    $edit_user_status = filter_input(INPUT_GET, 'edit_user_status', FILTER_VALIDATE_BOOLEAN);
    if ($edit_user_status == NULL) {
        echo("Nothing came through for edit_user_status");
	$edit_user_status = 0;
    }
}

$edit_user_type = filter_input(INPUT_POST, 'edit_user_type');
if ($edit_user_type == NULL) {
    $edit_user_type = filter_input(INPUT_GET, 'edit_user_type');
    if ($edit_user_type == NULL) {
        echo("Nothing came through for edit_user_type");
    }
}

$edit_user_group_ids = filter_input(INPUT_POST, 'edit_user_groups', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
if ($edit_user_group_ids == NULL) {
    $edit_user_group_ids = filter_input(INPUT_GET, 'edit_user_groups', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
    if ($edit_user_group_ids == NULL) {
        echo("Nothing came through for edit_user_groups");
    }
}

    try {
	if($old_user['status'] != $edit_user_status || $old_user['utypeid'] != $edit_user_type) {
            update_user_props($db, $edit_user_status, $edit_user_type, get_user_by_name($db, $old_user['_user']));
	}

	$usr_id_to_edit = (int)get_user_id($db, ($edit_user_name ? $edit_user_name : $old_user['_user']));

	if ($edit_user_group_ids && $old_user_groups) {
	    $groups_to_del = array_diff($old_user_groups, $edit_user_group_ids);
	    $groups_to_add = array_diff($edit_user_group_ids, $old_user_groups);
	} elseif ($old_user_groups && !$edit_user_group_ids) {
	    $groups_to_del = $old_user_groups;
	    $groups_to_add = [];
	} elseif ($edit_user_group_ids && !$old_user_groups) {
	    $groups_to_del = [];
	    $groups_to_add = $edit_user_group_ids;
	} else {
	    $groups_to_del = [];
	    $groups_to_add = [];
	}
	foreach ($groups_to_del as $grp_to_del) {
	   delete_group_user($db, $grp_to_del, $usr_id_to_edit);
	}
	foreach ($groups_to_add as $grp_to_add) {
	    add_group_user($db, $grp_to_add, $usr_id_to_edit);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'delete_user') {
$delete_user = unserialize(base64_decode(filter_input(INPUT_POST, 'delete_user')));
if ($delete_user == NULL) {
    $delete_user = unserialize(base64_decode(filter_input(INPUT_GET, 'delete_user')));
    if ($delete_user == NULL) {
        echo("Nothing came through for delete_user");
    }
}

    try {
	if($delete_user) {
	    $usr_id_to_del = get_user_id($db, $delete_user['_user']);
	    delete_user_groups($db, $usr_id_to_del);
	    delete_user($db, $delete_user['_user']);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} else { echo "Something's wrong!"; }

?>
./admins/user/new.php
<?php include '../../view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:95%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="new_facility" name="new_facility" action="index.php" method="post">
	  <input type="hidden" name="action" value="add_facility">
          <fieldset>
            <legend>New Facility</legend>

            <p>
              <label for="facility"><span>Facility:</span></label>
              <input type="text" id="new_facility_name" name="new_facility_name" />
            </p>
            <p>
              <label for="relay_nos"><span># of Relays:</span></label>
              <select name="new_facility_relays">
		  <option value="0"></option>
		  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
              </select>
            </p>
            <p>
              <label for="device_id"><span>Device ID:</span></label>
              <select name="new_facility_device_id">
		  <?php foreach($available_devices as $device) : ?>
                  <option value="<?php  echo $device['id']; ?>">
			<?php  echo $device['deviceid']; ?>
		  </option>
		  <?php endforeach; ?>
              </select>
            </p>
            <p>
              <label for="status"><span>Active</span></label>
              <input type="checkbox" id="new_facility_status" name="new_facility_status" />
            </p>
            <p>
              <label for="groups"><span>Group(s):</span></label>
              <select multiple name="new_facility_group_ids[]">
		  <?php foreach($groups as $group) : ?>
                  <option value="<?php  echo $group['id']; ?>">
			<?php  echo $group['groupname']; ?>
		  </option>
		  <?php endforeach; ?>
              </select>
            </p>
              <button type="submit">Create</button>
              <button type="reset">Reset</button>
	      <a href="index.php">Cancel</a>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/device/list.php
<?php include '../../view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:95%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="device_factory" name="device_factory" action="index.php" method="post">
          <input type="hidden" name="action" value="new_device">
          <fieldset>
            <legend>Device Factory</legend>
            <select name="filter" onchange="this.form.action.value='device_list'; this.form.submit()">
              <option value="none" selected>filter by:</option>
              <option value="all">all</option>
              <option value="active">active</option>
              <option value="inactive">inactive</option>
            </select>
            <table border=1>
              <tr>
                <th width="70%">Device</th>
                <th>Facility</th>
                <th>Description</th>
		<th style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">Action</th>
              </tr>
              <?php foreach ($all_devs as $device) : ?>
              <tr>
                <td style='white-space: nowrap; overflow: hidden; max-width: 10px; text-overflow: ellipsis;'>
		<a href='index.php?action=edit_device&device=<?php echo base64_encode(serialize($device)); ?>'>
		 <font color='<?php echo $device['status'] ? '' : 'grey' ; ?>' >
                  <?php echo $device['device']; ?></font></a> </td>
                <td style='white-space: nowrap; overflow: hidden; max-width: 10px; text-overflow: ellipsis;'>
                  <?php echo $device['facility']; ?> </td>

                <td style='white-space: nowrap; overflow: hidden; max-width: 10px; text-overflow: ellipsis;'>
                  <?php echo $device['description']; ?>
                </td>
		<td style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">
		    <button name="delete_device" value='<?php echo base64_encode(serialize($device)); ?>' onclick="confirm('Are you sure you want to delete this device?') ? this.form.action.value='delete_device' : this.form.action.value='device_list'; this.form.submit()" >delete</button>
		</td>
              </tr>
              <?php endforeach; ?>
            </table>
            <button type="submit" style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">Add Device</button>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/device/edit.php
<?php include '../../view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:60%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="edit_device" name="edit_device" action="index.php" method="post">
          <input type="hidden" name="action" value="update_device">
          <input type="hidden" name="old_dev" value='<?php echo base64_encode(serialize($device)); ?>'>
          <fieldset>
            <legend>Edit Device</legend>

            <p>
              <label for="device"><span>Device Token:</span></label><br>
              <input type="text" id="edit_device_name" size="35" name="edit_device_name" value="<?php echo $device['device']; ?>"/>
            </p>
            <p>
              <label for="token"><span>Access Token:</span></label>
              <input type="text" id="edit_device_token" size="35" name="edit_device_token" value="<?php echo $device['token']; ?>"/>
            </p>
            <p>
              <label for="device_facility_id"><span>Facility:</span></label>
              <select name="edit_device_facility_id">
		  <option value='<?php echo $device_facility_id ; ?>' >
			<?php echo $device['facility']; ?>
		  </option>
		  <option value='' style="<?php echo(($device['facility'] != '[none]' && $_SESSION['user']['usertypeid'] == 4) ? 'block' : 'none'); ?>" >[none]</option>
                  <?php foreach($available_facilities as $facility) : ?>
                  <option value="<?php  echo $facility['id']; ?>">
                        <?php  echo $facility['facilityname']; ?>
                  </option>
                  <?php endforeach; ?>
              </select>
            </p>
            <p>
              <label for="status"><span>Active</span></label>
              <input type="checkbox" id="edit_device_status" name="edit_device_status" <?php echo ($device['status'] ? "checked" : ""); ?>/>
            </p>
            <p>
              <label for="description"><span>Device description:</span></label>
              <input type="textbox" id="edit_device_description" name="edit_device_description" value="<?php  echo $device['description']; ?>" />
            </p>
              <button type="submit">Update</button>
              <button type="reset">Reset</button>
	      <a href="index.php">Cancel</a>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/device/index.php
<?php
require('../../model/rsusers.php');
// require('../../model/rsgroups.php');
require('../../model/rsdevices.php');
require('../../model/rsdatabase.php');
require('../../model/rsfacilities.php');
require('../../model/rshousekeepinglog.php');
require('../../model/rsdeletedstuff.php');
require('../../model/rsdevicefacilitymatches.php');
// require('../../model/rsfacilitygroupmemberships.php');

$action = filter_input(INPUT_POST, 'action');
if ($action == NULL) {
    $action = filter_input(INPUT_GET, 'action');
    if ($action == NULL) {
        $action = 'device_list';
    }
}

if ($action == 'device_list') {
    if($filter == NULL)
	$filter = filter_input(INPUT_POST, 'filter', FILTER_SANITIZE_STRING);
    try {
	if($filter == "active")
	   $all_devs = get_active_devices_list($db);
	elseif($filter == "inactive")
	   $all_devs = get_inactive_devices_list($db);
	else
	   $all_devs = get_devices_list($db);
    } catch (PDOException $e) {
      $error_message = $e->getMessage(); 
      include('../../errors/database_error.php');
      exit();
    }
    include('list.php');
} elseif ($action == 'new_device') {
    try {
        $available_facilities = get_all_available_facilities($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');    
        exit();
    }
    include('new.php');
} elseif ($action == 'edit_device') {
    // beware the input char '#', it messes up the serialization.
    $device = unserialize(base64_decode(filter_input(INPUT_GET, 'device')));
    try {
	$device_facility_id = (int)get_facility_id($db, $device['facility']);
        $available_facilities = get_all_available_facilities($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    include('edit.php');
} elseif ($action == 'add_device') {
$new_device_name = filter_input(INPUT_POST, 'new_device_name');
if ($new_device_name == NULL) {
    $new_device_name = filter_input(INPUT_GET, 'new_device_name');
    if ($new_device_name == NULL) {
        echo("Nothing came through for new_device_name");
    }
}

$new_device_token = filter_input(INPUT_POST, 'new_device_token');
if ($new_device_token == NULL) {
    $new_device_token = filter_input(INPUT_GET, 'new_device_token');
    if ($new_device_token == NULL) {
        echo("Nothing came through for new_device_token");
    }
}

$new_facility_id = filter_input(INPUT_POST, 'new_device_facility_id');
if ($new_facility_id == NULL) {
    $new_facility_id = filter_input(INPUT_GET, 'new_device_facility_id');
    if ($new_facility_id == NULL) {
        echo("Nothing came through for new_facility_id");
    }
}

$new_device_status = filter_input(INPUT_POST, 'new_device_status', FILTER_VALIDATE_BOOLEAN);
if ($new_device_status == NULL) {
    $new_device_status = filter_input(INPUT_GET, 'new_device_status', FILTER_VALIDATE_BOOLEAN);
    if ($new_device_status == NULL) {
        echo("Nothing came through for new_device_status");
	$new_facility_status = 0;
    }
}

$new_device_description = filter_input(INPUT_POST, 'new_device_description');
if ($new_device_description == NULL) {
    $new_device_description = filter_input(INPUT_GET, 'new_device_description');
    if ($new_device_description == NULL) {
        echo("Nothing came through for new_device_description");
    }
}

    try {
        add_device($db, $new_device_name, $new_device_token, $new_device_description, $new_device_status);
	if($new_facility_id) add_device_facility($db, (int)get_device_id($db, $new_device_name), $new_facility_id);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'update_device') {
$old_device = unserialize(base64_decode(filter_input(INPUT_POST, 'old_dev')));
if ($old_device == NULL) {
    $old_device = unserialize(base64_decode(filter_input(INPUT_GET, 'old_dev')));
    if ($old_device == NULL) {
        echo("Nothing came through for old_device");
    }
}

$edit_device_name = filter_input(INPUT_POST, 'edit_device_name');
if ($edit_device_name == NULL) {
    $edit_device_name = filter_input(INPUT_GET, 'edit_device_name');
    if ($edit_device_name == NULL) {
        echo("Nothing came through for edit_device_name");
    }
}

$edit_device_token = filter_input(INPUT_POST, 'edit_device_token');
if ($edit_device_token == NULL) {
    $edit_device_token = filter_input(INPUT_GET, 'edit_device_token');
    if ($edit_device_token == NULL) {
        echo("Nothing came through for edit_facility_relay");
    }
}

$edit_facility_id = filter_input(INPUT_POST, 'edit_device_facility_id');
if ($edit_facility_id == NULL) {
    $edit_facility_id = filter_input(INPUT_GET, 'edit_device_facility_id');
    if ($edit_facility_id == NULL) {
        echo("Nothing came through for edit_facility_id");
    }
}

$edit_device_status = filter_input(INPUT_POST, 'edit_device_status', FILTER_VALIDATE_BOOLEAN);
if ($edit_device_status == NULL) {
    $edit_device_status = filter_input(INPUT_GET, 'edit_device_status', FILTER_VALIDATE_BOOLEAN);
    if ($edit_device_status == NULL) {
        echo("Nothing came through for edit_device_status");
	$edit_device_status = 0;
    }
}

$edit_device_description = filter_input(INPUT_POST, 'edit_device_description');
if ($edit_device_description == NULL) {
    $edit_device_description = filter_input(INPUT_GET, 'edit_device_description');
    if ($edit_device_description == NULL) {
        echo("Nothing came through for edit_device_description");
    }
}

    try {
	if($old_device['deviceid'] != $edit_device_name || $old_device['token'] != $edit_device_token || $old_device['status'] != $edit_device_status || $old_device['description'] != $edit_device_description) {
            update_device($db, $edit_device_name, $edit_device_token, $edit_device_description, $edit_device_status, get_device_by_name($db, $old_device['device']));
	}

	$old_facility_id = get_facility_id($db, $old_device['facility']);

	if($old_facility_id) {
	    if($edit_facility_id) {
		if ($old_facility_id != $edit_facility_id) update_facility_device($db, get_device_id($db, $old_device['device']), $edit_facility_id);
	    } else {
		delete_dev_fac_by_facility($db, $old_facility_id);
	    }
	} else {
	    if($edit_facility_id) add_device_facility($db, get_device_id($db, $old_device['device']), $edit_facility_id);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'delete_device') {
$delete_device = unserialize(base64_decode(filter_input(INPUT_POST, 'delete_device')));
if ($delete_device == NULL) {
    $delete_device = unserialize(base64_decode(filter_input(INPUT_GET, 'delete_device')));
    if ($delete_device == NULL) {
        echo("Nothing came through for delete_device");
    }
}

    try {
        if($delete_device) {
            $dev_id_to_del = get_device_id($db, $delete_device['device']);
            delete_dev_fac_by_device($db, $dev_id_to_del);
            delete_device($db, $delete_device['device']);
        }
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} else { echo "Something's wrong!"; }

?>
./admins/device/new.php
<?php include '../../view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:95%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="new_device" name="new_device" action="index.php" method="post">
	  <input type="hidden" name="action" value="add_device">
          <fieldset>
            <legend>New Device</legend>

            <p>
              <label for="device"><span>Device Token:</span></label><br>
              <input type="text" size="35" id="new_device_name" name="new_device_name" />
            </p>
            <p>
              <label for="token"><span>Access Token:</span></label>
              <input type="text" size="35" id="new_device_token" name="new_device_token" />
            </p>
            <p>
              <label for="facility_id"><span>Facility:</span></label>
              <select name="new_device_facility_id">
		  <option value='' style="<?php echo(($device['facility'] != '[none]' && $_SESSION['user']['usertypeid'] == 4) ? 'block' : 'none'); ?>" >[none]</option>
		  <?php foreach($available_facilities as $facility) : ?>
                  <option value="<?php  echo $facility['id']; ?>">
			<?php  echo $facility['facilityname']; ?>
		  </option>
		  <?php endforeach; ?>
              </select>
            </p>
            <p>
              <label for="status"><span>Active</span></label>
              <input type="checkbox" id="new_device_status" name="new_device_status" />
            </p>
            <p>
              <label for="description"><span>Device description:</span></label>
              <input type="textbox" id="new_device_description" name="new_device_description" />
            </p>
              <button type="submit">Create</button>
              <button type="reset">Reset</button>
	      <a href="index.php">Cancel</a>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/facility/index.jpk.txt
<?php

 require('../../model/rsusers.php');
 require('../../model/rsgroups.php');
 require('../../model/rsdevices.php');
 require('../../model/rsdatabase.php');
 require('../../model/rsfacilities.php');
 require('../../model/rsgroupusermemberships.php');
 require('../../model/rsdevicefacilitymatches.php');
 require('../../model/rsfacilitygroupmemberships.php');

$action = filter_input(INPUT_POST, 'action');
if ($action == NULL) {
    $action = filter_input(INPUT_GET, 'action');
    if ($action == NULL) {
        $action = 'facility_list';
    }
}

if ($action == 'facility_list') {
    $filter = filter_input(INPUT_POST, 'filter', FILTER_SANITIZE_STRING);
    if($filter == NULL) {
	$filter = filter_input(INPUT_POST, 'filter', FILTER_SANITIZE_STRING);
	if($filter == NULL) {
	    $filter = 'all';
	}
    }
    try {
	if($filter == "active")
	   $all_facs = get_active_facilities_list($db);
	else
	   $all_facs = get_facilities_list($db);
    } catch (PDOException $e) {
      $error_message = $e->getMessage(); 
      include('../../errors/database_error.php');
      exit();
    }
    include('list.php');
} elseif ($action == 'new_facility') {
    try {
        $available_devices = get_all_available_devices($db);
        $groups = get_all_groups($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');    
        exit();
    }
    include('new.php');
} elseif ($action == 'edit_facility') {
    // beware the input char '#', it messes up the serialization.
    $facility = unserialize(filter_input(INPUT_GET, 'facility'));
    try {
	$facility_id = (int)get_facility_id($db, $facility['facility']);
	$facility_device_id = (int)get_device_id($db, $facility['device']);
	$facility_groups = get_groups_by_facility($db, $facility_id);
        $available_devices = get_all_available_devices($db);
        $groups = get_all_groups($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    include('edit.php');
} elseif ($action == 'add_facility') {
$new_facility_name = filter_input(INPUT_POST, 'new_facility_name');
if ($new_facility_name == NULL) {
    $new_facility_name = filter_input(INPUT_GET, 'new_facility_name');
    if ($new_facility_name == NULL) {
        echo("Nothing came through for new_facility_name");
    }
}

$new_facility_relay = filter_input(INPUT_POST, 'new_facility_relays');
if ($new_facility_relay == NULL) {
    $new_facility_relay = filter_input(INPUT_GET, 'new_facility_relays');
    if ($new_facility_relay == NULL) {
        echo("Nothing came through for new_facility_relay");
    }
}

$new_facility_status = filter_input(INPUT_POST, 'new_facility_status', FILTER_VALIDATE_BOOLEAN);
if ($new_facility_status == NULL) {
    $new_facility_status = filter_input(INPUT_GET, 'new_facility_status', FILTER_VALIDATE_BOOLEAN);
    if ($new_facility_status == NULL) {
        echo("Nothing came through for new_facility_status");
	$new_facility_status = 0;
    }
}

$new_facility_device_id = filter_input(INPUT_POST, 'new_facility_device_id');
if ($new_facility_device_id == NULL) {
    $new_facility_device_id = filter_input(INPUT_GET, 'new_facility_device_id');
    if ($new_facility_device_id == NULL) {
        echo("Nothing came through for new_facility_device_id");
    }
}

$new_facility_group_ids = filter_input(INPUT_POST, 'new_facility_group_ids', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
if ($new_facility_group_ids == NULL) {
    $new_facility_group_ids = filter_input(INPUT_GET, 'new_facility_group_ids', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
    if ($new_facility_group_ids == NULL) {
        echo("Nothing came through for new_facility_group_ids");
    }
}

    try {
        add_facility($db, $new_facility_name, (int)$new_facility_relay, (int)$new_facility_status);
	add_device_facility($db, (int)$new_facility_device_id, get_facility_id($db, $new_facility_name));
	$new_facility_id = (int)get_facility_id($db, $new_facility_name);
	foreach ($new_facility_group_ids as $new_facility_group_id) {
            add_facility_group($db, $new_facility_id, (int)$new_facility_group_id);
        }
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'update_facility') {
$old_facility = unserialize(filter_input(INPUT_POST, 'old_fac_less_grps'));
if ($old_facility == NULL) {
    $old_facility = unserialize(filter_input(INPUT_GET, 'old_fac_less_grps'));
    if ($old_facility == NULL) {
        echo("Nothing came through for old_facility");
    }
}

$old_facility_groups = unserialize(filter_input(INPUT_POST, 'old_facility_groups'));
if ($old_facility_groups == NULL) {
    $old_facility_groups = unserialize(filter_input(INPUT_GET, 'old_facility_groups'));
    if ($old_facility_groups == NULL) {
        echo("Nothing came through for old_facility_groups");
    }
}

$edit_facility_name = filter_input(INPUT_POST, 'edit_facility_name');
if ($edit_facility_name == NULL) {
    $edit_facility_name = filter_input(INPUT_GET, 'edit_facility_name');
    if ($edit_facility_name == NULL) {
        echo("Nothing came through for edit_facility_name");
    }
}

$edit_facility_relays = filter_input(INPUT_POST, 'edit_facility_relays');
if ($edit_facility_relays == NULL) {
    $edit_facility_relays = filter_input(INPUT_GET, 'edit_facility_relays');
    if ($edit_facility_relays == NULL) {
        echo("Nothing came through for edit_facility_relays");
    }
}

$edit_facility_status = filter_input(INPUT_POST, 'edit_facility_status', FILTER_VALIDATE_BOOLEAN);
if ($edit_facility_status == NULL) {
    $edit_facility_status = filter_input(INPUT_GET, 'edit_facility_status', FILTER_VALIDATE_BOOLEAN);
    if ($edit_facility_status == NULL) {
        echo("Nothing came through for edit_facility_status");
	$edit_facility_status = 0;
    }
}

$edit_device_id = filter_input(INPUT_POST, 'edit_facility_device_id');
if ($edit_device_id == NULL) {
    $edit_device_id = filter_input(INPUT_GET, 'edit_facility_device_id');
    if ($edit_device_id == NULL) {
        echo("Nothing came through for edit_device_id");
    }
}

$edit_facility_group_ids = filter_input(INPUT_POST, 'edit_facility_groups', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
if ($edit_facility_group_ids == NULL) {
    $edit_facility_group_ids = filter_input(INPUT_GET, 'edit_facility_groups', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
    if ($edit_facility_group_ids == NULL) {
        echo("Nothing came through for edit_facility_groups");
    }
}

    try {
	if($old_facility['facility'] != $edit_facility_name || $old_facility['relays'] != $edit_facility_relays || $old_facility['status'] != $edit_facility_status) {
            update_facility($db, $edit_facility_name, $edit_facility_relays, $edit_facility_status, get_facility_by_name($db, $old_facility['facility']));
	}

	$old_device_id = (int)get_device_id($db, $old_facility['device']);

	if ($old_device_id != $edit_device_id) {
	    update_device_facility($db, (int)$edit_device_id, (int)get_facility_id($db, $edit_facility_name));
	}
	$fac_id_to_edit = (int)get_facility_id($db, ($edit_facility_name ? $edit_facility_name : $old_facility['facility']));
	if ($edit_facility_group_ids && $old_facility_groups) {
	    $groups_to_del = array_diff($old_facility_groups, $edit_facility_group_ids);
	    $groups_to_add = array_diff($edit_facility_group_ids, $old_facility_groups);
	} elseif ($old_facility_groups && !$edit_facility_group_ids) {
	    $groups_to_del = $old_facility_groups;
	    $groups_to_add = [];
	} elseif ($edit_facility_group_ids && !$old_facility_groups) {
	    $groups_to_del = [];
	    $groups_to_add = $edit_facility_group_ids;
	} else {
	    $groups_to_del = [];
	    $groups_to_add = [];
	}
	foreach ($groups_to_del as $grp_to_del) {
	   delete_facility_group($db, $fac_id_to_edit, $grp_to_del);
	}
	foreach ($groups_to_add as $grp_to_add) {
	    add_facility_group($db, $fac_id_to_edit, $grp_to_add);
	    echo('Added group ' . $grp_to_add);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'delete_facility') {
$delete_facility = unserialize(filter_input(INPUT_POST, 'delete_facility'));
if ($delete_facility == NULL) {
    $delete_facility = unserialize(filter_input(INPUT_GET, 'delete_facility'));
    if ($delete_facility == NULL) {
        echo("Nothing came through for delete_facility");
    }
}

    try {
	if($delete_facility) {
	    $fac_id_to_del = get_facility_id($db, $delete_facility['facility']);
	    $affected_grp_names = "";
	    if($delete_facility['groups'] > 0) {
		$temp_grps = get_groups_by_facility($db, $fac_id_to_del);
		foreach($temp_grps as $temp_grp) {
		    $affected_grp_names .= $temp_grp['groupname'] . "\r\n"; // or PHP_EOL
	        }
	    }
	    delete_facility_groups($db, $fac_id_to_del);
	    delete_dev_fac_by_facility($db, $fac_id_to_del);
	    delete_facility($db, $delete_facility['facility']);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} else { echo "Something's wrong!"; }

?>
./admins/facility/list.php
<?php include '../../view/header.php'; ?>
<?php /*session_start();*/ ?>
<?php /*if(!isset($_SESSION['firstname'])) :
        include($app_path);
        exit();
      endif;*/
?>

<main>
    <section>
        
<table border='0' style='width:95%' align='center'>
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="facility_factory" name="facility_factory" action="index.php" method="post">
          <input type="hidden" name="action" value="new_facility">
          <fieldset>
            <legend>Facility Factory</legend>
            <select name="filter" onchange="this.form.action.value='facility_list'; this.form.submit()">
              <option value="none" selected>filter by:</option>
              <option value="all">all</option>
              <option value="active">active</option>
            </select>
            <table border=1>
              <tr>
                <th width="70%">Facility</th>
                <th>Relays</th>
                <th>Device</th>
                <th>Groups</th>
		<th style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">Action</th>
              </tr>
              <?php foreach ($all_facs as $facility) : ?>
              <tr>
                <td style='white-space: nowrap; overflow: hidden; max-width: 10px; text-overflow: ellipsis;'>
		<a href='index.php?action=edit_facility&facility=<?php echo base64_encode(serialize($facility)); ?>'>
		<font color='<?php echo $facility['status'] ? '' : 'grey' ; ?>' >
                <?php echo $facility['facility']; ?>
		</font>
		</a>
		</td>
                <td>
                  <?php echo $facility['relays']; ?> </td>

                <td style='white-space: nowrap; overflow: hidden; max-width: 10px; text-overflow: ellipsis;'>
                  <?php echo $facility['device']; ?>
                </td>
                <td>
                  <?php echo $facility['groups']; ?>
		</td>
		<td style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">
		  <button name="delete_facility" value='<?php echo base64_encode(serialize($facility)); ?>' onclick="confirm('Are you sure you want to delete this facility?') ? this.form.action.value='delete_facility' : this.form.action.value='facility_list'; this.form.submit()" >delete</button>
		</td>
              </tr>
              <?php endforeach; ?>
            </table>
            <button type="submit" style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">Add Facility</button>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/facility/edit.php
<?php include '../../view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:60%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="edit_facility" name="edit_facility" action="index.php" method="post">
          <input type="hidden" name="action" value="update_facility">
          <input type="hidden" name="old_fac_less_grps" value='<?php echo base64_encode(serialize($facility)); ?>'>
          <input type="hidden" name="old_facility_name" value="<?php echo $facility['facility']; ?>">
          <input type="hidden" name="old_device_name" value="<?php echo $facility['device']; ?>">
          <input type="hidden" name="old_facility_groups" value='<?php echo base64_encode(serialize($facility_groups)) ?>'>
          <fieldset>
            <legend>Edit Facility</legend>

            <p>
              <label for="facility"><span>Facility:</span></label>
              <input type="text" id="edit_facility_name" name="edit_facility_name" value="<?php echo $facility['facility']; ?>"/>
            </p>
            <p>
              <label for="relay_nos"><span># of Relays:</span></label>
              <select name="edit_facility_relays">
		<?php for($j = 1; $j <= 4; $j++) : ?>
                  <option value="<?php echo $j; ?>" <?php echo ($facility['relays'] == $j) ? 'selected' : '' ; ?> ><?php echo $j; ?></option>
                <?php endfor; ?>
              </select>
            </p>
            <p>
              <label for="facility_device_id"><span>Device ID:</span></label>
              <select name="edit_facility_device_id">
		  <option value='<?php  echo $facility_device_id ; ?>' > <?php  echo $facility['device']; ?>
		  </option>
		  <?php foreach($available_devices as $device) : ?>
                  <option value="<?php  echo $device['id']; ?>" >
			<?php  echo $device['deviceid']; ?>
		  </option>
		  <?php endforeach; ?>
		  <option v<option value='' style='<?php echo($facility['device'] != '[none]' && $_SESSION['user']['usertype'] == 4 ? 'block' : 'none'); ?>' >[none]</option>
              </select>
            </p>
	    <p>
	      <label for="facility_status"><span>Active</span></label>
	      <input type="checkbox" id="edit_facility_status" name="edit_facility_status" <?php echo ($facility['status'] ? "checked" : ""); ?> />
	    </p>
            <p>
              <label for="groups"><span>Group(s):</span></label>
              <select multiple name="edit_facility_groups[]">
		  <?php foreach($groups as $group) : ?>
                  <option value="<?php  echo $group['id']; ?>" <?php echo in_array($group['id'], $facility_groups) ? 'selected' : '' ;?> >
			<?php  echo $group['groupname']; ?>
		  </option>
		  <?php endforeach; ?>
              </select>
            </p>
              <button type="submit">Update</button>
              <button type="reset">Reset</button>
	      <a href="index.php">Cancel</a>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/facility/index.php
<?php

 require('../../model/rsusers.php');
 require('../../model/rsgroups.php');
 require('../../model/rsdevices.php');
 require('../../model/rsdatabase.php');
 require('../../model/rsfacilities.php');
 require('../../model/rshousekeepinglog.php');
 require('../../model/rsdeletedstuff.php');
// require('../../model/rsgroupusermemberships.php');
 require('../../model/rsdevicefacilitymatches.php');
 require('../../model/rsfacilitygroupmemberships.php');

$action = filter_input(INPUT_POST, 'action');
if ($action == NULL) {
    $action = filter_input(INPUT_GET, 'action');
    if ($action == NULL) {
        $action = 'facility_list';
    }
}

if ($action == 'facility_list') {
    $filter = filter_input(INPUT_POST, 'filter', FILTER_SANITIZE_STRING);
    if($filter == NULL) {
	$filter = filter_input(INPUT_GET, 'filter', FILTER_SANITIZE_STRING);
	if($filter == NULL) {
	    $filter = 'all';
	}
    }
    try {
	if($filter == "active")
	   $all_facs = get_active_facilities_list($db);
	else
	   $all_facs = get_facilities_list($db);
    } catch (PDOException $e) {
      $error_message = $e->getMessage(); 
      include('../../errors/database_error.php');
      exit();
    }
    include('list.php');
} elseif ($action == 'new_facility') {
    try {
        $available_devices = get_all_available_devices($db);
        $groups = get_all_groups($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');    
        exit();
    }
    include('new.php');
} elseif ($action == 'edit_facility') {
    // beware the input char '#', it messes up the serialization.
    $facility = unserialize(base64_decode(filter_input(INPUT_GET, 'facility')));
    try {
	$facility_id = (int)get_facility_id($db, $facility['facility']);
	$facility_device_id = (int)get_device_id($db, $facility['device']);
	$facility_groups = get_groups_by_facility($db, $facility_id);
        $available_devices = get_all_available_devices($db);
        $groups = get_all_groups($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    include('edit.php');
} elseif ($action == 'add_facility') {
$new_facility_name = filter_input(INPUT_POST, 'new_facility_name');
if ($new_facility_name == NULL) {
    $new_facility_name = filter_input(INPUT_GET, 'new_facility_name');
    if ($new_facility_name == NULL) {
        echo("Nothing came through for new_facility_name");
    }
}

$new_facility_relay = filter_input(INPUT_POST, 'new_facility_relays');
if ($new_facility_relay == NULL) {
    $new_facility_relay = filter_input(INPUT_GET, 'new_facility_relays');
    if ($new_facility_relay == NULL) {
        echo("Nothing came through for new_facility_relay");
    }
}

$new_facility_status = filter_input(INPUT_POST, 'new_facility_status', FILTER_VALIDATE_BOOLEAN);
if ($new_facility_status == NULL) {
    $new_facility_status = filter_input(INPUT_GET, 'new_facility_status', FILTER_VALIDATE_BOOLEAN);
    if ($new_facility_status == NULL) {
        echo("Nothing came through for new_facility_status");
	$new_facility_status = 0;
    }
}

$new_facility_device_id = filter_input(INPUT_POST, 'new_facility_device_id');
if ($new_facility_device_id == NULL) {
    $new_facility_device_id = filter_input(INPUT_GET, 'new_facility_device_id');
    if ($new_facility_device_id == NULL) {
        echo("Nothing came through for new_facility_device_id");
    }
}

$new_facility_group_ids = filter_input(INPUT_POST, 'new_facility_group_ids', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
if ($new_facility_group_ids == NULL) {
    $new_facility_group_ids = filter_input(INPUT_GET, 'new_facility_group_ids', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
    if ($new_facility_group_ids == NULL) {
        echo("Nothing came through for new_facility_group_ids");
    }
}

    try {
        add_facility($db, $new_facility_name, (int)$new_facility_relay, (int)$new_facility_status);
	if ($new_facility_device_id) add_device_facility($db, (int)$new_facility_device_id, get_facility_id($db, $new_facility_name));
	$new_facility_id = (int)get_facility_id($db, $new_facility_name);
	foreach ($new_facility_group_ids as $new_facility_group_id) {
            add_facility_group($db, $new_facility_id, (int)$new_facility_group_id);
        }
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'update_facility') {
$old_facility = unserialize(base64_decode(filter_input(INPUT_POST, 'old_fac_less_grps')));
if ($old_facility == NULL) {
    $old_facility = unserialize(base64_decode(filter_input(INPUT_GET, 'old_fac_less_grps')));
    if ($old_facility == NULL) {
        echo("Nothing came through for old_facility");
    }
}

$old_facility_groups = unserialize(base64_decode(filter_input(INPUT_POST, 'old_facility_groups')));
if ($old_facility_groups == NULL) {
    $old_facility_groups = unserialize(base64_decode(filter_input(INPUT_GET, 'old_facility_groups')));
    if ($old_facility_groups == NULL) {
        echo("Nothing came through for old_facility_groups");
    }
}

$edit_facility_name = filter_input(INPUT_POST, 'edit_facility_name');
if ($edit_facility_name == NULL) {
    $edit_facility_name = filter_input(INPUT_GET, 'edit_facility_name');
    if ($edit_facility_name == NULL) {
        echo("Nothing came through for edit_facility_name");
    }
}

$edit_facility_relays = filter_input(INPUT_POST, 'edit_facility_relays');
if ($edit_facility_relays == NULL) {
    $edit_facility_relays = filter_input(INPUT_GET, 'edit_facility_relays');
    if ($edit_facility_relays == NULL) {
        echo("Nothing came through for edit_facility_relays");
    }
}

$edit_facility_status = filter_input(INPUT_POST, 'edit_facility_status', FILTER_VALIDATE_BOOLEAN);
if ($edit_facility_status == NULL) {
    $edit_facility_status = filter_input(INPUT_GET, 'edit_facility_status', FILTER_VALIDATE_BOOLEAN);
    if ($edit_facility_status == NULL) {
        echo("Nothing came through for edit_facility_status");
	$edit_facility_status = 0;
    }
}

$edit_device_id = filter_input(INPUT_POST, 'edit_facility_device_id');
if ($edit_device_id == NULL) {
    $edit_device_id = filter_input(INPUT_GET, 'edit_facility_device_id');
    if ($edit_device_id == NULL) {
        echo("Nothing came through for edit_device_id");
    }
}

$edit_facility_group_ids = filter_input(INPUT_POST, 'edit_facility_groups', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
if ($edit_facility_group_ids == NULL) {
    $edit_facility_group_ids = filter_input(INPUT_GET, 'edit_facility_groups', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
    if ($edit_facility_group_ids == NULL) {
        echo("Nothing came through for edit_facility_groups");
    }
}

    try {
	if($old_facility['facility'] != $edit_facility_name || $old_facility['relays'] != $edit_facility_relays || $old_facility['status'] != $edit_facility_status) {
            update_facility($db, $edit_facility_name, $edit_facility_relays, $edit_facility_status, get_facility_by_name($db, $old_facility['facility']));
	}

	$old_device_id = (int)get_device_id($db, $old_facility['device']);

	if ($old_device_id) {
	    if($edit_device_id) {
		if ($old_device_id != $edit_device_id) update_device_facility($db, (int)$edit_device_id, (int)get_facility_id($db, $edit_facility_name));
	    } else {
		delete_dev_fac_by_device($db, $old_device_id);
	    }
	} else {
	    if($edit_device_id) add_device_facility($db, (int)$edit_device_id, (int)get_facility_id($db, $old_facility['facility']));
	}	


	$fac_id_to_edit = (int)get_facility_id($db, ($edit_facility_name ? $edit_facility_name : $old_facility['facility']));
	if ($edit_facility_group_ids && $old_facility_groups) {
	    $groups_to_del = array_diff($old_facility_groups, $edit_facility_group_ids);
	    $groups_to_add = array_diff($edit_facility_group_ids, $old_facility_groups);
	} elseif ($old_facility_groups && !$edit_facility_group_ids) {
	    $groups_to_del = $old_facility_groups;
	    $groups_to_add = [];
	} elseif ($edit_facility_group_ids && !$old_facility_groups) {
	    $groups_to_del = [];
	    $groups_to_add = $edit_facility_group_ids;
	} else {
	    $groups_to_del = [];
	    $groups_to_add = [];
	}
	foreach ($groups_to_del as $grp_to_del) {
	   delete_facility_group($db, $fac_id_to_edit, $grp_to_del);
	}
	foreach ($groups_to_add as $grp_to_add) {
	    add_facility_group($db, $fac_id_to_edit, $grp_to_add);
	    echo('Added group ' . $grp_to_add);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'delete_facility') {
$delete_facility = unserialize(base64_decode(filter_input(INPUT_POST, 'delete_facility')));
if ($delete_facility == NULL) {
    $delete_facility = unserialize(base64_decode(filter_input(INPUT_GET, 'delete_facility')));
    if ($delete_facility == NULL) {
        echo("Nothing came through for delete_facility");
    }
}

    try {
	if($delete_facility) {
	    $fac_id_to_del = get_facility_id($db, $delete_facility['facility']);
	    delete_facility_groups($db, $fac_id_to_del);
	    delete_dev_fac_by_facility($db, $fac_id_to_del);
	    delete_facility($db, $delete_facility['facility']);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} else { echo "Something's wrong!"; }

?>
./admins/facility/new.php
<?php include '../../view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:60%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="new_facility" name="new_facility" action="index.php" method="post">
	  <input type="hidden" name="action" value="add_facility">
          <fieldset>
            <legend>New Facility</legend>

            <p>
              <label for="facility"><span>Facility:</span></label>
              <input type="text" id="new_facility_name" name="new_facility_name" />
            </p>
            <p>
              <label for="relay_nos"><span># of Relays:</span></label>
              <select name="new_facility_relays">
		  <option value="0"></option>
		  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
              </select>
            </p>
            <p>
              <label for="device_id"><span>Device ID:</span></label>
              <select name="new_facility_device_id">
		  <?php foreach($available_devices as $device) : ?>
                  <option value="<?php  echo $device['id']; ?>">
			<?php  echo $device['deviceid']; ?>
		  </option>
		  <?php endforeach; ?>
		  <option v<option value='' style='<?php echo($facility['device'] != '[none]' && $_SESSION['user']['usertype'] == 4 ? 'block' : 'none'); ?>' >[none]
		  </option>
              </select>
            </p>
            <p>
              <label for="status"><span>Active</span></label>
              <input type="checkbox" id="new_facility_status" name="new_facility_status" />
            </p>
            <p>
              <label for="groups"><span>Group(s):</span></label>
              <select multiple name="new_facility_group_ids[]">
		  <?php foreach($groups as $group) : ?>
                  <option value="<?php  echo $group['id']; ?>">
			<?php  echo $group['groupname']; ?>
		  </option>
		  <?php endforeach; ?>
              </select>
            </p>
              <button type="submit">Create</button>
              <button type="reset">Reset</button>
	      <a href="index.php">Cancel</a>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/group/list.php
<?php include '../../view/header.php'; ?>
<main>
    <section>
        
<table border='0' style='width:95%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="group_factory" name="group_factory" action="index.php" method="post">
          <input type="hidden" name="action" value="new_group">
          <fieldset>
            <legend>Group Factory</legend>
            <select name="filter" onchange="this.form.action.value='group_list'; this.form.submit()">
              <option value="none" selected>filter by:</option>
              <option value="all">all</option>
              <option value="active">active</option>
            </select>
            <table border=1>
              <tr>
                <th width="70%">Group</th>
                <th>Users</th>
                <th>Facilities</th>
                <th>Description</th>
		<th style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">Action</th>
              </tr>
              <?php foreach ($all_grps as $group) : ?>
              <tr>
                <td style='white-space: nowrap; overflow: hidden; max-width: 10px; text-overflow: ellipsis;'>
		<a href='index.php?action=edit_group&group=<?php echo base64_encode(serialize($group)); ?>'>
		 <font color='<?php echo $group['status'] ? '' : 'grey' ; ?>' >
                  <?php echo $group['_group']; ?></font></a> </td>
                <td>
                  <?php echo $group['users']; ?> </td>

                <td>
                  <?php echo $group['facilities']; ?>
                </td>
                <td style='white-space: nowrap; overflow: hidden; max-width: 10px; text-overflow: ellipsis;'>
                  <?php echo $group['description']; ?>
		</td>
		<td style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">
		    <button name="delete_group" value='<?php echo base64_encode(serialize($group)); ?>' onclick="confirm('Are you sure you want to delete this group?') ? this.form.action.value='delete_group' : this.form.action.value='group_list'; this.form.submit()" >delete</button>
		</td>
              </tr>
              <?php endforeach; ?>
            </table>
            <button type="submit" style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">Add Group</button>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>
        
    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/group/edit.php
<?php include '../../view/header.php'; ?>
<main>
    <section>

<table border='0' style='width:60%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="edit_group" name="edit_group" action="index.php" method="post">
          <input type="hidden" name="action" value="update_group">
          <input type="hidden" name="old_grp_less_usrs_facs" value='<?php echo base64_encode(serialize($group)); ?>'>
          <input type="hidden" name="old_group_users" value='<?php echo base64_encode(serialize($group_users)); ?>'>
          <input type="hidden" name="old_group_facilities" value='<?php echo base64_encode(serialize($group_facilities)); ?>'>
          <fieldset>
            <legend>Edit Group</legend>

            <p>
              <label for="group"><span>Group:</span></label>
              <input type="text" id="edit_group_name" name="edit_group_name" value="<?php echo htmlspecialchars($group['_group']); ?>">
            </p>
            <p>
              <label for="description"><span>Description:</span></label>
              <input type="text" id="edit_group_description" name="edit_group_description" value="<?php echo htmlspecialchars($group['description']); ?>">
            </p>
            <p>
              <label for="status"><span>Active</span></label>
              <input type="checkbox" id="edit_group_status" name="edit_group_status" <?php echo ($group['status'] ? "checked" : ""); ?> >
            </p>
            <p>
              <label for="users"><span>Users:</span></label>
              <select multiple name="edit_group_users[]">
                  <option value=0>[select]</option>
                <?php foreach($users as $user) : ?>
                  <option value="<?php echo $user['id'] ?>" <?php echo in_array($user['id'], $group_users) ? ' selected ' : '' ;?> ><?php echo $user['username'] ?></option>
                <?php endforeach; ?>
              </select>
            </p>
            <p>
              <label for="facilities"><span>Facilities:</span></label>
              <select multiple name="edit_group_facilities[]">
                  <option value=0>[select]</option>
                <?php foreach($facilities as $facility) : ?>
                  <option value="<?php echo $facility['id'] ?>" <?php echo in_array($facility['id'], $group_facilities) ? ' selected ' : '' ;?> ><?php echo $facility['facilityname'] ?></option>
                <?php endforeach; ?>
              </select>
            </p>
            <p>
              <button type="submit">Update</button>
              <button type="reset">Reset</button>
	      <a href="index.php">Cancel</a>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>

    </section>
</main>
<?php include '../../view/footer.php'; ?>

./admins/group/index.php
<?php
require('../../model/rsusers.php');
require('../../model/rsgroups.php');
require('../../model/rsdevices.php');
require('../../model/rsdatabase.php');
require('../../model/rsfacilities.php');
require('../../model/rshousekeepinglog.php');
require('../../model/rsdeletedstuff.php');
require('../../model/rsgroupusermemberships.php');
require('../../model/rsdevicefacilitymatches.php');
require('../../model/rsfacilitygroupmemberships.php');

$action = filter_input(INPUT_POST, 'action');
if ($action == NULL) {
    $action = filter_input(INPUT_GET, 'action');
    if ($action == NULL) {
        $action = 'group_list';
    }
}

if ($action == 'group_list') {
    if($filter == NULL)
	$filter = filter_input(INPUT_POST, 'filter', FILTER_SANITIZE_STRING);
    try {
	if($filter == "active")
	   $all_grps = get_active_groups_list($db);
	else
	   $all_grps = get_groups_list($db);
    } catch (PDOException $e) {
      $error_message = $e->getMessage(); 
      include('../../errors/database_error.php');
      exit();
    }
    include('list.php');
} elseif ($action == 'new_group') {
    try {
	$users = get_all_users($db);
        $facilities = get_all_facilities($db);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');    
        exit();
    }
    include('new.php');
} elseif ($action == 'edit_group') {
    // beware the input char '#', it messes up the serialization.
    $group = unserialize(base64_decode(filter_input(INPUT_GET, 'group')));
    try {
	$group_id = (int)get_group_id($db, $group['_group']);
        $users = get_all_users($db);
        $facilities = get_all_facilities($db);
	$group_users = get_users_by_group($db, $group_id);
	$group_facilities = get_facilities_by_group($db, $group_id);
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    include('edit.php');
} elseif ($action == 'add_group') {
$new_group_name = filter_input(INPUT_POST, 'new_group_name');
if ($new_group_name == NULL) {
    $new_group_name = filter_input(INPUT_GET, 'new_group_name');
    if ($new_group_name == NULL) {
        echo("Nothing came through for new_group_name");
    }
}

$new_group_description = filter_input(INPUT_POST, 'new_group_description');
if ($new_group_description == NULL) {
    $new_group_description = filter_input(INPUT_GET, 'new_group_description');
    if ($new_group_description == NULL) {
        echo("Nothing came through for new_group_description");
    }
}

$new_group_status = filter_input(INPUT_POST, 'new_group_status', FILTER_VALIDATE_BOOLEAN);
if ($new_group_status == NULL) {
    $new_group_status = filter_input(INPUT_GET, 'new_group_status', FILTER_VALIDATE_BOOLEAN);
    if ($new_group_status == NULL) {
        echo("Nothing came through for new_group_status");
	$new_group_status = 0;
    }
}

$new_group_users = filter_input(INPUT_POST, 'new_group_users', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
if ($new_group_users == NULL) {
    $new_group_users = filter_input(INPUT_GET, 'new_group_users', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
    if ($new_group_users == NULL) {
        echo("Nothing came through for new_group_users");
    }
}

$new_group_facilities = filter_input(INPUT_POST, 'new_group_facilities', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
if ($new_group_facilities == NULL) {
    $new_group_facilities = filter_input(INPUT_GET, 'new_group_facilities', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
    if ($new_group_facilities == NULL) {
        echo("Nothing came through for new_group_facilities");
    }
}
    try {
        add_group($db, htmlspecialchars($new_group_name), htmlspecialchars($new_group_description), (int)$new_group_status);
	$new_group_id = (int)get_group_id($db, $new_group_name);
	foreach ($new_group_users as $new_group_user_id) {
		add_group_user($db, $new_group_id, (int)$new_group_user_id);
	}
	foreach ($new_group_facilities as $new_group_facility_id) {
            add_facility_group($db, (int)$new_group_facility_id, $new_group_id);
	}
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'update_group') {
$old_group = unserialize(base64_decode(filter_input(INPUT_POST, 'old_grp_less_usrs_facs')));
if ($old_group == NULL) {
    $old_group = unserialize(base64_decode(filter_input(INPUT_GET, 'old_grp_less_usrs_facs')));
    if ($old_group == NULL) {
        echo("Nothing came through for old_group");
    }
}

$old_group_users = unserialize(base64_decode(filter_input(INPUT_POST, 'old_group_users')));
if ($old_group_users == NULL) {
    $old_group_users = unserialize(base64_decode(filter_input(INPUT_GET, 'old_users')));
    if ($old_group_users == NULL) {
        echo("Nothing came through for old_group_users");
    }
}

$old_group_facilities = unserialize(base64_decode(filter_input(INPUT_POST, 'old_group_facilities')));
if ($old_group_facilities == NULL) {
    $old_group_facilities = unserialize(base64_decode(filter_input(INPUT_GET, 'old_group_facilities')));
    if ($old_group_facilities == NULL) {
        echo("Nothing came through for old_group_facilities");
    }
}

$edit_group_name = filter_input(INPUT_POST, 'edit_group_name');
if ($edit_group_name == NULL) {
    $edit_group_name = filter_input(INPUT_GET, 'edit_group_name');
    if ($edit_group_name == NULL) {
        echo("Nothing came through for edit_group_name");
    }
}

$edit_group_description = filter_input(INPUT_POST, 'edit_group_description');
if ($edit_group_description == NULL) {
    $edit_group_description = filter_input(INPUT_GET, 'edit_group_description');
    if ($edit_group_description == NULL) {
        echo("Nothing came through for edit_group_description");
    }
}

$edit_group_status = filter_input(INPUT_POST, 'edit_group_status', FILTER_VALIDATE_BOOLEAN);
if ($edit_group_status == NULL) {
    $edit_group_status = filter_input(INPUT_GET, 'edit_group_status', FILTER_VALIDATE_BOOLEAN);
    if ($edit_group_status == NULL) {
        echo("Nothing came through for edit_group_status");
	$edit_group_status = 0;
    }
}

$edit_group_users = filter_input(INPUT_POST, 'edit_group_users', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
if ($edit_group_users == NULL) {
    $edit_group_users = filter_input(INPUT_GET, 'edit_group_users', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
    if ($edit_group_users == NULL) {
        echo("Nothing came through for edit_group_users");
    }
}

$edit_group_facilities = filter_input(INPUT_POST, 'edit_group_facilities', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
if ($edit_group_facilities == NULL) {
    $edit_group_facilities = filter_input(INPUT_GET, 'edit_group_facilities', FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);
    if ($edit_group_facilities == NULL) {
        echo("Nothing came through for edit_group_facilities");
    }
}

    try {
	if($old_group['_group'] != $edit_group_name || $old_group['description'] != $edit_group_description || $old_group['status'] != $edit_group_status) {
            update_group($db, $edit_group_name, $edit_group_description, $edit_group_status, get_group_by_name($db, $old_group['_group']));
	}
	
	$grp_id_to_edit = (int)get_group_id($db, ($edit_group_name ? $edit_group_name : $old_group['_group']));

	if ($edit_group_users && $old_group_users) {
	    $users_to_del = array_diff($old_group_users, $edit_group_users);
	    $users_to_add = array_diff($edit_group_users, $old_group_users);
	} elseif (!$edit_group_users && $old_group_users) {
	    $users_to_del = $old_group_users;
	    $users_to_add = [];
	} elseif ($edit_group_users && !$old_group_users) {
	    $users_to_del = [];
	    $users_to_add = $edit_group_users;
	} else {
	    $users_to_del = [];
	    $users_to_add = [];
	}
	foreach ($users_to_del as $usr_to_del) {
	    delete_group_user($db, $grp_id_to_edit, $usr_to_del);
	}
	foreach ($users_to_add as $usr_to_add) {
	    add_group_user($db, $grp_id_to_edit, $usr_to_add);
	}

	if ($edit_group_facilities && $old_group_facilities) {
	    $facilities_to_del = array_diff($old_group_facilities, $edit_group_facilities);
	    $facilities_to_add = array_diff($edit_group_facilities, $old_group_facilities);
	} elseif (!$edit_group_facilities && $old_group_facilities) {
	    $facilities_to_del = $old_group_facilities;
	    $facilities_to_add = [];
	} elseif ($edit_group_facilities && !$old_group_facilities) {
	    $facilities_to_del = [];
	    $facilities_to_add = $edit_group_facilities;
	} else {
	    $facilities_to_del = [];
	    $facilities_to_add = [];
	}
	foreach ($facilities_to_del as $fac_to_del) {
	    delete_facility_group($db, $fac_to_del, $grp_id_to_edit);
	}
	foreach ($facilities_to_add as $fac_to_add) {
	    add_facility_group($db, $fac_to_add, $grp_id_to_edit);
	}

    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} elseif ($action == 'delete_group') {
$delete_group = unserialize(base64_decode(filter_input(INPUT_POST, 'delete_group')));
if ($delete_group == NULL) {
    $delete_group = unserialize(base64_decode(filter_input(INPUT_GET, 'delete_group')));
    if ($delete_group == NULL) {
        echo("Nothing came through for delete_group");
    }
}

    try {
        if($delete_group) {
            $grp_id_to_del = get_group_id($db, $delete_group['_group']);
            if ($delete_group['users'] > 0) delete_group_users($db, $grp_id_to_del);
	    if ($delete_group['facilities'] > 0) delete_group_facilities($db, $grp_id_to_del);
	    delete_group($db, $delete_group['_group']);
        }
    } catch (PDOException $e) {
        $error_message = $e->getMessage();
        include('../../errors/database_error.php');
        exit();
    }
    header('Location: .');
} else { echo "Something's wrong!"; }

?>
./admins/group/new.php
<?php include '../../view/header.php'; ?>
<main>
    <section>

<table border='0' style='width:95%' align="center">
  <thead></thead>
  <tbody>
    <tr>
      <td>
        <h1 align="center">Control Center</h1>
      </td>
    </tr>
    <tr>
      <td>

        <form id="new_group" name="new_group" action="index.php" method="post">
          <input type="hidden" name="action" value="add_group">
          <fieldset>
            <legend>New Group</legend>

            <p>
              <label for="group"><span>Group:</span></label><br>
              <input type="text" id="new_group_name" name="new_group_name">
            </p>
            <p>
              <label for="description"><span>Description:</span></label><br>
              <input type="text" id="new_group_description" name="new_group_description">
            </p>
            <p>
              <label for="status"><span>Active</span></label>
              <input type="checkbox" id="new_group_status" name="new_group_status">
            </p>
            <p>
              <label for="users"><span>Users:</span></label>
              <select multiple name="new_group_users[]">
                  <option value=0>[select]</option>
                <?php foreach($users as $user) : ?>
                  <option value="<?php echo $user['id'] ?>"><?php echo $user['username'] ?></option>
                <?php endforeach; ?>
              </select>
            </p>
            <p>
              <label for="facilities"><span>Facilities:</span></label>
              <select multiple name="new_group_facilities[]">
                  <option value=0>[select]</option>
                <?php foreach($facilities as $facility) : ?>
                  <option value="<?php echo $facility['id'] ?>"><?php echo $facility['facilityname'] ?></option>
                <?php endforeach; ?>
              </select>
            </p>
            <p>
              <button type="submit">Create</button>
              <button type="reset">Reset</button>
	      <a href="index.php">Cancel</a>
            </p>
          </fieldset>
        </form>

      </td>
    </tr>
  </tbody>
</table>

    </section>
</main>
<?php include '../../view/footer.php'; ?>

./login.php
<?php include 'view/header.php'; ?>
<main>
  <section>
    <div style="display: <?php echo $_SESSION['username'] ? 'none' : 'block' ;?>">
      <table border='0' style='width: 95%' align="center">
        <thead></thead>
        <tbody>
          <tr>
            <td>
              <h1 align="center">User Login</h1>
            </td>
          </tr>
          <tr>
            <td>

              <form id="login" name="login" action="index.php" method="post">
                <input type="hidden" name="action" value="sign_in">
                <fieldset>
                  <legend>User Login</legend>

                  <pre><?php echo $login_message; ?></pre>
                  <p>
                    <label for="username"><span>username:</span></label>
                    <input type="text" id="login_username" name="login_username" requi red />
                  </p>
                  <p>
                    <label for="password"><span>password:</span></label>
                    <input type="password" id="login_password" name="login_password" r equired />
                  </p>
                  <button type="submit">Sign In</button>
                  </p>
                  <p><a href="?action=registration">Register</a> | <a href="?action=recovery">Forgot Password</a></p>
                </fieldset>
              </form>

            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 1) ? 'block' : 'none' ;?>">
      <table border='0' style='width: 95%' align="center">
        <thead></thead>
        <tbody>
          <tr>
            <td>
              <h1 align="center">Welcome...</h1>
            </td>
          </tr>
          <tr>
            <td>
              <p> Hi
                <?php echo $_SESSION['firstname'] ?>,<br> You have successfully logged into the Mr. Doser web application as an <i><b>operator</b></i>.
              </p>
              <p>You may use the drop down menu to your left to navigate to the facility you are authorized to operate.</p>
              <p>You can edit your personal profile by clicking your name (top right) or log out of the session by clicking the logout link next to your name.</p>
              <p>Clicking <u>Home</u> shall always bring you back to this page, if you are logged in or the login prompt.</p>
              <p>As an operator you only have access to the facility your supervisor/administrator registered you for. If you do not have access to any facility (blank drop down) or feel you were erroneously [not] assigned a facility contact your supervisor
                ASAP.</p>
              <p>A log is kept of all your actions whilst logged into this application.</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 2) ? 'block' : 'none' ;?>">
      <table border='0' style='width: 95%' align="center">
        <thead></thead>
        <tbody>
          <tr>
            <td>
              <h1 align="center">Welcome...</h1>
            </td>
          </tr>
          <tr>
            <td>
              <p> Hi
                <?php echo $_SESSION['firstname'] ?>,<br> You have successfully logged into the Mr. Doser web application as an <i><b>advanced operator</b></i>.
              </p>
              <p>You may use the drop down menu to your left to navigate to the facilities you are authorized to operate. You can ony operate one facility at a time.</p>
              <p>You can edit your personal profile by clicking your name (top right) or log out of the session by clicking the logout link next to your name.</p>
              <p>Clicking <u>Home</u> shall always bring you back to this page, if you are logged in or the login prompt.</p>
              <p>As an advanced operator you only have access to facilities your supervisor/administrator registers you for. If you feel you were erroneously [not] assigned a facility contact your supervisor ASAP.</p>
              <p>A log is kept of all your actions whilst logged into this application.</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 3) ? 'block' : 'none' ;?>">
      <table border='0' style='width: 95%' align="center">
        <thead></thead>
        <tbody>
          <tr>
            <td>
              <h1 align="center">Welcome...</h1>
            </td>
          </tr>
          <tr>
            <td>
              <p> Hi
                <?php echo $_SESSION['firstname'] ?>,<br> You have successfully logged into the Mr. Doser web application as an <i><b>administrator</b></i>.
              </p>
              <p>You may use the drop down menu to your left to navigate to the facility, device and group setup.</p>
              <p>You may <b>create</b>, <b>pair-up</b>, <b>modify</b> or <b>delete</b> a facility, device or group. You may also [re-]assign registered users to any group. Any changes you make to existing assignments shall take effect the next time the affected user logs in.</p>
            <p>You can edit your personal profile by clicking your name (top right) or log out of the session by clicking the logout link next to your name.</p>  
            <p>Clicking <u>Home</u> shall always bring you back to this page, if you are logged in or the login prompt.</p>
            <p>As an administrator you only have access to configuration menu of the facilities, devices and groups.</p>
            <p>A log is kept of all your actions whilst logged into this application.</p>
          </td>
        </tr>
      </tbody>
    </table>
</div>

<div style="display: <?php echo ($_SESSION['username'] && $_SESSION['usertypeid'] == 4) ? 'block' : 'none' ;?>">
    <table border='0' style='width: 95%' align="center">
      <thead></thead>
      <tbody>
        <tr>
          <td>
            <h1 align="center">Welcome...</h1>
          </td>
        </tr>
        <tr>
          <td>
          <p> Hi <?php echo $_SESSION['firstname'] ?>,<br>
              You have successfully logged into the Mr. Doser web application as an <i><b>super administrator</b></i>.
              </p>
              <p>You may use the drop down menus to your left to navigate to the operational facilities or to configure facilities, devices and groups.</p>
              <p>You may test any operational facility by navigating to the it through the operator menu.</p>
              <p>You may <b>create</b>, <b>pair-up</b>, <b>modify</b> or <b>delete</b> a facility, device or group (including un-attached entities, i.e stand-alone entities that are not paired up). You may also [re-]assign registered users to any group. Any changes you make to existing assignments shall take effect the next time the affected user logs in.</p>
            <p>You can edit your personal profile by clicking your name (top right) or log out of the session by clicking the logout link next to your name.</p>  
            <p>Clicking <u>Home</u> shall always bring you back to this page, if you are logged in or the login prompt.</p>
            <p>As a super administrator you have the most previleges in the system with configuration access to every choice the lesser user types have.</p>
            <p>A log is kept of all your actions whilst logged into this application.</p>
          </td>
        </tr>
      </tbody>
    </table>
</div>

  </section>
</main>
<?php include 'view/footer.php'; ?>
